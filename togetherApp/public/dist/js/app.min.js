/**
 * Created by Marthe on 10/12/15.
 */

(function(){
    var app = angular.module("app", ["ngRoute"]);
    app.config(function($routeProvider){
        $routeProvider
            .when("/",{
                templateUrl: "./views/home.html"
            })
            .when("/signup",{
                templateUrl: "views/signup.html"
            })
            .when("/home",{
                templateUrl: "./views/home.html"
            })
            .when("/matches",{
                templateUrl: "./views/matches.html"
            })
            .when("/howto",{
                templateUrl: "./views/howTo.html"
            })
            .when("/activities",{
                templateUrl: "./views/activities.html"
            })
            .when("/admin",{
                templateUrl: "./views/admin.html"
            })
            .when("/searchprofiles",{
                templateUrl: "./views/searchProfiles.html"
            })
            .when("/myprofile",{
                templateUrl: "./views/myProfile.html"
            })
            .when("/userdetails/:username",{
                templateUrl: "./views/detailsUser.html",
                controller: 'UsersController'
            })
            .when("/detailsuser",{
                templateUrl: "./views/detailsUser.html"
            })
            .when("/activitydetails/:activityName", {
                templateUrl: "./views/detailsActivity.html",
                controller: "ActivitiesController"

            })
            .when("/chat",{
                templateUrl: "./views/chat.html"
            });


    });

    app.run(function ($rootScope) {
        $rootScope.user = {};
    });

    app.directive('ngEnter', function () {
        return function (scope, element, attrs) {
            element.bind("keydown keypress", function (event) {
                if (event.which === 13) {
                    scope.$apply(function () {
                        scope.$eval(attrs.ngEnter);
                    });

                    event.preventDefault();
                }
            });
        };
    });


    app.directive('fileModel', ['$parse', function ($parse) {
        return {
            restrict: 'A',
            link: function(scope, element, attrs) {
                var model = $parse(attrs.fileModel);
                var modelSetter = model.assign;

                element.bind('change', function(){
                    scope.$apply(function(){
                        modelSetter(scope, element[0].files[0]);
                    });
                });
            }
        };
    }]);

    app.service('fileUpload', ['$http', function ($http) {
        this.uploadFileToUrl = function(file, uploadUrl){
            var fd = new FormData();
            fd.append('file', file);
            $http.post(uploadUrl, fd, {
                transformRequest: angular.identity,
                headers: {'Content-Type': undefined}
            })
                .success(function(){
                    console.log("success");
                })
                .error(function(){
                    console.log("error");
                });
        };
    }]);


    app.directive('editableCheckbox', function () {
        return {
            restrict: 'E',
            templateUrl: './views/editablecheckbox.html'
        };
    });


})();
/**
 * Created by iman on 15/12/15.
 */
var Activity = function(name, zipcode, street, number, description, dateFrom, dateUntil, timestamp, username, matches){
    this.activityName = name;
    this.zipcode = zipcode;
    this.street = street;
    this.number = number;
    this.description = description;
    this.dateFrom = dateFrom;
    this.dateUntil = dateUntil;
    this.timestamp = timestamp;
    this.username = username;
    this.matches = matches;
};
/**
 * Created by iman on 5/12/15.
 */
/*(function(){

    "use strict";

    var activitiesService = function () {

        var getActivities = function () {

            var localUrl = "http://localhost:3000/data/activities.json";
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open("GET", localUrl, false);
            xmlHttp.send(null);

            if(xmlHttp.status == 200) {

                var data = JSON.parse(xmlHttp.responseText);

                //console.log(data);

                var arrActivities = [];

                for (var i = 0; i < data.length; i++) {

                    var d = data[i];

                    var newActivity = new Activity();
                    newActivity.img = d.img;
                    newActivity.name = d.name;
                    newActivity.place = d.place;
                    newActivity.participants = d.participants;
                    newActivity.myEvent = d.myEvent;

                    var text = "";

                    for(var ii=0; ii< d.keywords.length; ii++){
                        if(ii == d.keywords.length-1){
                            text += d.keywords[ii];
                        }
                        else{
                            text += d.keywords[ii];
                            text += ", ";
                        }
                    }

                    newActivity.keywords = text;
                    arrActivities.push(newActivity);
                }

                return arrActivities;

            }

        };

        //public gedeelte
        return{

            getActivities:getActivities

        };

    };

    angular.module("app").factory("activitiesService", [activitiesService]);
    //                                  ^ deze naam bepaalt welke naam je nodig hebt in je controller als verwijzing!

})();*/
/**
 * Created by Nikita on 7/01/2016.
 */


(function () {

    "use strict";

    var chatService = function ($rootScope) {
        var socket = io.connect(window.location.host);

        var on = function (eventName, callback) {
            socket.on(eventName, function () {
                var args = arguments;
                $rootScope.$apply(function () {
                    callback.apply(socket, args);
                });
            });
        };

        var emit = function (eventName, data, callback) {
            socket.emit(eventName, data, function () {
                var args = arguments;
                $rootScope.$apply(function () {
                    callback.apply(socket, args);
                });
            });
        };


        return {
            on: on,
            emit: emit,
            socket: socket
        };
    };

    angular.module("app").factory("chatService", ["$rootScope", chatService]);

})();
/**
 * Created by iman on 15/12/15.
 */


(function(){

    "use strict";

    var dbService = function ($http) {

        var getCollection = function (collection) {


            var url = "http://localhost:3000/api/" + collection;
            return $http.get(url).then(function(response){
                return response.data;

            });

        };

        var getByID = function (collection, id) {
            var url = "http://localhost:3000/api/" + collection + "/" + id;
            return $http.get(url).then(function(response){
                return response.data;

            });

        };

        var getDetailsUser = function (collection, username) {
            var url = "http://localhost:3000/api/" + collection + "/userdetail/" + username;
            return $http.get(url).then(function(response){
                return response.data;

            });

        };

        var deleteUser =  function (collection, username) {
            var url = "http://localhost:3000/api/" + collection + "/userdelete/" + username;
            return $http.get(url).then(function (response) {
                return response.data;

            });
        };

        var updateUser = function (collection) {
            var url = "http://localhost:3000/api/" + collection + "/updateprofile";
            return $http.get(url).then(function (response) {
                return response.data;

            });
        };

        var getItem = function(item){

            var url = "http://localhost:3000/api/" + item;
            return $http.get('/user').then(function(response){

                return response.data;

            });

        };

        var getDetailsActivity = function (collection, activityname) {
            var url = "http://localhost:3000/api/" + collection + "/activitydetail/" + activityname;
            return $http.get(url).then(function(response){
                return response.data;


            });

        };

        var deleteActivity =  function (collection, activityId) {
            var url = "http://localhost:3000/api/" + collection + "/activitydelete/" + activityId;
            console.log(url);
            return $http.get(url).then(function (response) {
                console.log(response);
                return response.data;

            });
        };


        var getNoiseWords = function () {

            var url = "http://localhost:3000/data/noisewords.json";
            return $http.get(url).then(function(response){

                return response.data;

            });

        };


        //public gedeelte
        return{

            getCollection:getCollection,
            getByID:getByID,
            getItem:getItem,
            getDetailsUser: getDetailsUser,
            deleteUser: deleteUser,
            updateUser: updateUser,
            getDetailsActivity: getDetailsActivity,
            getNoiseWords: getNoiseWords,
            deleteActivity: deleteActivity

        };

    };

    angular.module("app").factory("dbService", ["$http", dbService]);
    //                                  ^ deze naam bepaalt welke naam je nodig hebt in je controller als verwijzing!

})();
/**
 * Created by iman on 5/12/15.
 */
(function(){

    "use strict";

    var matchesService = function () {

        var getMatches = function (nameUser) {

            var variabelURL = "together";
            var localUrl = "http://localhost:3000/data/matches.json";
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open("GET", localUrl, false);
            xmlHttp.send(null);

            if(xmlHttp.status == 200) {

                var data = JSON.parse(xmlHttp.responseText);
                var arr = [];
                var arrMatches = [];
                var arrMatchUsers = [];
                var arrMatchInterests = [];

                for(var i=0; i < data.length; i++){

                    var obj = {
                        "user": data[i].user,
                        "matches":data[i].matches
                    };

                    arr.push(obj);

                }

                for(var ii = 0; ii<arr.length; ii++){

                    var index = arr[ii].user.indexOf(nameUser);
                    if(index === 0){
                        arrMatches.push(arr[ii].matches);
                    }
                    //console.log("Index: "+index);
                }

                //console.log(arr);
                //console.log(arrMatches[0]);


                var arrMatchesByUser = arrMatches[0];
                //console.log("Aantal matches: " + arrMatchesByUser.length);

                return arrMatchesByUser;

                /*
                for(var iii = 0; iii<arrMatches[0].length; iii++){

                    var matchUser = arrMatches[0][iii].user;
                    var matchInterests = arrMatches[0][iii].interests;

                    arrMatchUsers.push(matchUser);
                    arrMatchInterests.push(matchInterests);

                    //console.log(matchUser);
                    //console.log(matchInterests);
                }

                console.log(arrMatchUsers);
                console.log(arrMatchInterests);
                */

            }



        };

        //public gedeelte
        return{

            getMatches:getMatches,

        };

    };

    angular.module("app").factory("matchesService", [matchesService]);
    //                                  ^ deze naam bepaalt welke naam je nodig hebt in je controller als verwijzing!

})();
/**
 * Created by iman on 5/12/15.
 */

(function () {

    "use strict";
    var dateTimeNow = new Date().toISOString().substring(0, 10) + " " + new Date().toISOString().substring(11, 16);

    var ActivitiesController = function ($scope, dbService, $http, $location, $routeParams, $route) {
        $scope.interestedAct = true;
        $scope.nameButton = "Interested";

        $scope.getActivities = function () {
            dbService.getCollection('activities').then(function (response) {

                var arrTemp = response.activitielist;
                var arrActs = [];


                for (var i = 0, l = arrTemp.length; i < l; i++) {
                    if (new Date(arrTemp[i].untilDate).getTime() >= new Date(dateTimeNow).getTime()) {
                        if(arrTemp[i].deleted === false){
                            $scope.deleted = false;
                            arrActs.push(arrTemp[i]);

                        }

                        else{
                            $scope.deleted = true;
                        }
                    }
                }

                $scope.arrActivities = arrActs;

            });


        };

        String.prototype.replaceAll = function (token, newToken, ignoreCase) {
            var _token;
            var str = this + "";
            var i = -1;

            if (typeof token === "string") {

                if (ignoreCase) {

                    _token = token.toLowerCase();

                    while ((
                        i = str.toLowerCase().indexOf(
                            token, i >= 0 ? i + newToken.length : 0
                        ) ) !== -1
                        ) {
                        str = str.substring(0, i) +
                            newToken +
                            str.substring(i + token.length);
                    }

                } else {
                    return this.split(token).join(newToken);
                }

            }
            return str;
        };

        function isInArray(value, array) {
            return array.indexOf(value);
        }

        function getKeywordsFromDescription(description, callback) {

            description = description.replaceAll('.', '');
            description = description.replaceAll(',', '');
            description = description.replaceAll('?', '');
            description = description.replaceAll('!', '');
            description = description.replaceAll('"', '');
            description = description.replaceAll("'", '');

            var words = description.split(" ");
            var keyWords = "";

            dbService.getNoiseWords().then(function (response) {

                var noiseWords = response.noisewords;

                for (var i = 0; i < words.length; i++) {

                    if (isInArray(words[i].toLowerCase(), noiseWords) == -1) {
                        keyWords += words[i];
                        keyWords += " ";
                    }
                }

                //return keyWords;
                if (!keyWords.isEmpty) {
                    callback(null, keyWords);
                }

                else {
                    callback("No keywords found.", null);
                }

            });
        }

        function stringConsistOf2Numbers(number, callback) {
            var output = number + '';
            if (output.length < 2) {
                output = '0' + output;
                number = output.toString();

            }
            else {
                number = number.toString();
            }


            if (!number.isEmpty) {
                callback(null, number);
            }

            else {
                callback("No number.", null);
            }


        }

        function fullDate(number, number2, callback) {
            stringConsistOf2Numbers(number, function (error, numberToString) {
                number = numberToString;
                if (error) {
                    console.log(error);

                }
            });
            stringConsistOf2Numbers(number2, function (error, numberToString) {
                number2 = numberToString;
                if (error) {
                    console.log(error);

                }
            });

            if (!number.isEmpty && !number2.isEmpty) {
                callback(null, number, number2);
            }

            else {
                callback("No number.", null);
            }


        }


        $scope.addActivity = function () {
            var activityName = this.activityName;
            var street = this.street;
            var number = this.number;
            var zipcode = this.zipcode;
            var description = this.comment;
            var dateFrom = this.dateFrom;
            var dateUntil = this.dateUntil;
            var timestamp = new Date().getTime();
            var startTimeHour = this.startTimeHour;
            var startTimeMin = this.startTimeMin;
            var endTimeHour = this.endTimeHour;
            var endTimeMin = this.endTimeMin;
            var dateFromDay = this.dateFromDay;
            var dateFromMonth = this.dateFromMonth;
            var dateFromYear = this.dateFromYear.toString();
            var dateUntilDay = this.dateUntilDay;
            var dateUntilMonth = this.dateUntilMonth;
            var dateUntilYear = this.dateUntilYear.toString();

            fullDate(dateFromDay, dateFromMonth, function (error, dateFromdayString, dateFromMonthString) {
                dateFromDay = dateFromdayString;
                dateFromMonth = dateFromMonthString;
                if (error) {
                    console.log(error);
                }
            });
            fullDate(dateUntilDay, dateUntilMonth, function (error, dateUntilDayString, dateUntilMonthString) {
                dateUntilDay = dateUntilDayString;
                dateUntilMonth = dateUntilMonthString;
                if (error) {
                    console.log(error);
                }
            });


            if ((street !== undefined) &&
                (number !== undefined) &&
                (zipcode !== undefined) &&
                (description !== undefined) &&
                (timestamp !== undefined)) {

                $scope.error = "";

                if (startTimeMin < 60 && startTimeHour < 25) {

                    stringConsistOf2Numbers(startTimeHour, function (error, startTimeHourString) {
                        startTimeHour = startTimeHourString;
                        if (error) {
                            console.log(error);
                        }
                    });
                    stringConsistOf2Numbers(startTimeMin, function (error, startTimeMinString) {
                        startTimeMin = startTimeMinString;
                        if (error) {
                            console.log(error);

                        }
                    });

                    console.log(startTimeHour);
                    console.log(startTimeMin);

                    if (startTimeMin.length === 2 && startTimeHour.length === 2) {
                        console.log("je komt hier terecht");

                        if (endTimeMin < 60 && endTimeHour < 24) {
                            stringConsistOf2Numbers(endTimeHour, function (error, endTimeHourString) {
                                endTimeHour = endTimeHourString;
                                if (error) {
                                    console.log(error);
                                }
                            });
                            stringConsistOf2Numbers(endTimeMin, function (error, endTimeMinString) {
                                endTimeMin = endTimeMinString;
                                if (error) {
                                    console.log(error);

                                }
                            });

                            console.log(endTimeHour);
                            console.log(endTimeMin);

                            if (endTimeMin.toString().length === 2 && endTimeHour.toString().length === 2) {

                                console.log(startTimeHour + ":" + startTimeMin);

                                getKeywordsFromDescription(description, function (error, data) {
                                    description = data;
                                    if (!error) {
                                        console.log(startTimeHour + ":" + startTimeMin);

                                        var url = "/api/activities/addactivity";
                                        $http.post(url, {
                                            activityName: activityName,
                                            street: street,
                                            number: number,
                                            zipcode: zipcode,
                                            description: description,
                                            dateFrom: dateFromYear + "-" + dateFromMonth + "-" + dateFromDay + " " + startTimeHour + ":" + startTimeMin,
                                            dateUntil: dateUntilYear + "-" + dateFromMonth + "-" + dateUntilDay + " " + endTimeHour + ":" + endTimeMin,
                                            timestamp: timestamp

                                        }).success(function (data) {
                                            $scope.error = data.error;
                                            $scope.getActivities();
                                            resetForm();

                                            //$location.path(data.redirect);
                                        });

                                    }
                                    else {
                                        console.log(error);
                                    }
                                });
                            }

                            else {
                                $scope.error = "Enddate input is not correct";
                            }
                        }

                        else {
                            $scope.error = "Endtime input is not correct";
                        }

                    }

                    else {
                        $scope.error = 'De startime length is not correct!!!! ';
                    }
                }
                else {
                    $scope.error = "Starttime input is not correct";
                }


            }
            else {
                $scope.error = "ERROR: All fields are required.8888";
            }
        };

        $scope.getDetailActivity = function (currentUser) {
            dbService.getDetailsActivity('activities', $routeParams.activityName).then(function (response) {
                $scope.arrDetailsActivity = response.activity;
                initmap();

                console.log($scope.arrDetailsActivity.matches);
                for (var i = 0; i < $scope.arrDetailsActivity.matches.length; i++) {
                    if ($scope.arrDetailsActivity.matches[i] === currentUser) {
                        $scope.nameButton = "Not interested";
                        $scope.interestedAct = false;
                    }
                }
                return $scope.arrDetailsActivity;


            });
        };

        $scope.interested = function (activityName, interestedUser, createrUser) {
            var url = "";
            var interestedAct = $scope.interestedAct;
            if (interestedAct !== false) {

                url = "/api/activities/interested";
                $http.post(url, {
                    activityName: activityName,
                    interestedUser: interestedUser,
                    createrUser: createrUser
                }).success(function (data) {
                    console.log(data);
                    console.log(interestedUser + " is geïnteresseerd in " + activityName + " door " + createrUser);
                    $scope.interestedAct = false;
                    $scope.nameButton = "Not interested";
                    $scope.error = data.error;
                });
            } else {
                console.log(interestedAct);
                url = "/api/activities/deleteinterested";
                $http.post(url, {
                    activityName: activityName,
                    interestedUser: interestedUser,
                    createrUser: createrUser
                }).success(function (data) {
                    console.log(data);
                    console.log(interestedUser + " is niet meer geïnteresseerd in " + activityName + " door " + createrUser);
                    $scope.interestedAct = true;
                    $scope.nameButton = "Interested";

                    $scope.error = data.error;
                });
            }
        };

        function recentFirst(a, b) {
            if (a.timestamp > b.timestamp)
                return -1;
            if (a.timestamp < b.timestamp)
                return 1;
            return 0;
        }

        function popularFirst(arr) {
            var max = arr[0];
            var maxIndex = 0;

            for (var i = 1; i < arr.length; i++) {
                if (arr[i].matches.length > max.matches.length) {
                    maxIndex = i;
                    max = arr[i];
                }
            }

            return maxIndex;
        }

        $scope.showActivitiesOnHomePage = function(){
            $scope.getMostRecentActivities();
            $scope.getMostPopularActivities();
        };

        $scope.getMostRecentActivities = function () {

            dbService.getCollection('activities').then(function (response) {
                var numberOfActivities = 3;
                var arrTemp = response.activitielist;
                var arrAllActivities = [];


                for (var i = 0, l = arrTemp.length; i < l; i++) {
                    if (new Date(arrTemp[i].untilDate).getTime() >= new Date(dateTimeNow).getTime()) {
                        console.log(new Date(arrTemp[i].untilDate));
                        arrAllActivities.push(arrTemp[i]);
                    }
                }

                arrAllActivities.sort(recentFirst);

                var arrMostRecentActivities = [];

                for (var ii = 0; ii < numberOfActivities; ii++) {
                    arrMostRecentActivities.push(arrAllActivities[ii]);
                }

                var matches = [];

                for (var iii = 0; iii < arrMostRecentActivities.length; iii++) {

                    var dummyActivity = new Activity("No name", 8500, "Together", 2, "no description", "2016-01-01 00:01", "2017-12-31 23:59", new Date(), "no username", matches);
                    if (arrMostRecentActivities[iii] === undefined) {
                        arrMostRecentActivities.splice(iii, 1, dummyActivity);
                    }
                }
                $scope.arrMostRecentActivities = arrMostRecentActivities;

            });
        };

        $scope.getMostPopularActivities = function(){

            dbService.getCollection('activities').then(function(response){

                var numberOfActivities = 3;
                var arrTemp = response.activitielist;
                var arrAllActivities = [];

                for (var i = 0, l = arrTemp.length; i < l; i++) {
                    if(new Date(arrTemp[i].untilDate).getTime() >= new Date(dateTimeNow).getTime()) {
                        //console.log(new Date(arrTemp[i].untilDate));
                        arrAllActivities.push(arrTemp[i]);
                    }
                }

                var arrMostPopularActivities = [];

                for(var j = 0; j < numberOfActivities; j++){

                    var indexMostPop = popularFirst(arrAllActivities);
                    arrMostPopularActivities.push(arrAllActivities[indexMostPop]);
                    arrAllActivities.splice(indexMostPop, 1);
                }

                var matches = [];

                for (var iii = 0; iii < arrMostPopularActivities.length; iii++) {

                    var dummyActivity = new Activity("No name", 8500, "Together", 2, "no description", "2016-01-01 00:01", "2017-12-31 23:59", new Date(), "no username", matches);
                    if (arrMostPopularActivities[iii] === undefined) {
                        arrMostPopularActivities.splice(iii, 1, dummyActivity);
                    }
                }

                $scope.arrMostPopularActivities = arrMostPopularActivities;

            });
        };
        $scope.deleteActivity = function(activityId){
            dbService.deleteActivity('activities', activityId).then(function(response){
                $scope.infodeletedActivity = response;
                console.log(response);
                $scope.getActivities();
            });
        };


        function initmap(){
            var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 8,
                center: {lat: 50.8194894, lng: 3.2577076}
            });
            var geocoder = new google.maps.Geocoder();

            geocodeAddress(geocoder, map);

        }


        function geocodeAddress(geocoder, resultsMap) {
            var street = $scope.arrDetailsActivity.street;
            var number = $scope.arrDetailsActivity.number;
            var zipcode = $scope.arrDetailsActivity.zipcode;

            var address = street + " " + number + ", " + zipcode; //hier address uit db instoppen

            geocoder.geocode({'address': address}, function (results, status) {
                if (status === google.maps.GeocoderStatus.OK) {
                    resultsMap.setCenter(results[0].geometry.location);
                    var image = "../../images/marker.png";
                    var marker = new google.maps.Marker({
                        map: resultsMap,
                        position: results[0].geometry.location,
                        icon: image
                    });

                    console.log(marker);

                } else {
                    alert('Geocode was not successful for the following reason: ' + status);
                }
            });
        }

        function resetForm() {
            var frm = document.getElementsByName('ActivityForm')[0];
            console.log('je komt in de resetform');
            frm.reset();
        }
    };

    angular.module("app").controller("ActivitiesController", ["$scope", "dbService", "$http", "$location", "$routeParams", "fileUpload", ActivitiesController]);


})();
/**
 * Created by Nikita on 7/01/2016.
 */
(function () {

    "use strict";

    var ChatController = function($scope, $rootScope, $routeParams, dbService, $http) {

        console.log($rootScope.currentUser.username);
        console.log($rootScope.contactedUser.username);
        //$scope.contactedUser.username = $rootScope.contactedUser.username;

        $scope.init = function () {
            chatService.emit("init_users",{user:$rootScope.currentUser, collection:"users"});
        };

    };
    angular.module("app").controller("ChatController", ["$scope", "$rootScope", "$routeParams", "dbService","$http", ChatController]);

})();
/**
 * Created by iman on 5/12/15.
 */

(function(){

    "use strict";

    var MatchesController = function($scope, dbService) {

        var clicksOnBtn = 0;

        $scope.showDiv = function(){
            $scope.filter = {showFilter:true};
            clicksOnBtn++;

            if(clicksOnBtn > 1){
                $scope.filter = {showFilter:false};
                clicksOnBtn = 0;
            }
        };

        $scope.hideDiv = function(){
            clicksOnBtn = 0;
            $scope.filter = {showFilter:false};
        };

        $scope.sortProperty = "title";
        $scope.filterQuery = "";
        $scope.filterMatches = function(i){
            if($scope.filterQuery === ""){
                return true;
            }

            /*
             else if(i.username.toLowerCase().indexOf($scope.filterQuery.toLocaleLowerCase()) >= 0){
             return true;
             }
             */

            else if(i.sex === undefined){
                return false;
            }

            else if($scope.filterQuery.toLowerCase() == i.sex.toLowerCase()){
                return true;
            }

            else if($scope.filterQuery.toLowerCase() === "nofilter"){
                $scope.filterQuery = "";
            }

            return false;
        };

        //http://www.falsepositives.com/index.php/2009/12/01/javascript-function-to-get-the-intersect-of-2-arrays/
        $scope.intersect = function(arr1, arr2)
        {
            var r = [], o = {}, l = arr2.length, i, v;
            for (i = 0; i < l; i++) {
                o[arr2[i]] = true;
            }
            l = arr1.length;
            for (i = 0; i < l; i++) {
                v = arr1[i];
                if (v in o) {
                    r.push(v);
                }
            }

            return r;
        };

        $scope.showMatches = function(){

            /*
             var username = "";
             if($rootScope.user.username !== undefined){
             username = $rootScope.user.username;
             }
             */

            var username;

            username = localStorage.getItem("username");

            dbService.getCollection('users').then(function(response){

                var arrProfiles = response.userlist;
                for(var i = 0; i < arrProfiles.length; i++){
                    if(arrProfiles[i].username === username) {
                        arrProfiles.splice(i, 1);
                    }
                }
                for(var ii = 0; ii < arrProfiles.length; ii++){
                    if(arrProfiles[ii].username === "admin") {
                        arrProfiles.splice(ii, 1);
                    }
                }


                dbService.getItem(username).then(function(response){

                    var user = response;
                    var arrMatches = [];

                    console.log(user.interests);

                    for(var i=0, l=arrProfiles.length; i<l; i++){

                        var sameInterests = [];
                        sameInterests = $scope.intersect(user.interests, arrProfiles[i].interests);

                        if(sameInterests.length !== 0){
                            if(arrProfiles[i].deleted === false){
                                arrMatches.push(arrProfiles[i]);
                            }

                        }

                    }

                    $scope.arrMatches = arrMatches;

                });
            });
        };

    };

    angular.module("app").controller("MatchesController", ["$scope", "dbService", MatchesController]);

})();
/**
 * Created by iman on 20/12/15.
 */


(function(){

    "use strict";

    var ProfilesController = function($scope, $rootScope, $routeParams, dbService, $http, $location) {

        var clicksOnBtn = 0;
        $scope.startChat = function(currentUser, contactedUser){
            $http.post("/chat", {
                currentUser: currentUser,
                contactedUser:contactedUser

            }).success(function (data) {
                $scope.error = data.error;
                $rootScope.currentUser = data.currentUser;
                $rootScope.contactedUser = data.contactedUser;

                localStorage.setItem("currentusername", $rootScope.currentUser.username);
                localStorage.setItem("contactedusername", $rootScope.contactedUser.username);

                $location.path(data.redirect);
            });
        };



        $scope.showDiv = function(){
            $scope.filter = {showFilter:true};
            clicksOnBtn++;

            if(clicksOnBtn > 1){
                $scope.filter = {showFilter:false};
                clicksOnBtn = 0;
            }
        };

        $scope.hideDiv = function(){
            clicksOnBtn = 0;
            $scope.filter = {showFilter:false};
        };

        $scope.showProfiles = function(){

            /*
            var username = "";
            if($rootScope.user.username !== undefined){
                username = $rootScope.user.username;
            }
            */
            var username = "";
            username = localStorage.getItem("username");

            dbService.getCollection('users').then(function(response){

                var arrProfiles = response.userlist;
                for(var i = 0; i < arrProfiles.length; i++){
                    if(arrProfiles[i].username === username) {
                        arrProfiles.splice(i, 1);
                    }
                }
                for(var ii = 0; ii < arrProfiles.length; ii++){
                    if(arrProfiles[ii].username === "admin") {
                        arrProfiles.splice(ii, 1);
                    }
                }
                $scope.arrProfiles = arrProfiles;

            });

        };

        $scope.sortProperty = "title";
        $scope.filterQuery = "";
        $scope.filterProfiles = function(i){
            if($scope.filterQuery === ""){
                return true;
            }

            /*
             else if(i.username.toLowerCase().indexOf($scope.filterQuery.toLocaleLowerCase()) >= 0){
             return true;
             }
             */

            else if(i.sex === undefined){
                return false;
            }

            else if($scope.filterQuery.toLowerCase() == i.sex.toLowerCase()){
                return true;
            }

            else if($scope.filterQuery.toLowerCase() === "nofilter"){
                $scope.filterQuery = "";
            }

            return false;
        };
    };

    angular.module("app").controller("ProfilesController", ["$scope", "$rootScope", "$routeParams", "dbService","$http", "$location", ProfilesController]);

})();
/**
 * Created by iman on 20/12/15.
 */
(function(){

    "use strict";

    var UsersController = function($scope, $routeParams, $http, dbService) {

        $scope.getUsers = function(){

            dbService.getCollection('users').then(function(response){

                //console.log(response);
                $scope.arrUsers = response.userlist;

                for( var i = 0; i<$scope.arrUsers.length; i++){

                    if($scope.arrUsers[i].deleted === false){
                        $scope.deleted = false;
                    }

                    else{
                        $scope.deleted = true;
                    }



                }


            });

        };

        $scope.getDetailUser = function(){

            dbService.getDetailsUser('users', $routeParams.username).then(function(response){
                $scope.userDetails = response.correctuser;
            });
        };

        $scope.deleteUser = function(username){
            dbService.deleteUser('users', username).then(function(response){
                $scope.infodeletedUser = response;
                $scope.getUsers();
            });
        };

        $scope.updateUser = function(){
            /*dbService.updateUser('users').then(function(response){
                $scope.updateuser = response;
                console.log(response);
                console.log("gelukt");

            })*/

            var  username =  $scope.user.username,
                password = $scope.user.password,
                birthdate = $scope.user.birthdate,
                zipcode = $scope.user.zipcode,
                sex = $scope.user.sex,
                biography = $scope.user.biography;

            var url = "http://localhost:3000/api/users/updateprofile";
            console.log(url);
            $http.post(url, {
                username : username,
                password : password,
                birthdate : birthdate,
                zipcode : zipcode,
                sex : sex,
                biography :biography

            }).success(function (data) {
                $scope.error = data.error;

            });

            console.log($scope.user.username, $scope.user.password, $scope.user.birthdate, $scope.user.zipcode, $scope.user.sex, $scope.user.biography);




        };

        $scope.getUserByID = function(){

            dbService.getItem('user').then(function(response){
                console.log(response);
                $scope.userProfile = response;

            });


        };


    };

    angular.module("app").controller("UsersController", ["$scope","$routeParams", "$http", "dbService", UsersController]);

})();
/**
 * Created by Marthe on 15/12/15.
 */
(function(){
    "use strict";
    var selectedInterest = [];

    var loginController = function ($scope, $rootScope, $http, $location) {

        $scope.login = function() {
            $http
                .post('/login', {
                    username: this.username,
                    password: this.password
                })
                .success(function(data) {
                    console.log(data);
                    $rootScope.user = data.user;
                    localStorage.setItem("username", $rootScope.user.username);
                    $scope.error = data.error;
                    $location.path(data.redirect);
                });
        };

        $scope.interests = ['Jazz', 'Hiphop', 'New wave', 'Traveling','Party'];
        $scope.lst = [];
        $scope.change = function(){
            $scope.lst.push('2');
            console.log($scope.lst);
        };
        $scope.stateChanged = function (qId) {
            //if(!$scope.interests[qId]){ //If it is checked
            if(selectedInterest.indexOf(qId) !== -1) {
                //console.log('artNr already exists! DELETE');
                var index = selectedInterest.indexOf(qId);
                if (index > -1) {
                    selectedInterest.splice(index, 1);
                }
            }else{
                selectedInterest.push(qId);
                console.log(selectedInterest);
            }
        };
        $scope.geolocation = "";
        $scope.getLocation = function(){
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(successCallback, errorCallback, {maximumAge:600000});
            }
            else {
                $scope.error = "Geolocation is not supported by this browser.";
            }
            function successCallback(position) {
                // By using the 'maximumAge' option above, the position
                // object is guaranteed to be at most 10 minutes old.
                $scope.geolocation =  {
                    latitude: position.coords.latitude,
                    longitude: position.coords.latitude
                };
                console.log($scope.geolocation);
            }

            function errorCallback(error) {
                // Update a div element with error.message.
                $scope.geolocation = null;
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        $scope.error = "User denied the request for Geolocation.";
                        break;
                    case error.POSITION_UNAVAILABLE:
                        $scope.error = "Location information is unavailable.";
                        break;
                    case error.TIMEOUT:
                        $scope.error = "The request to get user location timed out.";
                        break;
                    case error.UNKNOWN_ERROR:
                        $scope.error = "An unknown error occurred.";
                        break;
                }

            }
        };

        $scope.register = function() {
            console.log("REGISTER");




            $http.post('/register', {
                firstname: this.firstname,
                lastname : this.lastname,
                //email : this.email,*/
                username : this.username,
                password : this.password,
                zipcode: this.zipcode,
                birthdate : this.birthdate,
                sex : this.sex,
                biography : this.biography,
                geolocation:$scope.geolocation,
                interests:selectedInterest

            }).success(function (data) {
                $scope.error = data.error;
                $location.path(data.redirect);
            });

        };
    };

    var signupController = function ($scope) {
        $scope.categories = [''];
        $scope.newCategory = "";
        $scope.saveCategory = function () {

        };

    };

    var editableCheckboxController = function ($scope) {
        $scope.category = "";
        $scope.showLabel = false;
        $scope.showTextbox = true;
        $scope.saveCategory = function () {
            if ($scope.category) {
                $scope.showLabel = true;
                $scope.showTextbox = false;
            }
            else {
                $scope.showLabel = false;
                $scope.showTextbox = true;
            }
        };
        $scope.edit = function () {
            $scope.showLabel = false;
            $scope.showTextbox = true;
        };
        $scope.isChecked = function(qId){
            console.log(qId);
            if(qId!==  " ") {
                if (selectedInterest.indexOf(qId) !== -1) {
                    var index = selectedInterest.indexOf(qId);
                    if (index > -1) {
                        selectedInterest.splice(index, 1);
                        console.log(selectedInterest);
                    }
                } else {
                    selectedInterest.push(qId);
                    console.log(selectedInterest);
                }
            }
        };
        $scope.stateChanged = function (qId) {

        };

    };

    angular.module("app")
        .controller("loginController", ["$scope", "$rootScope", "$http", "$location", loginController])
        .controller("signupController", ["$scope", signupController])
        .controller("editableCheckboxController", ["$scope", editableCheckboxController]);
})();
/**
 * Created by Nikita on 21/12/2015.
 */
(function () {
    "use strict";

    /*var signupController = function ($scope) {
        $scope.categories = [''];
        $scope.newCategory = "";
        $scope.saveCategory = function () {

        };

    };

    var editableCheckboxController = function ($scope) {
        $scope.category = "";
        $scope.showLabel = false;
        $scope.showTextbox = true;
        $scope.saveCategory = function () {
            if ($scope.category) {
                $scope.showLabel = true;
                $scope.showTextbox = false;
            }
            else {
                $scope.showLabel = false;
                $scope.showTextbox = true;
            }
        };
        $scope.edit = function () {
            $scope.showLabel = false;
            $scope.showTextbox = true;
        };

    };
    angular.module("app")
        .controller("signupController", ["$scope", signupController])
        .controller("editableCheckboxController", ["$scope", editableCheckboxController]);*/


})();
/**
 * Created by Marthe on 16/12/15.
 */
(function () {
    "use strict";

    var userController = function ($scope, $rootScope, $http, $location) {
        $http.get('/user').success(function(data) {
            $scope.user = data;
            $rootScope.user = data;

            if(data.username == 'admin'){
                $scope.auth = {isAuth: true, isAdmin : true};
            }
            else if(data.username != 'admin' && data.username !== undefined){
                $scope.auth = {isAuth: true, isAdmin : false};
            }
            else if(data.username === undefined){
                $scope.auth = {isAuth: false, isAdmin : false};

            }


        });


        /*$scope.logout = function() {
            $http.get('/logout').success(function (data) {
                $location.path(data.redirect);
            });
        };*/
    };


    angular.module("app").controller("userController", ["$scope", "$rootScope", "$http", "$location", userController]);
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsIkFjdGl2aXR5LmpzIiwiYWN0aXZpdGllc1NlcnZpY2UuanMiLCJjaGF0U2VydmljZS5qcyIsImRiU2VydmljZS5qcyIsIm1hdGNoZXNTZXJ2aWNlLmpzIiwiQWN0aXZpdGllc0NvbnRyb2xsZXIuanMiLCJDaGF0Q29udHJvbGxlci5qcyIsIk1hdGNoZXNDb250cm9sbGVyLmpzIiwiUHJvZmlsZXNDb250cm9sbGVyLmpzIiwiVXNlcnNDb250cm9sbGVyLmpzIiwibG9naW5Db250cm9sbGVyLmpzIiwic2lnbnVwQ29udHJvbGxlci5qcyIsInVzZXJDb250cm9sbGVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNuSEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDZEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNyRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3hDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3hIQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN6RkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3JnQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDcEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDcElBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzNHQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3RHQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNqS0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3hDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoiYXBwLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBDcmVhdGVkIGJ5IE1hcnRoZSBvbiAxMC8xMi8xNS5cclxuICovXHJcblxyXG4oZnVuY3Rpb24oKXtcclxuICAgIHZhciBhcHAgPSBhbmd1bGFyLm1vZHVsZShcImFwcFwiLCBbXCJuZ1JvdXRlXCJdKTtcclxuICAgIGFwcC5jb25maWcoZnVuY3Rpb24oJHJvdXRlUHJvdmlkZXIpe1xyXG4gICAgICAgICRyb3V0ZVByb3ZpZGVyXHJcbiAgICAgICAgICAgIC53aGVuKFwiL1wiLHtcclxuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vdmlld3MvaG9tZS5odG1sXCJcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLndoZW4oXCIvc2lnbnVwXCIse1xyXG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwidmlld3Mvc2lnbnVwLmh0bWxcIlxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAud2hlbihcIi9ob21lXCIse1xyXG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwiLi92aWV3cy9ob21lLmh0bWxcIlxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAud2hlbihcIi9tYXRjaGVzXCIse1xyXG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwiLi92aWV3cy9tYXRjaGVzLmh0bWxcIlxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAud2hlbihcIi9ob3d0b1wiLHtcclxuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vdmlld3MvaG93VG8uaHRtbFwiXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC53aGVuKFwiL2FjdGl2aXRpZXNcIix7XHJcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL3ZpZXdzL2FjdGl2aXRpZXMuaHRtbFwiXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC53aGVuKFwiL2FkbWluXCIse1xyXG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwiLi92aWV3cy9hZG1pbi5odG1sXCJcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLndoZW4oXCIvc2VhcmNocHJvZmlsZXNcIix7XHJcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL3ZpZXdzL3NlYXJjaFByb2ZpbGVzLmh0bWxcIlxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAud2hlbihcIi9teXByb2ZpbGVcIix7XHJcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL3ZpZXdzL215UHJvZmlsZS5odG1sXCJcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLndoZW4oXCIvdXNlcmRldGFpbHMvOnVzZXJuYW1lXCIse1xyXG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwiLi92aWV3cy9kZXRhaWxzVXNlci5odG1sXCIsXHJcbiAgICAgICAgICAgICAgICBjb250cm9sbGVyOiAnVXNlcnNDb250cm9sbGVyJ1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAud2hlbihcIi9kZXRhaWxzdXNlclwiLHtcclxuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vdmlld3MvZGV0YWlsc1VzZXIuaHRtbFwiXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC53aGVuKFwiL2FjdGl2aXR5ZGV0YWlscy86YWN0aXZpdHlOYW1lXCIsIHtcclxuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vdmlld3MvZGV0YWlsc0FjdGl2aXR5Lmh0bWxcIixcclxuICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6IFwiQWN0aXZpdGllc0NvbnRyb2xsZXJcIlxyXG5cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLndoZW4oXCIvY2hhdFwiLHtcclxuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vdmlld3MvY2hhdC5odG1sXCJcclxuICAgICAgICAgICAgfSk7XHJcblxyXG5cclxuICAgIH0pO1xyXG5cclxuICAgIGFwcC5ydW4oZnVuY3Rpb24gKCRyb290U2NvcGUpIHtcclxuICAgICAgICAkcm9vdFNjb3BlLnVzZXIgPSB7fTtcclxuICAgIH0pO1xyXG5cclxuICAgIGFwcC5kaXJlY3RpdmUoJ25nRW50ZXInLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cnMpIHtcclxuICAgICAgICAgICAgZWxlbWVudC5iaW5kKFwia2V5ZG93biBrZXlwcmVzc1wiLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICAgICAgICAgIGlmIChldmVudC53aGljaCA9PT0gMTMpIHtcclxuICAgICAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kZXZhbChhdHRycy5uZ0VudGVyKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH0pO1xyXG5cclxuXHJcbiAgICBhcHAuZGlyZWN0aXZlKCdmaWxlTW9kZWwnLCBbJyRwYXJzZScsIGZ1bmN0aW9uICgkcGFyc2UpIHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICByZXN0cmljdDogJ0EnLFxyXG4gICAgICAgICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMpIHtcclxuICAgICAgICAgICAgICAgIHZhciBtb2RlbCA9ICRwYXJzZShhdHRycy5maWxlTW9kZWwpO1xyXG4gICAgICAgICAgICAgICAgdmFyIG1vZGVsU2V0dGVyID0gbW9kZWwuYXNzaWduO1xyXG5cclxuICAgICAgICAgICAgICAgIGVsZW1lbnQuYmluZCgnY2hhbmdlJywgZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWxTZXR0ZXIoc2NvcGUsIGVsZW1lbnRbMF0uZmlsZXNbMF0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgfV0pO1xyXG5cclxuICAgIGFwcC5zZXJ2aWNlKCdmaWxlVXBsb2FkJywgWyckaHR0cCcsIGZ1bmN0aW9uICgkaHR0cCkge1xyXG4gICAgICAgIHRoaXMudXBsb2FkRmlsZVRvVXJsID0gZnVuY3Rpb24oZmlsZSwgdXBsb2FkVXJsKXtcclxuICAgICAgICAgICAgdmFyIGZkID0gbmV3IEZvcm1EYXRhKCk7XHJcbiAgICAgICAgICAgIGZkLmFwcGVuZCgnZmlsZScsIGZpbGUpO1xyXG4gICAgICAgICAgICAkaHR0cC5wb3N0KHVwbG9hZFVybCwgZmQsIHtcclxuICAgICAgICAgICAgICAgIHRyYW5zZm9ybVJlcXVlc3Q6IGFuZ3VsYXIuaWRlbnRpdHksXHJcbiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7J0NvbnRlbnQtVHlwZSc6IHVuZGVmaW5lZH1cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC5zdWNjZXNzKGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJzdWNjZXNzXCIpO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC5lcnJvcihmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiZXJyb3JcIik7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfV0pO1xyXG5cclxuXHJcbiAgICBhcHAuZGlyZWN0aXZlKCdlZGl0YWJsZUNoZWNrYm94JywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHJlc3RyaWN0OiAnRScsXHJcbiAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnLi92aWV3cy9lZGl0YWJsZWNoZWNrYm94Lmh0bWwnXHJcbiAgICAgICAgfTtcclxuICAgIH0pO1xyXG5cclxuXHJcbn0pKCk7IiwiLyoqXHJcbiAqIENyZWF0ZWQgYnkgaW1hbiBvbiAxNS8xMi8xNS5cclxuICovXHJcbnZhciBBY3Rpdml0eSA9IGZ1bmN0aW9uKG5hbWUsIHppcGNvZGUsIHN0cmVldCwgbnVtYmVyLCBkZXNjcmlwdGlvbiwgZGF0ZUZyb20sIGRhdGVVbnRpbCwgdGltZXN0YW1wLCB1c2VybmFtZSwgbWF0Y2hlcyl7XHJcbiAgICB0aGlzLmFjdGl2aXR5TmFtZSA9IG5hbWU7XHJcbiAgICB0aGlzLnppcGNvZGUgPSB6aXBjb2RlO1xyXG4gICAgdGhpcy5zdHJlZXQgPSBzdHJlZXQ7XHJcbiAgICB0aGlzLm51bWJlciA9IG51bWJlcjtcclxuICAgIHRoaXMuZGVzY3JpcHRpb24gPSBkZXNjcmlwdGlvbjtcclxuICAgIHRoaXMuZGF0ZUZyb20gPSBkYXRlRnJvbTtcclxuICAgIHRoaXMuZGF0ZVVudGlsID0gZGF0ZVVudGlsO1xyXG4gICAgdGhpcy50aW1lc3RhbXAgPSB0aW1lc3RhbXA7XHJcbiAgICB0aGlzLnVzZXJuYW1lID0gdXNlcm5hbWU7XHJcbiAgICB0aGlzLm1hdGNoZXMgPSBtYXRjaGVzO1xyXG59OyIsIi8qKlxyXG4gKiBDcmVhdGVkIGJ5IGltYW4gb24gNS8xMi8xNS5cclxuICovXHJcbi8qKGZ1bmN0aW9uKCl7XHJcblxyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4gICAgdmFyIGFjdGl2aXRpZXNTZXJ2aWNlID0gZnVuY3Rpb24gKCkge1xyXG5cclxuICAgICAgICB2YXIgZ2V0QWN0aXZpdGllcyA9IGZ1bmN0aW9uICgpIHtcclxuXHJcbiAgICAgICAgICAgIHZhciBsb2NhbFVybCA9IFwiaHR0cDovL2xvY2FsaG9zdDozMDAwL2RhdGEvYWN0aXZpdGllcy5qc29uXCI7XHJcbiAgICAgICAgICAgIHZhciB4bWxIdHRwID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XHJcbiAgICAgICAgICAgIHhtbEh0dHAub3BlbihcIkdFVFwiLCBsb2NhbFVybCwgZmFsc2UpO1xyXG4gICAgICAgICAgICB4bWxIdHRwLnNlbmQobnVsbCk7XHJcblxyXG4gICAgICAgICAgICBpZih4bWxIdHRwLnN0YXR1cyA9PSAyMDApIHtcclxuXHJcbiAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IEpTT04ucGFyc2UoeG1sSHR0cC5yZXNwb25zZVRleHQpO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coZGF0YSk7XHJcblxyXG4gICAgICAgICAgICAgICAgdmFyIGFyckFjdGl2aXRpZXMgPSBbXTtcclxuXHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGQgPSBkYXRhW2ldO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICB2YXIgbmV3QWN0aXZpdHkgPSBuZXcgQWN0aXZpdHkoKTtcclxuICAgICAgICAgICAgICAgICAgICBuZXdBY3Rpdml0eS5pbWcgPSBkLmltZztcclxuICAgICAgICAgICAgICAgICAgICBuZXdBY3Rpdml0eS5uYW1lID0gZC5uYW1lO1xyXG4gICAgICAgICAgICAgICAgICAgIG5ld0FjdGl2aXR5LnBsYWNlID0gZC5wbGFjZTtcclxuICAgICAgICAgICAgICAgICAgICBuZXdBY3Rpdml0eS5wYXJ0aWNpcGFudHMgPSBkLnBhcnRpY2lwYW50cztcclxuICAgICAgICAgICAgICAgICAgICBuZXdBY3Rpdml0eS5teUV2ZW50ID0gZC5teUV2ZW50O1xyXG5cclxuICAgICAgICAgICAgICAgICAgICB2YXIgdGV4dCA9IFwiXCI7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaWk9MDsgaWk8IGQua2V5d29yZHMubGVuZ3RoOyBpaSsrKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoaWkgPT0gZC5rZXl3b3Jkcy5sZW5ndGgtMSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ICs9IGQua2V5d29yZHNbaWldO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ICs9IGQua2V5d29yZHNbaWldO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCArPSBcIiwgXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIG5ld0FjdGl2aXR5LmtleXdvcmRzID0gdGV4dDtcclxuICAgICAgICAgICAgICAgICAgICBhcnJBY3Rpdml0aWVzLnB1c2gobmV3QWN0aXZpdHkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiBhcnJBY3Rpdml0aWVzO1xyXG5cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvL3B1YmxpYyBnZWRlZWx0ZVxyXG4gICAgICAgIHJldHVybntcclxuXHJcbiAgICAgICAgICAgIGdldEFjdGl2aXRpZXM6Z2V0QWN0aXZpdGllc1xyXG5cclxuICAgICAgICB9O1xyXG5cclxuICAgIH07XHJcblxyXG4gICAgYW5ndWxhci5tb2R1bGUoXCJhcHBcIikuZmFjdG9yeShcImFjdGl2aXRpZXNTZXJ2aWNlXCIsIFthY3Rpdml0aWVzU2VydmljZV0pO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXiBkZXplIG5hYW0gYmVwYWFsdCB3ZWxrZSBuYWFtIGplIG5vZGlnIGhlYnQgaW4gamUgY29udHJvbGxlciBhbHMgdmVyd2lqemluZyFcclxuXHJcbn0pKCk7Ki8iLCIvKipcclxuICogQ3JlYXRlZCBieSBOaWtpdGEgb24gNy8wMS8yMDE2LlxyXG4gKi9cclxuXHJcblxyXG4oZnVuY3Rpb24gKCkge1xyXG5cclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG5cclxuICAgIHZhciBjaGF0U2VydmljZSA9IGZ1bmN0aW9uICgkcm9vdFNjb3BlKSB7XHJcbiAgICAgICAgdmFyIHNvY2tldCA9IGlvLmNvbm5lY3Qod2luZG93LmxvY2F0aW9uLmhvc3QpO1xyXG5cclxuICAgICAgICB2YXIgb24gPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBjYWxsYmFjaykge1xyXG4gICAgICAgICAgICBzb2NrZXQub24oZXZlbnROYW1lLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IGFyZ3VtZW50cztcclxuICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGFwcGx5KGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5hcHBseShzb2NrZXQsIGFyZ3MpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBlbWl0ID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgZGF0YSwgY2FsbGJhY2spIHtcclxuICAgICAgICAgICAgc29ja2V0LmVtaXQoZXZlbnROYW1lLCBkYXRhLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IGFyZ3VtZW50cztcclxuICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGFwcGx5KGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5hcHBseShzb2NrZXQsIGFyZ3MpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG5cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBvbjogb24sXHJcbiAgICAgICAgICAgIGVtaXQ6IGVtaXQsXHJcbiAgICAgICAgICAgIHNvY2tldDogc29ja2V0XHJcbiAgICAgICAgfTtcclxuICAgIH07XHJcblxyXG4gICAgYW5ndWxhci5tb2R1bGUoXCJhcHBcIikuZmFjdG9yeShcImNoYXRTZXJ2aWNlXCIsIFtcIiRyb290U2NvcGVcIiwgY2hhdFNlcnZpY2VdKTtcclxuXHJcbn0pKCk7IiwiLyoqXHJcbiAqIENyZWF0ZWQgYnkgaW1hbiBvbiAxNS8xMi8xNS5cclxuICovXHJcblxyXG5cclxuKGZ1bmN0aW9uKCl7XHJcblxyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4gICAgdmFyIGRiU2VydmljZSA9IGZ1bmN0aW9uICgkaHR0cCkge1xyXG5cclxuICAgICAgICB2YXIgZ2V0Q29sbGVjdGlvbiA9IGZ1bmN0aW9uIChjb2xsZWN0aW9uKSB7XHJcblxyXG5cclxuICAgICAgICAgICAgdmFyIHVybCA9IFwiaHR0cDovL2xvY2FsaG9zdDozMDAwL2FwaS9cIiArIGNvbGxlY3Rpb247XHJcbiAgICAgICAgICAgIHJldHVybiAkaHR0cC5nZXQodXJsKS50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKXtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5kYXRhO1xyXG5cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBnZXRCeUlEID0gZnVuY3Rpb24gKGNvbGxlY3Rpb24sIGlkKSB7XHJcbiAgICAgICAgICAgIHZhciB1cmwgPSBcImh0dHA6Ly9sb2NhbGhvc3Q6MzAwMC9hcGkvXCIgKyBjb2xsZWN0aW9uICsgXCIvXCIgKyBpZDtcclxuICAgICAgICAgICAgcmV0dXJuICRodHRwLmdldCh1cmwpLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2Upe1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7XHJcblxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIGdldERldGFpbHNVc2VyID0gZnVuY3Rpb24gKGNvbGxlY3Rpb24sIHVzZXJuYW1lKSB7XHJcbiAgICAgICAgICAgIHZhciB1cmwgPSBcImh0dHA6Ly9sb2NhbGhvc3Q6MzAwMC9hcGkvXCIgKyBjb2xsZWN0aW9uICsgXCIvdXNlcmRldGFpbC9cIiArIHVzZXJuYW1lO1xyXG4gICAgICAgICAgICByZXR1cm4gJGh0dHAuZ2V0KHVybCkudGhlbihmdW5jdGlvbihyZXNwb25zZSl7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YTtcclxuXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgZGVsZXRlVXNlciA9ICBmdW5jdGlvbiAoY29sbGVjdGlvbiwgdXNlcm5hbWUpIHtcclxuICAgICAgICAgICAgdmFyIHVybCA9IFwiaHR0cDovL2xvY2FsaG9zdDozMDAwL2FwaS9cIiArIGNvbGxlY3Rpb24gKyBcIi91c2VyZGVsZXRlL1wiICsgdXNlcm5hbWU7XHJcbiAgICAgICAgICAgIHJldHVybiAkaHR0cC5nZXQodXJsKS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7XHJcblxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgdXBkYXRlVXNlciA9IGZ1bmN0aW9uIChjb2xsZWN0aW9uKSB7XHJcbiAgICAgICAgICAgIHZhciB1cmwgPSBcImh0dHA6Ly9sb2NhbGhvc3Q6MzAwMC9hcGkvXCIgKyBjb2xsZWN0aW9uICsgXCIvdXBkYXRlcHJvZmlsZVwiO1xyXG4gICAgICAgICAgICByZXR1cm4gJGh0dHAuZ2V0KHVybCkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5kYXRhO1xyXG5cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIGdldEl0ZW0gPSBmdW5jdGlvbihpdGVtKXtcclxuXHJcbiAgICAgICAgICAgIHZhciB1cmwgPSBcImh0dHA6Ly9sb2NhbGhvc3Q6MzAwMC9hcGkvXCIgKyBpdGVtO1xyXG4gICAgICAgICAgICByZXR1cm4gJGh0dHAuZ2V0KCcvdXNlcicpLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2Upe1xyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5kYXRhO1xyXG5cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBnZXREZXRhaWxzQWN0aXZpdHkgPSBmdW5jdGlvbiAoY29sbGVjdGlvbiwgYWN0aXZpdHluYW1lKSB7XHJcbiAgICAgICAgICAgIHZhciB1cmwgPSBcImh0dHA6Ly9sb2NhbGhvc3Q6MzAwMC9hcGkvXCIgKyBjb2xsZWN0aW9uICsgXCIvYWN0aXZpdHlkZXRhaWwvXCIgKyBhY3Rpdml0eW5hbWU7XHJcbiAgICAgICAgICAgIHJldHVybiAkaHR0cC5nZXQodXJsKS50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKXtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5kYXRhO1xyXG5cclxuXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgZGVsZXRlQWN0aXZpdHkgPSAgZnVuY3Rpb24gKGNvbGxlY3Rpb24sIGFjdGl2aXR5SWQpIHtcclxuICAgICAgICAgICAgdmFyIHVybCA9IFwiaHR0cDovL2xvY2FsaG9zdDozMDAwL2FwaS9cIiArIGNvbGxlY3Rpb24gKyBcIi9hY3Rpdml0eWRlbGV0ZS9cIiArIGFjdGl2aXR5SWQ7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKHVybCk7XHJcbiAgICAgICAgICAgIHJldHVybiAkaHR0cC5nZXQodXJsKS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2cocmVzcG9uc2UpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7XHJcblxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG5cclxuXHJcbiAgICAgICAgdmFyIGdldE5vaXNlV29yZHMgPSBmdW5jdGlvbiAoKSB7XHJcblxyXG4gICAgICAgICAgICB2YXIgdXJsID0gXCJodHRwOi8vbG9jYWxob3N0OjMwMDAvZGF0YS9ub2lzZXdvcmRzLmpzb25cIjtcclxuICAgICAgICAgICAgcmV0dXJuICRodHRwLmdldCh1cmwpLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2Upe1xyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5kYXRhO1xyXG5cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIH07XHJcblxyXG5cclxuICAgICAgICAvL3B1YmxpYyBnZWRlZWx0ZVxyXG4gICAgICAgIHJldHVybntcclxuXHJcbiAgICAgICAgICAgIGdldENvbGxlY3Rpb246Z2V0Q29sbGVjdGlvbixcclxuICAgICAgICAgICAgZ2V0QnlJRDpnZXRCeUlELFxyXG4gICAgICAgICAgICBnZXRJdGVtOmdldEl0ZW0sXHJcbiAgICAgICAgICAgIGdldERldGFpbHNVc2VyOiBnZXREZXRhaWxzVXNlcixcclxuICAgICAgICAgICAgZGVsZXRlVXNlcjogZGVsZXRlVXNlcixcclxuICAgICAgICAgICAgdXBkYXRlVXNlcjogdXBkYXRlVXNlcixcclxuICAgICAgICAgICAgZ2V0RGV0YWlsc0FjdGl2aXR5OiBnZXREZXRhaWxzQWN0aXZpdHksXHJcbiAgICAgICAgICAgIGdldE5vaXNlV29yZHM6IGdldE5vaXNlV29yZHMsXHJcbiAgICAgICAgICAgIGRlbGV0ZUFjdGl2aXR5OiBkZWxldGVBY3Rpdml0eVxyXG5cclxuICAgICAgICB9O1xyXG5cclxuICAgIH07XHJcblxyXG4gICAgYW5ndWxhci5tb2R1bGUoXCJhcHBcIikuZmFjdG9yeShcImRiU2VydmljZVwiLCBbXCIkaHR0cFwiLCBkYlNlcnZpY2VdKTtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF4gZGV6ZSBuYWFtIGJlcGFhbHQgd2Vsa2UgbmFhbSBqZSBub2RpZyBoZWJ0IGluIGplIGNvbnRyb2xsZXIgYWxzIHZlcndpanppbmchXHJcblxyXG59KSgpOyIsIi8qKlxyXG4gKiBDcmVhdGVkIGJ5IGltYW4gb24gNS8xMi8xNS5cclxuICovXHJcbihmdW5jdGlvbigpe1xyXG5cclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG5cclxuICAgIHZhciBtYXRjaGVzU2VydmljZSA9IGZ1bmN0aW9uICgpIHtcclxuXHJcbiAgICAgICAgdmFyIGdldE1hdGNoZXMgPSBmdW5jdGlvbiAobmFtZVVzZXIpIHtcclxuXHJcbiAgICAgICAgICAgIHZhciB2YXJpYWJlbFVSTCA9IFwidG9nZXRoZXJcIjtcclxuICAgICAgICAgICAgdmFyIGxvY2FsVXJsID0gXCJodHRwOi8vbG9jYWxob3N0OjMwMDAvZGF0YS9tYXRjaGVzLmpzb25cIjtcclxuICAgICAgICAgICAgdmFyIHhtbEh0dHAgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcclxuICAgICAgICAgICAgeG1sSHR0cC5vcGVuKFwiR0VUXCIsIGxvY2FsVXJsLCBmYWxzZSk7XHJcbiAgICAgICAgICAgIHhtbEh0dHAuc2VuZChudWxsKTtcclxuXHJcbiAgICAgICAgICAgIGlmKHhtbEh0dHAuc3RhdHVzID09IDIwMCkge1xyXG5cclxuICAgICAgICAgICAgICAgIHZhciBkYXRhID0gSlNPTi5wYXJzZSh4bWxIdHRwLnJlc3BvbnNlVGV4dCk7XHJcbiAgICAgICAgICAgICAgICB2YXIgYXJyID0gW107XHJcbiAgICAgICAgICAgICAgICB2YXIgYXJyTWF0Y2hlcyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgdmFyIGFyck1hdGNoVXNlcnMgPSBbXTtcclxuICAgICAgICAgICAgICAgIHZhciBhcnJNYXRjaEludGVyZXN0cyA9IFtdO1xyXG5cclxuICAgICAgICAgICAgICAgIGZvcih2YXIgaT0wOyBpIDwgZGF0YS5sZW5ndGg7IGkrKyl7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBvYmogPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFwidXNlclwiOiBkYXRhW2ldLnVzZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFwibWF0Y2hlc1wiOmRhdGFbaV0ubWF0Y2hlc1xyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGFyci5wdXNoKG9iaik7XHJcblxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGZvcih2YXIgaWkgPSAwOyBpaTxhcnIubGVuZ3RoOyBpaSsrKXtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gYXJyW2lpXS51c2VyLmluZGV4T2YobmFtZVVzZXIpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKGluZGV4ID09PSAwKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXJyTWF0Y2hlcy5wdXNoKGFycltpaV0ubWF0Y2hlcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coXCJJbmRleDogXCIraW5kZXgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coYXJyKTtcclxuICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coYXJyTWF0Y2hlc1swXSk7XHJcblxyXG5cclxuICAgICAgICAgICAgICAgIHZhciBhcnJNYXRjaGVzQnlVc2VyID0gYXJyTWF0Y2hlc1swXTtcclxuICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coXCJBYW50YWwgbWF0Y2hlczogXCIgKyBhcnJNYXRjaGVzQnlVc2VyLmxlbmd0aCk7XHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFyck1hdGNoZXNCeVVzZXI7XHJcblxyXG4gICAgICAgICAgICAgICAgLypcclxuICAgICAgICAgICAgICAgIGZvcih2YXIgaWlpID0gMDsgaWlpPGFyck1hdGNoZXNbMF0ubGVuZ3RoOyBpaWkrKyl7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBtYXRjaFVzZXIgPSBhcnJNYXRjaGVzWzBdW2lpaV0udXNlcjtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgbWF0Y2hJbnRlcmVzdHMgPSBhcnJNYXRjaGVzWzBdW2lpaV0uaW50ZXJlc3RzO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBhcnJNYXRjaFVzZXJzLnB1c2gobWF0Y2hVc2VyKTtcclxuICAgICAgICAgICAgICAgICAgICBhcnJNYXRjaEludGVyZXN0cy5wdXNoKG1hdGNoSW50ZXJlc3RzKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhtYXRjaFVzZXIpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2cobWF0Y2hJbnRlcmVzdHMpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGFyck1hdGNoVXNlcnMpO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYXJyTWF0Y2hJbnRlcmVzdHMpO1xyXG4gICAgICAgICAgICAgICAgKi9cclxuXHJcbiAgICAgICAgICAgIH1cclxuXHJcblxyXG5cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvL3B1YmxpYyBnZWRlZWx0ZVxyXG4gICAgICAgIHJldHVybntcclxuXHJcbiAgICAgICAgICAgIGdldE1hdGNoZXM6Z2V0TWF0Y2hlcyxcclxuXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICB9O1xyXG5cclxuICAgIGFuZ3VsYXIubW9kdWxlKFwiYXBwXCIpLmZhY3RvcnkoXCJtYXRjaGVzU2VydmljZVwiLCBbbWF0Y2hlc1NlcnZpY2VdKTtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF4gZGV6ZSBuYWFtIGJlcGFhbHQgd2Vsa2UgbmFhbSBqZSBub2RpZyBoZWJ0IGluIGplIGNvbnRyb2xsZXIgYWxzIHZlcndpanppbmchXHJcblxyXG59KSgpOyIsIi8qKlxyXG4gKiBDcmVhdGVkIGJ5IGltYW4gb24gNS8xMi8xNS5cclxuICovXHJcblxyXG4oZnVuY3Rpb24gKCkge1xyXG5cclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG4gICAgdmFyIGRhdGVUaW1lTm93ID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpLnN1YnN0cmluZygwLCAxMCkgKyBcIiBcIiArIG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5zdWJzdHJpbmcoMTEsIDE2KTtcclxuXHJcbiAgICB2YXIgQWN0aXZpdGllc0NvbnRyb2xsZXIgPSBmdW5jdGlvbiAoJHNjb3BlLCBkYlNlcnZpY2UsICRodHRwLCAkbG9jYXRpb24sICRyb3V0ZVBhcmFtcywgJHJvdXRlKSB7XHJcbiAgICAgICAgJHNjb3BlLmludGVyZXN0ZWRBY3QgPSB0cnVlO1xyXG4gICAgICAgICRzY29wZS5uYW1lQnV0dG9uID0gXCJJbnRlcmVzdGVkXCI7XHJcblxyXG4gICAgICAgICRzY29wZS5nZXRBY3Rpdml0aWVzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBkYlNlcnZpY2UuZ2V0Q29sbGVjdGlvbignYWN0aXZpdGllcycpLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgdmFyIGFyclRlbXAgPSByZXNwb25zZS5hY3Rpdml0aWVsaXN0O1xyXG4gICAgICAgICAgICAgICAgdmFyIGFyckFjdHMgPSBbXTtcclxuXHJcblxyXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBhcnJUZW1wLmxlbmd0aDsgaSA8IGw7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChuZXcgRGF0ZShhcnJUZW1wW2ldLnVudGlsRGF0ZSkuZ2V0VGltZSgpID49IG5ldyBEYXRlKGRhdGVUaW1lTm93KS5nZXRUaW1lKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoYXJyVGVtcFtpXS5kZWxldGVkID09PSBmYWxzZSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuZGVsZXRlZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyQWN0cy5wdXNoKGFyclRlbXBbaV0pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5kZWxldGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAkc2NvcGUuYXJyQWN0aXZpdGllcyA9IGFyckFjdHM7XHJcblxyXG4gICAgICAgICAgICB9KTtcclxuXHJcblxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIFN0cmluZy5wcm90b3R5cGUucmVwbGFjZUFsbCA9IGZ1bmN0aW9uICh0b2tlbiwgbmV3VG9rZW4sIGlnbm9yZUNhc2UpIHtcclxuICAgICAgICAgICAgdmFyIF90b2tlbjtcclxuICAgICAgICAgICAgdmFyIHN0ciA9IHRoaXMgKyBcIlwiO1xyXG4gICAgICAgICAgICB2YXIgaSA9IC0xO1xyXG5cclxuICAgICAgICAgICAgaWYgKHR5cGVvZiB0b2tlbiA9PT0gXCJzdHJpbmdcIikge1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChpZ25vcmVDYXNlKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIF90b2tlbiA9IHRva2VuLnRvTG93ZXJDYXNlKCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHdoaWxlICgoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGkgPSBzdHIudG9Mb3dlckNhc2UoKS5pbmRleE9mKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW4sIGkgPj0gMCA/IGkgKyBuZXdUb2tlbi5sZW5ndGggOiAwXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICkgKSAhPT0gLTFcclxuICAgICAgICAgICAgICAgICAgICAgICAgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0ciA9IHN0ci5zdWJzdHJpbmcoMCwgaSkgK1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3VG9rZW4gK1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyLnN1YnN0cmluZyhpICsgdG9rZW4ubGVuZ3RoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zcGxpdCh0b2tlbikuam9pbihuZXdUb2tlbik7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBzdHI7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgZnVuY3Rpb24gaXNJbkFycmF5KHZhbHVlLCBhcnJheSkge1xyXG4gICAgICAgICAgICByZXR1cm4gYXJyYXkuaW5kZXhPZih2YWx1ZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmdW5jdGlvbiBnZXRLZXl3b3Jkc0Zyb21EZXNjcmlwdGlvbihkZXNjcmlwdGlvbiwgY2FsbGJhY2spIHtcclxuXHJcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gZGVzY3JpcHRpb24ucmVwbGFjZUFsbCgnLicsICcnKTtcclxuICAgICAgICAgICAgZGVzY3JpcHRpb24gPSBkZXNjcmlwdGlvbi5yZXBsYWNlQWxsKCcsJywgJycpO1xyXG4gICAgICAgICAgICBkZXNjcmlwdGlvbiA9IGRlc2NyaXB0aW9uLnJlcGxhY2VBbGwoJz8nLCAnJyk7XHJcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gZGVzY3JpcHRpb24ucmVwbGFjZUFsbCgnIScsICcnKTtcclxuICAgICAgICAgICAgZGVzY3JpcHRpb24gPSBkZXNjcmlwdGlvbi5yZXBsYWNlQWxsKCdcIicsICcnKTtcclxuICAgICAgICAgICAgZGVzY3JpcHRpb24gPSBkZXNjcmlwdGlvbi5yZXBsYWNlQWxsKFwiJ1wiLCAnJyk7XHJcblxyXG4gICAgICAgICAgICB2YXIgd29yZHMgPSBkZXNjcmlwdGlvbi5zcGxpdChcIiBcIik7XHJcbiAgICAgICAgICAgIHZhciBrZXlXb3JkcyA9IFwiXCI7XHJcblxyXG4gICAgICAgICAgICBkYlNlcnZpY2UuZ2V0Tm9pc2VXb3JkcygpLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgdmFyIG5vaXNlV29yZHMgPSByZXNwb25zZS5ub2lzZXdvcmRzO1xyXG5cclxuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgd29yZHMubGVuZ3RoOyBpKyspIHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzSW5BcnJheSh3b3Jkc1tpXS50b0xvd2VyQ2FzZSgpLCBub2lzZVdvcmRzKSA9PSAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBrZXlXb3JkcyArPSB3b3Jkc1tpXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAga2V5V29yZHMgKz0gXCIgXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIC8vcmV0dXJuIGtleVdvcmRzO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFrZXlXb3Jkcy5pc0VtcHR5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwga2V5V29yZHMpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKFwiTm8ga2V5d29yZHMgZm91bmQuXCIsIG51bGwpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmdW5jdGlvbiBzdHJpbmdDb25zaXN0T2YyTnVtYmVycyhudW1iZXIsIGNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgIHZhciBvdXRwdXQgPSBudW1iZXIgKyAnJztcclxuICAgICAgICAgICAgaWYgKG91dHB1dC5sZW5ndGggPCAyKSB7XHJcbiAgICAgICAgICAgICAgICBvdXRwdXQgPSAnMCcgKyBvdXRwdXQ7XHJcbiAgICAgICAgICAgICAgICBudW1iZXIgPSBvdXRwdXQudG9TdHJpbmcoKTtcclxuXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBudW1iZXIgPSBudW1iZXIudG9TdHJpbmcoKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgICAgIGlmICghbnVtYmVyLmlzRW1wdHkpIHtcclxuICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIG51bWJlcik7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY2FsbGJhY2soXCJObyBudW1iZXIuXCIsIG51bGwpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIGZ1bGxEYXRlKG51bWJlciwgbnVtYmVyMiwgY2FsbGJhY2spIHtcclxuICAgICAgICAgICAgc3RyaW5nQ29uc2lzdE9mMk51bWJlcnMobnVtYmVyLCBmdW5jdGlvbiAoZXJyb3IsIG51bWJlclRvU3RyaW5nKSB7XHJcbiAgICAgICAgICAgICAgICBudW1iZXIgPSBudW1iZXJUb1N0cmluZztcclxuICAgICAgICAgICAgICAgIGlmIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycm9yKTtcclxuXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBzdHJpbmdDb25zaXN0T2YyTnVtYmVycyhudW1iZXIyLCBmdW5jdGlvbiAoZXJyb3IsIG51bWJlclRvU3RyaW5nKSB7XHJcbiAgICAgICAgICAgICAgICBudW1iZXIyID0gbnVtYmVyVG9TdHJpbmc7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnJvcik7XHJcblxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIGlmICghbnVtYmVyLmlzRW1wdHkgJiYgIW51bWJlcjIuaXNFbXB0eSkge1xyXG4gICAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgbnVtYmVyLCBudW1iZXIyKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhcIk5vIG51bWJlci5cIiwgbnVsbCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgICRzY29wZS5hZGRBY3Rpdml0eSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIGFjdGl2aXR5TmFtZSA9IHRoaXMuYWN0aXZpdHlOYW1lO1xyXG4gICAgICAgICAgICB2YXIgc3RyZWV0ID0gdGhpcy5zdHJlZXQ7XHJcbiAgICAgICAgICAgIHZhciBudW1iZXIgPSB0aGlzLm51bWJlcjtcclxuICAgICAgICAgICAgdmFyIHppcGNvZGUgPSB0aGlzLnppcGNvZGU7XHJcbiAgICAgICAgICAgIHZhciBkZXNjcmlwdGlvbiA9IHRoaXMuY29tbWVudDtcclxuICAgICAgICAgICAgdmFyIGRhdGVGcm9tID0gdGhpcy5kYXRlRnJvbTtcclxuICAgICAgICAgICAgdmFyIGRhdGVVbnRpbCA9IHRoaXMuZGF0ZVVudGlsO1xyXG4gICAgICAgICAgICB2YXIgdGltZXN0YW1wID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XHJcbiAgICAgICAgICAgIHZhciBzdGFydFRpbWVIb3VyID0gdGhpcy5zdGFydFRpbWVIb3VyO1xyXG4gICAgICAgICAgICB2YXIgc3RhcnRUaW1lTWluID0gdGhpcy5zdGFydFRpbWVNaW47XHJcbiAgICAgICAgICAgIHZhciBlbmRUaW1lSG91ciA9IHRoaXMuZW5kVGltZUhvdXI7XHJcbiAgICAgICAgICAgIHZhciBlbmRUaW1lTWluID0gdGhpcy5lbmRUaW1lTWluO1xyXG4gICAgICAgICAgICB2YXIgZGF0ZUZyb21EYXkgPSB0aGlzLmRhdGVGcm9tRGF5O1xyXG4gICAgICAgICAgICB2YXIgZGF0ZUZyb21Nb250aCA9IHRoaXMuZGF0ZUZyb21Nb250aDtcclxuICAgICAgICAgICAgdmFyIGRhdGVGcm9tWWVhciA9IHRoaXMuZGF0ZUZyb21ZZWFyLnRvU3RyaW5nKCk7XHJcbiAgICAgICAgICAgIHZhciBkYXRlVW50aWxEYXkgPSB0aGlzLmRhdGVVbnRpbERheTtcclxuICAgICAgICAgICAgdmFyIGRhdGVVbnRpbE1vbnRoID0gdGhpcy5kYXRlVW50aWxNb250aDtcclxuICAgICAgICAgICAgdmFyIGRhdGVVbnRpbFllYXIgPSB0aGlzLmRhdGVVbnRpbFllYXIudG9TdHJpbmcoKTtcclxuXHJcbiAgICAgICAgICAgIGZ1bGxEYXRlKGRhdGVGcm9tRGF5LCBkYXRlRnJvbU1vbnRoLCBmdW5jdGlvbiAoZXJyb3IsIGRhdGVGcm9tZGF5U3RyaW5nLCBkYXRlRnJvbU1vbnRoU3RyaW5nKSB7XHJcbiAgICAgICAgICAgICAgICBkYXRlRnJvbURheSA9IGRhdGVGcm9tZGF5U3RyaW5nO1xyXG4gICAgICAgICAgICAgICAgZGF0ZUZyb21Nb250aCA9IGRhdGVGcm9tTW9udGhTdHJpbmc7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnJvcik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBmdWxsRGF0ZShkYXRlVW50aWxEYXksIGRhdGVVbnRpbE1vbnRoLCBmdW5jdGlvbiAoZXJyb3IsIGRhdGVVbnRpbERheVN0cmluZywgZGF0ZVVudGlsTW9udGhTdHJpbmcpIHtcclxuICAgICAgICAgICAgICAgIGRhdGVVbnRpbERheSA9IGRhdGVVbnRpbERheVN0cmluZztcclxuICAgICAgICAgICAgICAgIGRhdGVVbnRpbE1vbnRoID0gZGF0ZVVudGlsTW9udGhTdHJpbmc7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnJvcik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuXHJcbiAgICAgICAgICAgIGlmICgoc3RyZWV0ICE9PSB1bmRlZmluZWQpICYmXHJcbiAgICAgICAgICAgICAgICAobnVtYmVyICE9PSB1bmRlZmluZWQpICYmXHJcbiAgICAgICAgICAgICAgICAoemlwY29kZSAhPT0gdW5kZWZpbmVkKSAmJlxyXG4gICAgICAgICAgICAgICAgKGRlc2NyaXB0aW9uICE9PSB1bmRlZmluZWQpICYmXHJcbiAgICAgICAgICAgICAgICAodGltZXN0YW1wICE9PSB1bmRlZmluZWQpKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgJHNjb3BlLmVycm9yID0gXCJcIjtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoc3RhcnRUaW1lTWluIDwgNjAgJiYgc3RhcnRUaW1lSG91ciA8IDI1KSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHN0cmluZ0NvbnNpc3RPZjJOdW1iZXJzKHN0YXJ0VGltZUhvdXIsIGZ1bmN0aW9uIChlcnJvciwgc3RhcnRUaW1lSG91clN0cmluZykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGFydFRpbWVIb3VyID0gc3RhcnRUaW1lSG91clN0cmluZztcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnJvcik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICBzdHJpbmdDb25zaXN0T2YyTnVtYmVycyhzdGFydFRpbWVNaW4sIGZ1bmN0aW9uIChlcnJvciwgc3RhcnRUaW1lTWluU3RyaW5nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0VGltZU1pbiA9IHN0YXJ0VGltZU1pblN0cmluZztcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnJvcik7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHN0YXJ0VGltZUhvdXIpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHN0YXJ0VGltZU1pbik7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGFydFRpbWVNaW4ubGVuZ3RoID09PSAyICYmIHN0YXJ0VGltZUhvdXIubGVuZ3RoID09PSAyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiamUga29tdCBoaWVyIHRlcmVjaHRcIik7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZW5kVGltZU1pbiA8IDYwICYmIGVuZFRpbWVIb3VyIDwgMjQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmluZ0NvbnNpc3RPZjJOdW1iZXJzKGVuZFRpbWVIb3VyLCBmdW5jdGlvbiAoZXJyb3IsIGVuZFRpbWVIb3VyU3RyaW5nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5kVGltZUhvdXIgPSBlbmRUaW1lSG91clN0cmluZztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5nQ29uc2lzdE9mMk51bWJlcnMoZW5kVGltZU1pbiwgZnVuY3Rpb24gKGVycm9yLCBlbmRUaW1lTWluU3RyaW5nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5kVGltZU1pbiA9IGVuZFRpbWVNaW5TdHJpbmc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycm9yKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZW5kVGltZUhvdXIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZW5kVGltZU1pbik7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVuZFRpbWVNaW4udG9TdHJpbmcoKS5sZW5ndGggPT09IDIgJiYgZW5kVGltZUhvdXIudG9TdHJpbmcoKS5sZW5ndGggPT09IDIpIHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coc3RhcnRUaW1lSG91ciArIFwiOlwiICsgc3RhcnRUaW1lTWluKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0S2V5d29yZHNGcm9tRGVzY3JpcHRpb24oZGVzY3JpcHRpb24sIGZ1bmN0aW9uIChlcnJvciwgZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbiA9IGRhdGE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHN0YXJ0VGltZUhvdXIgKyBcIjpcIiArIHN0YXJ0VGltZU1pbik7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHVybCA9IFwiL2FwaS9hY3Rpdml0aWVzL2FkZGFjdGl2aXR5XCI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkaHR0cC5wb3N0KHVybCwge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2aXR5TmFtZTogYWN0aXZpdHlOYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmVldDogc3RyZWV0LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bWJlcjogbnVtYmVyLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHppcGNvZGU6IHppcGNvZGUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IGRlc2NyaXB0aW9uLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGVGcm9tOiBkYXRlRnJvbVllYXIgKyBcIi1cIiArIGRhdGVGcm9tTW9udGggKyBcIi1cIiArIGRhdGVGcm9tRGF5ICsgXCIgXCIgKyBzdGFydFRpbWVIb3VyICsgXCI6XCIgKyBzdGFydFRpbWVNaW4sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0ZVVudGlsOiBkYXRlVW50aWxZZWFyICsgXCItXCIgKyBkYXRlRnJvbU1vbnRoICsgXCItXCIgKyBkYXRlVW50aWxEYXkgKyBcIiBcIiArIGVuZFRpbWVIb3VyICsgXCI6XCIgKyBlbmRUaW1lTWluLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogdGltZXN0YW1wXHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkuc3VjY2VzcyhmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5lcnJvciA9IGRhdGEuZXJyb3I7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmdldEFjdGl2aXRpZXMoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNldEZvcm0oKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8kbG9jYXRpb24ucGF0aChkYXRhLnJlZGlyZWN0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycm9yKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5lcnJvciA9IFwiRW5kZGF0ZSBpbnB1dCBpcyBub3QgY29ycmVjdFwiO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5lcnJvciA9IFwiRW5kdGltZSBpbnB1dCBpcyBub3QgY29ycmVjdFwiO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5lcnJvciA9ICdEZSBzdGFydGltZSBsZW5ndGggaXMgbm90IGNvcnJlY3QhISEhICc7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmVycm9yID0gXCJTdGFydHRpbWUgaW5wdXQgaXMgbm90IGNvcnJlY3RcIjtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLmVycm9yID0gXCJFUlJPUjogQWxsIGZpZWxkcyBhcmUgcmVxdWlyZWQuODg4OFwiO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgJHNjb3BlLmdldERldGFpbEFjdGl2aXR5ID0gZnVuY3Rpb24gKGN1cnJlbnRVc2VyKSB7XHJcbiAgICAgICAgICAgIGRiU2VydmljZS5nZXREZXRhaWxzQWN0aXZpdHkoJ2FjdGl2aXRpZXMnLCAkcm91dGVQYXJhbXMuYWN0aXZpdHlOYW1lKS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLmFyckRldGFpbHNBY3Rpdml0eSA9IHJlc3BvbnNlLmFjdGl2aXR5O1xyXG4gICAgICAgICAgICAgICAgaW5pdG1hcCgpO1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCRzY29wZS5hcnJEZXRhaWxzQWN0aXZpdHkubWF0Y2hlcyk7XHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8ICRzY29wZS5hcnJEZXRhaWxzQWN0aXZpdHkubWF0Y2hlcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICgkc2NvcGUuYXJyRGV0YWlsc0FjdGl2aXR5Lm1hdGNoZXNbaV0gPT09IGN1cnJlbnRVc2VyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5uYW1lQnV0dG9uID0gXCJOb3QgaW50ZXJlc3RlZFwiO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuaW50ZXJlc3RlZEFjdCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiAkc2NvcGUuYXJyRGV0YWlsc0FjdGl2aXR5O1xyXG5cclxuXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgICRzY29wZS5pbnRlcmVzdGVkID0gZnVuY3Rpb24gKGFjdGl2aXR5TmFtZSwgaW50ZXJlc3RlZFVzZXIsIGNyZWF0ZXJVc2VyKSB7XHJcbiAgICAgICAgICAgIHZhciB1cmwgPSBcIlwiO1xyXG4gICAgICAgICAgICB2YXIgaW50ZXJlc3RlZEFjdCA9ICRzY29wZS5pbnRlcmVzdGVkQWN0O1xyXG4gICAgICAgICAgICBpZiAoaW50ZXJlc3RlZEFjdCAhPT0gZmFsc2UpIHtcclxuXHJcbiAgICAgICAgICAgICAgICB1cmwgPSBcIi9hcGkvYWN0aXZpdGllcy9pbnRlcmVzdGVkXCI7XHJcbiAgICAgICAgICAgICAgICAkaHR0cC5wb3N0KHVybCwge1xyXG4gICAgICAgICAgICAgICAgICAgIGFjdGl2aXR5TmFtZTogYWN0aXZpdHlOYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgIGludGVyZXN0ZWRVc2VyOiBpbnRlcmVzdGVkVXNlcixcclxuICAgICAgICAgICAgICAgICAgICBjcmVhdGVyVXNlcjogY3JlYXRlclVzZXJcclxuICAgICAgICAgICAgICAgIH0pLnN1Y2Nlc3MoZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhkYXRhKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhpbnRlcmVzdGVkVXNlciArIFwiIGlzIGdlw69udGVyZXNzZWVyZCBpbiBcIiArIGFjdGl2aXR5TmFtZSArIFwiIGRvb3IgXCIgKyBjcmVhdGVyVXNlcik7XHJcbiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmludGVyZXN0ZWRBY3QgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAkc2NvcGUubmFtZUJ1dHRvbiA9IFwiTm90IGludGVyZXN0ZWRcIjtcclxuICAgICAgICAgICAgICAgICAgICAkc2NvcGUuZXJyb3IgPSBkYXRhLmVycm9yO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhpbnRlcmVzdGVkQWN0KTtcclxuICAgICAgICAgICAgICAgIHVybCA9IFwiL2FwaS9hY3Rpdml0aWVzL2RlbGV0ZWludGVyZXN0ZWRcIjtcclxuICAgICAgICAgICAgICAgICRodHRwLnBvc3QodXJsLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgYWN0aXZpdHlOYW1lOiBhY3Rpdml0eU5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgaW50ZXJlc3RlZFVzZXI6IGludGVyZXN0ZWRVc2VyLFxyXG4gICAgICAgICAgICAgICAgICAgIGNyZWF0ZXJVc2VyOiBjcmVhdGVyVXNlclxyXG4gICAgICAgICAgICAgICAgfSkuc3VjY2VzcyhmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGludGVyZXN0ZWRVc2VyICsgXCIgaXMgbmlldCBtZWVyIGdlw69udGVyZXNzZWVyZCBpbiBcIiArIGFjdGl2aXR5TmFtZSArIFwiIGRvb3IgXCIgKyBjcmVhdGVyVXNlcik7XHJcbiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmludGVyZXN0ZWRBY3QgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgICRzY29wZS5uYW1lQnV0dG9uID0gXCJJbnRlcmVzdGVkXCI7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICRzY29wZS5lcnJvciA9IGRhdGEuZXJyb3I7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIHJlY2VudEZpcnN0KGEsIGIpIHtcclxuICAgICAgICAgICAgaWYgKGEudGltZXN0YW1wID4gYi50aW1lc3RhbXApXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gLTE7XHJcbiAgICAgICAgICAgIGlmIChhLnRpbWVzdGFtcCA8IGIudGltZXN0YW1wKVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIDE7XHJcbiAgICAgICAgICAgIHJldHVybiAwO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZnVuY3Rpb24gcG9wdWxhckZpcnN0KGFycikge1xyXG4gICAgICAgICAgICB2YXIgbWF4ID0gYXJyWzBdO1xyXG4gICAgICAgICAgICB2YXIgbWF4SW5kZXggPSAwO1xyXG5cclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGlmIChhcnJbaV0ubWF0Y2hlcy5sZW5ndGggPiBtYXgubWF0Y2hlcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICBtYXhJbmRleCA9IGk7XHJcbiAgICAgICAgICAgICAgICAgICAgbWF4ID0gYXJyW2ldO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gbWF4SW5kZXg7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAkc2NvcGUuc2hvd0FjdGl2aXRpZXNPbkhvbWVQYWdlID0gZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgJHNjb3BlLmdldE1vc3RSZWNlbnRBY3Rpdml0aWVzKCk7XHJcbiAgICAgICAgICAgICRzY29wZS5nZXRNb3N0UG9wdWxhckFjdGl2aXRpZXMoKTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAkc2NvcGUuZ2V0TW9zdFJlY2VudEFjdGl2aXRpZXMgPSBmdW5jdGlvbiAoKSB7XHJcblxyXG4gICAgICAgICAgICBkYlNlcnZpY2UuZ2V0Q29sbGVjdGlvbignYWN0aXZpdGllcycpLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgbnVtYmVyT2ZBY3Rpdml0aWVzID0gMztcclxuICAgICAgICAgICAgICAgIHZhciBhcnJUZW1wID0gcmVzcG9uc2UuYWN0aXZpdGllbGlzdDtcclxuICAgICAgICAgICAgICAgIHZhciBhcnJBbGxBY3Rpdml0aWVzID0gW107XHJcblxyXG5cclxuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gYXJyVGVtcC5sZW5ndGg7IGkgPCBsOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAobmV3IERhdGUoYXJyVGVtcFtpXS51bnRpbERhdGUpLmdldFRpbWUoKSA+PSBuZXcgRGF0ZShkYXRlVGltZU5vdykuZ2V0VGltZSgpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKG5ldyBEYXRlKGFyclRlbXBbaV0udW50aWxEYXRlKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFyckFsbEFjdGl2aXRpZXMucHVzaChhcnJUZW1wW2ldKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgYXJyQWxsQWN0aXZpdGllcy5zb3J0KHJlY2VudEZpcnN0KTtcclxuXHJcbiAgICAgICAgICAgICAgICB2YXIgYXJyTW9zdFJlY2VudEFjdGl2aXRpZXMgPSBbXTtcclxuXHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpaSA9IDA7IGlpIDwgbnVtYmVyT2ZBY3Rpdml0aWVzOyBpaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYXJyTW9zdFJlY2VudEFjdGl2aXRpZXMucHVzaChhcnJBbGxBY3Rpdml0aWVzW2lpXSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgdmFyIG1hdGNoZXMgPSBbXTtcclxuXHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpaWkgPSAwOyBpaWkgPCBhcnJNb3N0UmVjZW50QWN0aXZpdGllcy5sZW5ndGg7IGlpaSsrKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBkdW1teUFjdGl2aXR5ID0gbmV3IEFjdGl2aXR5KFwiTm8gbmFtZVwiLCA4NTAwLCBcIlRvZ2V0aGVyXCIsIDIsIFwibm8gZGVzY3JpcHRpb25cIiwgXCIyMDE2LTAxLTAxIDAwOjAxXCIsIFwiMjAxNy0xMi0zMSAyMzo1OVwiLCBuZXcgRGF0ZSgpLCBcIm5vIHVzZXJuYW1lXCIsIG1hdGNoZXMpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChhcnJNb3N0UmVjZW50QWN0aXZpdGllc1tpaWldID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXJyTW9zdFJlY2VudEFjdGl2aXRpZXMuc3BsaWNlKGlpaSwgMSwgZHVtbXlBY3Rpdml0eSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgJHNjb3BlLmFyck1vc3RSZWNlbnRBY3Rpdml0aWVzID0gYXJyTW9zdFJlY2VudEFjdGl2aXRpZXM7XHJcblxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAkc2NvcGUuZ2V0TW9zdFBvcHVsYXJBY3Rpdml0aWVzID0gZnVuY3Rpb24oKXtcclxuXHJcbiAgICAgICAgICAgIGRiU2VydmljZS5nZXRDb2xsZWN0aW9uKCdhY3Rpdml0aWVzJykudGhlbihmdW5jdGlvbihyZXNwb25zZSl7XHJcblxyXG4gICAgICAgICAgICAgICAgdmFyIG51bWJlck9mQWN0aXZpdGllcyA9IDM7XHJcbiAgICAgICAgICAgICAgICB2YXIgYXJyVGVtcCA9IHJlc3BvbnNlLmFjdGl2aXRpZWxpc3Q7XHJcbiAgICAgICAgICAgICAgICB2YXIgYXJyQWxsQWN0aXZpdGllcyA9IFtdO1xyXG5cclxuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gYXJyVGVtcC5sZW5ndGg7IGkgPCBsOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICBpZihuZXcgRGF0ZShhcnJUZW1wW2ldLnVudGlsRGF0ZSkuZ2V0VGltZSgpID49IG5ldyBEYXRlKGRhdGVUaW1lTm93KS5nZXRUaW1lKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhuZXcgRGF0ZShhcnJUZW1wW2ldLnVudGlsRGF0ZSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhcnJBbGxBY3Rpdml0aWVzLnB1c2goYXJyVGVtcFtpXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHZhciBhcnJNb3N0UG9wdWxhckFjdGl2aXRpZXMgPSBbXTtcclxuXHJcbiAgICAgICAgICAgICAgICBmb3IodmFyIGogPSAwOyBqIDwgbnVtYmVyT2ZBY3Rpdml0aWVzOyBqKyspe1xyXG5cclxuICAgICAgICAgICAgICAgICAgICB2YXIgaW5kZXhNb3N0UG9wID0gcG9wdWxhckZpcnN0KGFyckFsbEFjdGl2aXRpZXMpO1xyXG4gICAgICAgICAgICAgICAgICAgIGFyck1vc3RQb3B1bGFyQWN0aXZpdGllcy5wdXNoKGFyckFsbEFjdGl2aXRpZXNbaW5kZXhNb3N0UG9wXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYXJyQWxsQWN0aXZpdGllcy5zcGxpY2UoaW5kZXhNb3N0UG9wLCAxKTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICB2YXIgbWF0Y2hlcyA9IFtdO1xyXG5cclxuICAgICAgICAgICAgICAgIGZvciAodmFyIGlpaSA9IDA7IGlpaSA8IGFyck1vc3RQb3B1bGFyQWN0aXZpdGllcy5sZW5ndGg7IGlpaSsrKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBkdW1teUFjdGl2aXR5ID0gbmV3IEFjdGl2aXR5KFwiTm8gbmFtZVwiLCA4NTAwLCBcIlRvZ2V0aGVyXCIsIDIsIFwibm8gZGVzY3JpcHRpb25cIiwgXCIyMDE2LTAxLTAxIDAwOjAxXCIsIFwiMjAxNy0xMi0zMSAyMzo1OVwiLCBuZXcgRGF0ZSgpLCBcIm5vIHVzZXJuYW1lXCIsIG1hdGNoZXMpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChhcnJNb3N0UG9wdWxhckFjdGl2aXRpZXNbaWlpXSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFyck1vc3RQb3B1bGFyQWN0aXZpdGllcy5zcGxpY2UoaWlpLCAxLCBkdW1teUFjdGl2aXR5KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgJHNjb3BlLmFyck1vc3RQb3B1bGFyQWN0aXZpdGllcyA9IGFyck1vc3RQb3B1bGFyQWN0aXZpdGllcztcclxuXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgJHNjb3BlLmRlbGV0ZUFjdGl2aXR5ID0gZnVuY3Rpb24oYWN0aXZpdHlJZCl7XHJcbiAgICAgICAgICAgIGRiU2VydmljZS5kZWxldGVBY3Rpdml0eSgnYWN0aXZpdGllcycsIGFjdGl2aXR5SWQpLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2Upe1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLmluZm9kZWxldGVkQWN0aXZpdHkgPSByZXNwb25zZTtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlc3BvbnNlKTtcclxuICAgICAgICAgICAgICAgICRzY29wZS5nZXRBY3Rpdml0aWVzKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG5cclxuICAgICAgICBmdW5jdGlvbiBpbml0bWFwKCl7XHJcbiAgICAgICAgICAgIHZhciBtYXAgPSBuZXcgZ29vZ2xlLm1hcHMuTWFwKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYXAnKSwge1xyXG4gICAgICAgICAgICAgICAgem9vbTogOCxcclxuICAgICAgICAgICAgICAgIGNlbnRlcjoge2xhdDogNTAuODE5NDg5NCwgbG5nOiAzLjI1NzcwNzZ9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB2YXIgZ2VvY29kZXIgPSBuZXcgZ29vZ2xlLm1hcHMuR2VvY29kZXIoKTtcclxuXHJcbiAgICAgICAgICAgIGdlb2NvZGVBZGRyZXNzKGdlb2NvZGVyLCBtYXApO1xyXG5cclxuICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICBmdW5jdGlvbiBnZW9jb2RlQWRkcmVzcyhnZW9jb2RlciwgcmVzdWx0c01hcCkge1xyXG4gICAgICAgICAgICB2YXIgc3RyZWV0ID0gJHNjb3BlLmFyckRldGFpbHNBY3Rpdml0eS5zdHJlZXQ7XHJcbiAgICAgICAgICAgIHZhciBudW1iZXIgPSAkc2NvcGUuYXJyRGV0YWlsc0FjdGl2aXR5Lm51bWJlcjtcclxuICAgICAgICAgICAgdmFyIHppcGNvZGUgPSAkc2NvcGUuYXJyRGV0YWlsc0FjdGl2aXR5LnppcGNvZGU7XHJcblxyXG4gICAgICAgICAgICB2YXIgYWRkcmVzcyA9IHN0cmVldCArIFwiIFwiICsgbnVtYmVyICsgXCIsIFwiICsgemlwY29kZTsgLy9oaWVyIGFkZHJlc3MgdWl0IGRiIGluc3RvcHBlblxyXG5cclxuICAgICAgICAgICAgZ2VvY29kZXIuZ2VvY29kZSh7J2FkZHJlc3MnOiBhZGRyZXNzfSwgZnVuY3Rpb24gKHJlc3VsdHMsIHN0YXR1cykge1xyXG4gICAgICAgICAgICAgICAgaWYgKHN0YXR1cyA9PT0gZ29vZ2xlLm1hcHMuR2VvY29kZXJTdGF0dXMuT0spIHtcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHRzTWFwLnNldENlbnRlcihyZXN1bHRzWzBdLmdlb21ldHJ5LmxvY2F0aW9uKTtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgaW1hZ2UgPSBcIi4uLy4uL2ltYWdlcy9tYXJrZXIucG5nXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIG1hcmtlciA9IG5ldyBnb29nbGUubWFwcy5NYXJrZXIoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtYXA6IHJlc3VsdHNNYXAsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiByZXN1bHRzWzBdLmdlb21ldHJ5LmxvY2F0aW9uLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpY29uOiBpbWFnZVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhtYXJrZXIpO1xyXG5cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYWxlcnQoJ0dlb2NvZGUgd2FzIG5vdCBzdWNjZXNzZnVsIGZvciB0aGUgZm9sbG93aW5nIHJlYXNvbjogJyArIHN0YXR1cyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZnVuY3Rpb24gcmVzZXRGb3JtKCkge1xyXG4gICAgICAgICAgICB2YXIgZnJtID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeU5hbWUoJ0FjdGl2aXR5Rm9ybScpWzBdO1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnamUga29tdCBpbiBkZSByZXNldGZvcm0nKTtcclxuICAgICAgICAgICAgZnJtLnJlc2V0KCk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBhbmd1bGFyLm1vZHVsZShcImFwcFwiKS5jb250cm9sbGVyKFwiQWN0aXZpdGllc0NvbnRyb2xsZXJcIiwgW1wiJHNjb3BlXCIsIFwiZGJTZXJ2aWNlXCIsIFwiJGh0dHBcIiwgXCIkbG9jYXRpb25cIiwgXCIkcm91dGVQYXJhbXNcIiwgXCJmaWxlVXBsb2FkXCIsIEFjdGl2aXRpZXNDb250cm9sbGVyXSk7XHJcblxyXG5cclxufSkoKTsiLCIvKipcclxuICogQ3JlYXRlZCBieSBOaWtpdGEgb24gNy8wMS8yMDE2LlxyXG4gKi9cclxuKGZ1bmN0aW9uICgpIHtcclxuXHJcbiAgICBcInVzZSBzdHJpY3RcIjtcclxuXHJcbiAgICB2YXIgQ2hhdENvbnRyb2xsZXIgPSBmdW5jdGlvbigkc2NvcGUsICRyb290U2NvcGUsICRyb3V0ZVBhcmFtcywgZGJTZXJ2aWNlLCAkaHR0cCkge1xyXG5cclxuICAgICAgICBjb25zb2xlLmxvZygkcm9vdFNjb3BlLmN1cnJlbnRVc2VyLnVzZXJuYW1lKTtcclxuICAgICAgICBjb25zb2xlLmxvZygkcm9vdFNjb3BlLmNvbnRhY3RlZFVzZXIudXNlcm5hbWUpO1xyXG4gICAgICAgIC8vJHNjb3BlLmNvbnRhY3RlZFVzZXIudXNlcm5hbWUgPSAkcm9vdFNjb3BlLmNvbnRhY3RlZFVzZXIudXNlcm5hbWU7XHJcblxyXG4gICAgICAgICRzY29wZS5pbml0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBjaGF0U2VydmljZS5lbWl0KFwiaW5pdF91c2Vyc1wiLHt1c2VyOiRyb290U2NvcGUuY3VycmVudFVzZXIsIGNvbGxlY3Rpb246XCJ1c2Vyc1wifSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICB9O1xyXG4gICAgYW5ndWxhci5tb2R1bGUoXCJhcHBcIikuY29udHJvbGxlcihcIkNoYXRDb250cm9sbGVyXCIsIFtcIiRzY29wZVwiLCBcIiRyb290U2NvcGVcIiwgXCIkcm91dGVQYXJhbXNcIiwgXCJkYlNlcnZpY2VcIixcIiRodHRwXCIsIENoYXRDb250cm9sbGVyXSk7XHJcblxyXG59KSgpOyIsIi8qKlxyXG4gKiBDcmVhdGVkIGJ5IGltYW4gb24gNS8xMi8xNS5cclxuICovXHJcblxyXG4oZnVuY3Rpb24oKXtcclxuXHJcbiAgICBcInVzZSBzdHJpY3RcIjtcclxuXHJcbiAgICB2YXIgTWF0Y2hlc0NvbnRyb2xsZXIgPSBmdW5jdGlvbigkc2NvcGUsIGRiU2VydmljZSkge1xyXG5cclxuICAgICAgICB2YXIgY2xpY2tzT25CdG4gPSAwO1xyXG5cclxuICAgICAgICAkc2NvcGUuc2hvd0RpdiA9IGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgICRzY29wZS5maWx0ZXIgPSB7c2hvd0ZpbHRlcjp0cnVlfTtcclxuICAgICAgICAgICAgY2xpY2tzT25CdG4rKztcclxuXHJcbiAgICAgICAgICAgIGlmKGNsaWNrc09uQnRuID4gMSl7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUuZmlsdGVyID0ge3Nob3dGaWx0ZXI6ZmFsc2V9O1xyXG4gICAgICAgICAgICAgICAgY2xpY2tzT25CdG4gPSAwO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgJHNjb3BlLmhpZGVEaXYgPSBmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICBjbGlja3NPbkJ0biA9IDA7XHJcbiAgICAgICAgICAgICRzY29wZS5maWx0ZXIgPSB7c2hvd0ZpbHRlcjpmYWxzZX07XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgJHNjb3BlLnNvcnRQcm9wZXJ0eSA9IFwidGl0bGVcIjtcclxuICAgICAgICAkc2NvcGUuZmlsdGVyUXVlcnkgPSBcIlwiO1xyXG4gICAgICAgICRzY29wZS5maWx0ZXJNYXRjaGVzID0gZnVuY3Rpb24oaSl7XHJcbiAgICAgICAgICAgIGlmKCRzY29wZS5maWx0ZXJRdWVyeSA9PT0gXCJcIil7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLypcclxuICAgICAgICAgICAgIGVsc2UgaWYoaS51c2VybmFtZS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoJHNjb3BlLmZpbHRlclF1ZXJ5LnRvTG9jYWxlTG93ZXJDYXNlKCkpID49IDApe1xyXG4gICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAqL1xyXG5cclxuICAgICAgICAgICAgZWxzZSBpZihpLnNleCA9PT0gdW5kZWZpbmVkKXtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgZWxzZSBpZigkc2NvcGUuZmlsdGVyUXVlcnkudG9Mb3dlckNhc2UoKSA9PSBpLnNleC50b0xvd2VyQ2FzZSgpKXtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBlbHNlIGlmKCRzY29wZS5maWx0ZXJRdWVyeS50b0xvd2VyQ2FzZSgpID09PSBcIm5vZmlsdGVyXCIpe1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLmZpbHRlclF1ZXJ5ID0gXCJcIjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8vaHR0cDovL3d3dy5mYWxzZXBvc2l0aXZlcy5jb20vaW5kZXgucGhwLzIwMDkvMTIvMDEvamF2YXNjcmlwdC1mdW5jdGlvbi10by1nZXQtdGhlLWludGVyc2VjdC1vZi0yLWFycmF5cy9cclxuICAgICAgICAkc2NvcGUuaW50ZXJzZWN0ID0gZnVuY3Rpb24oYXJyMSwgYXJyMilcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHZhciByID0gW10sIG8gPSB7fSwgbCA9IGFycjIubGVuZ3RoLCBpLCB2O1xyXG4gICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBvW2FycjJbaV1dID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBsID0gYXJyMS5sZW5ndGg7XHJcbiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIHYgPSBhcnIxW2ldO1xyXG4gICAgICAgICAgICAgICAgaWYgKHYgaW4gbykge1xyXG4gICAgICAgICAgICAgICAgICAgIHIucHVzaCh2KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHI7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgJHNjb3BlLnNob3dNYXRjaGVzID0gZnVuY3Rpb24oKXtcclxuXHJcbiAgICAgICAgICAgIC8qXHJcbiAgICAgICAgICAgICB2YXIgdXNlcm5hbWUgPSBcIlwiO1xyXG4gICAgICAgICAgICAgaWYoJHJvb3RTY29wZS51c2VyLnVzZXJuYW1lICE9PSB1bmRlZmluZWQpe1xyXG4gICAgICAgICAgICAgdXNlcm5hbWUgPSAkcm9vdFNjb3BlLnVzZXIudXNlcm5hbWU7XHJcbiAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAqL1xyXG5cclxuICAgICAgICAgICAgdmFyIHVzZXJuYW1lO1xyXG5cclxuICAgICAgICAgICAgdXNlcm5hbWUgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShcInVzZXJuYW1lXCIpO1xyXG5cclxuICAgICAgICAgICAgZGJTZXJ2aWNlLmdldENvbGxlY3Rpb24oJ3VzZXJzJykudGhlbihmdW5jdGlvbihyZXNwb25zZSl7XHJcblxyXG4gICAgICAgICAgICAgICAgdmFyIGFyclByb2ZpbGVzID0gcmVzcG9uc2UudXNlcmxpc3Q7XHJcbiAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgYXJyUHJvZmlsZXMubGVuZ3RoOyBpKyspe1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKGFyclByb2ZpbGVzW2ldLnVzZXJuYW1lID09PSB1c2VybmFtZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhcnJQcm9maWxlcy5zcGxpY2UoaSwgMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZm9yKHZhciBpaSA9IDA7IGlpIDwgYXJyUHJvZmlsZXMubGVuZ3RoOyBpaSsrKXtcclxuICAgICAgICAgICAgICAgICAgICBpZihhcnJQcm9maWxlc1tpaV0udXNlcm5hbWUgPT09IFwiYWRtaW5cIikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhcnJQcm9maWxlcy5zcGxpY2UoaWksIDEpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgICAgICAgICAgZGJTZXJ2aWNlLmdldEl0ZW0odXNlcm5hbWUpLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2Upe1xyXG5cclxuICAgICAgICAgICAgICAgICAgICB2YXIgdXNlciA9IHJlc3BvbnNlO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBhcnJNYXRjaGVzID0gW107XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHVzZXIuaW50ZXJlc3RzKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBpPTAsIGw9YXJyUHJvZmlsZXMubGVuZ3RoOyBpPGw7IGkrKyl7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2FtZUludGVyZXN0cyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzYW1lSW50ZXJlc3RzID0gJHNjb3BlLmludGVyc2VjdCh1c2VyLmludGVyZXN0cywgYXJyUHJvZmlsZXNbaV0uaW50ZXJlc3RzKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHNhbWVJbnRlcmVzdHMubGVuZ3RoICE9PSAwKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGFyclByb2ZpbGVzW2ldLmRlbGV0ZWQgPT09IGZhbHNlKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcnJNYXRjaGVzLnB1c2goYXJyUHJvZmlsZXNbaV0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICRzY29wZS5hcnJNYXRjaGVzID0gYXJyTWF0Y2hlcztcclxuXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICB9O1xyXG5cclxuICAgIGFuZ3VsYXIubW9kdWxlKFwiYXBwXCIpLmNvbnRyb2xsZXIoXCJNYXRjaGVzQ29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgXCJkYlNlcnZpY2VcIiwgTWF0Y2hlc0NvbnRyb2xsZXJdKTtcclxuXHJcbn0pKCk7IiwiLyoqXHJcbiAqIENyZWF0ZWQgYnkgaW1hbiBvbiAyMC8xMi8xNS5cclxuICovXHJcblxyXG5cclxuKGZ1bmN0aW9uKCl7XHJcblxyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4gICAgdmFyIFByb2ZpbGVzQ29udHJvbGxlciA9IGZ1bmN0aW9uKCRzY29wZSwgJHJvb3RTY29wZSwgJHJvdXRlUGFyYW1zLCBkYlNlcnZpY2UsICRodHRwLCAkbG9jYXRpb24pIHtcclxuXHJcbiAgICAgICAgdmFyIGNsaWNrc09uQnRuID0gMDtcclxuICAgICAgICAkc2NvcGUuc3RhcnRDaGF0ID0gZnVuY3Rpb24oY3VycmVudFVzZXIsIGNvbnRhY3RlZFVzZXIpe1xyXG4gICAgICAgICAgICAkaHR0cC5wb3N0KFwiL2NoYXRcIiwge1xyXG4gICAgICAgICAgICAgICAgY3VycmVudFVzZXI6IGN1cnJlbnRVc2VyLFxyXG4gICAgICAgICAgICAgICAgY29udGFjdGVkVXNlcjpjb250YWN0ZWRVc2VyXHJcblxyXG4gICAgICAgICAgICB9KS5zdWNjZXNzKGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUuZXJyb3IgPSBkYXRhLmVycm9yO1xyXG4gICAgICAgICAgICAgICAgJHJvb3RTY29wZS5jdXJyZW50VXNlciA9IGRhdGEuY3VycmVudFVzZXI7XHJcbiAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLmNvbnRhY3RlZFVzZXIgPSBkYXRhLmNvbnRhY3RlZFVzZXI7XHJcblxyXG4gICAgICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oXCJjdXJyZW50dXNlcm5hbWVcIiwgJHJvb3RTY29wZS5jdXJyZW50VXNlci51c2VybmFtZSk7XHJcbiAgICAgICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShcImNvbnRhY3RlZHVzZXJuYW1lXCIsICRyb290U2NvcGUuY29udGFjdGVkVXNlci51c2VybmFtZSk7XHJcblxyXG4gICAgICAgICAgICAgICAgJGxvY2F0aW9uLnBhdGgoZGF0YS5yZWRpcmVjdCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG5cclxuXHJcbiAgICAgICAgJHNjb3BlLnNob3dEaXYgPSBmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICAkc2NvcGUuZmlsdGVyID0ge3Nob3dGaWx0ZXI6dHJ1ZX07XHJcbiAgICAgICAgICAgIGNsaWNrc09uQnRuKys7XHJcblxyXG4gICAgICAgICAgICBpZihjbGlja3NPbkJ0biA+IDEpe1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLmZpbHRlciA9IHtzaG93RmlsdGVyOmZhbHNlfTtcclxuICAgICAgICAgICAgICAgIGNsaWNrc09uQnRuID0gMDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgICRzY29wZS5oaWRlRGl2ID0gZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgY2xpY2tzT25CdG4gPSAwO1xyXG4gICAgICAgICAgICAkc2NvcGUuZmlsdGVyID0ge3Nob3dGaWx0ZXI6ZmFsc2V9O1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgICRzY29wZS5zaG93UHJvZmlsZXMgPSBmdW5jdGlvbigpe1xyXG5cclxuICAgICAgICAgICAgLypcclxuICAgICAgICAgICAgdmFyIHVzZXJuYW1lID0gXCJcIjtcclxuICAgICAgICAgICAgaWYoJHJvb3RTY29wZS51c2VyLnVzZXJuYW1lICE9PSB1bmRlZmluZWQpe1xyXG4gICAgICAgICAgICAgICAgdXNlcm5hbWUgPSAkcm9vdFNjb3BlLnVzZXIudXNlcm5hbWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgKi9cclxuICAgICAgICAgICAgdmFyIHVzZXJuYW1lID0gXCJcIjtcclxuICAgICAgICAgICAgdXNlcm5hbWUgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShcInVzZXJuYW1lXCIpO1xyXG5cclxuICAgICAgICAgICAgZGJTZXJ2aWNlLmdldENvbGxlY3Rpb24oJ3VzZXJzJykudGhlbihmdW5jdGlvbihyZXNwb25zZSl7XHJcblxyXG4gICAgICAgICAgICAgICAgdmFyIGFyclByb2ZpbGVzID0gcmVzcG9uc2UudXNlcmxpc3Q7XHJcbiAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgYXJyUHJvZmlsZXMubGVuZ3RoOyBpKyspe1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKGFyclByb2ZpbGVzW2ldLnVzZXJuYW1lID09PSB1c2VybmFtZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhcnJQcm9maWxlcy5zcGxpY2UoaSwgMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZm9yKHZhciBpaSA9IDA7IGlpIDwgYXJyUHJvZmlsZXMubGVuZ3RoOyBpaSsrKXtcclxuICAgICAgICAgICAgICAgICAgICBpZihhcnJQcm9maWxlc1tpaV0udXNlcm5hbWUgPT09IFwiYWRtaW5cIikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhcnJQcm9maWxlcy5zcGxpY2UoaWksIDEpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICRzY29wZS5hcnJQcm9maWxlcyA9IGFyclByb2ZpbGVzO1xyXG5cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgICRzY29wZS5zb3J0UHJvcGVydHkgPSBcInRpdGxlXCI7XHJcbiAgICAgICAgJHNjb3BlLmZpbHRlclF1ZXJ5ID0gXCJcIjtcclxuICAgICAgICAkc2NvcGUuZmlsdGVyUHJvZmlsZXMgPSBmdW5jdGlvbihpKXtcclxuICAgICAgICAgICAgaWYoJHNjb3BlLmZpbHRlclF1ZXJ5ID09PSBcIlwiKXtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvKlxyXG4gICAgICAgICAgICAgZWxzZSBpZihpLnVzZXJuYW1lLnRvTG93ZXJDYXNlKCkuaW5kZXhPZigkc2NvcGUuZmlsdGVyUXVlcnkudG9Mb2NhbGVMb3dlckNhc2UoKSkgPj0gMCl7XHJcbiAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICovXHJcblxyXG4gICAgICAgICAgICBlbHNlIGlmKGkuc2V4ID09PSB1bmRlZmluZWQpe1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBlbHNlIGlmKCRzY29wZS5maWx0ZXJRdWVyeS50b0xvd2VyQ2FzZSgpID09IGkuc2V4LnRvTG93ZXJDYXNlKCkpe1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGVsc2UgaWYoJHNjb3BlLmZpbHRlclF1ZXJ5LnRvTG93ZXJDYXNlKCkgPT09IFwibm9maWx0ZXJcIil7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUuZmlsdGVyUXVlcnkgPSBcIlwiO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfTtcclxuICAgIH07XHJcblxyXG4gICAgYW5ndWxhci5tb2R1bGUoXCJhcHBcIikuY29udHJvbGxlcihcIlByb2ZpbGVzQ29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgXCIkcm9vdFNjb3BlXCIsIFwiJHJvdXRlUGFyYW1zXCIsIFwiZGJTZXJ2aWNlXCIsXCIkaHR0cFwiLCBcIiRsb2NhdGlvblwiLCBQcm9maWxlc0NvbnRyb2xsZXJdKTtcclxuXHJcbn0pKCk7IiwiLyoqXHJcbiAqIENyZWF0ZWQgYnkgaW1hbiBvbiAyMC8xMi8xNS5cclxuICovXHJcbihmdW5jdGlvbigpe1xyXG5cclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG5cclxuICAgIHZhciBVc2Vyc0NvbnRyb2xsZXIgPSBmdW5jdGlvbigkc2NvcGUsICRyb3V0ZVBhcmFtcywgJGh0dHAsIGRiU2VydmljZSkge1xyXG5cclxuICAgICAgICAkc2NvcGUuZ2V0VXNlcnMgPSBmdW5jdGlvbigpe1xyXG5cclxuICAgICAgICAgICAgZGJTZXJ2aWNlLmdldENvbGxlY3Rpb24oJ3VzZXJzJykudGhlbihmdW5jdGlvbihyZXNwb25zZSl7XHJcblxyXG4gICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhyZXNwb25zZSk7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUuYXJyVXNlcnMgPSByZXNwb25zZS51c2VybGlzdDtcclxuXHJcbiAgICAgICAgICAgICAgICBmb3IoIHZhciBpID0gMDsgaTwkc2NvcGUuYXJyVXNlcnMubGVuZ3RoOyBpKyspe1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZigkc2NvcGUuYXJyVXNlcnNbaV0uZGVsZXRlZCA9PT0gZmFsc2Upe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuZGVsZXRlZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmRlbGV0ZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcblxyXG5cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgJHNjb3BlLmdldERldGFpbFVzZXIgPSBmdW5jdGlvbigpe1xyXG5cclxuICAgICAgICAgICAgZGJTZXJ2aWNlLmdldERldGFpbHNVc2VyKCd1c2VycycsICRyb3V0ZVBhcmFtcy51c2VybmFtZSkudGhlbihmdW5jdGlvbihyZXNwb25zZSl7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUudXNlckRldGFpbHMgPSByZXNwb25zZS5jb3JyZWN0dXNlcjtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgJHNjb3BlLmRlbGV0ZVVzZXIgPSBmdW5jdGlvbih1c2VybmFtZSl7XHJcbiAgICAgICAgICAgIGRiU2VydmljZS5kZWxldGVVc2VyKCd1c2VycycsIHVzZXJuYW1lKS50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKXtcclxuICAgICAgICAgICAgICAgICRzY29wZS5pbmZvZGVsZXRlZFVzZXIgPSByZXNwb25zZTtcclxuICAgICAgICAgICAgICAgICRzY29wZS5nZXRVc2VycygpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAkc2NvcGUudXBkYXRlVXNlciA9IGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgIC8qZGJTZXJ2aWNlLnVwZGF0ZVVzZXIoJ3VzZXJzJykudGhlbihmdW5jdGlvbihyZXNwb25zZSl7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUudXBkYXRldXNlciA9IHJlc3BvbnNlO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2cocmVzcG9uc2UpO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJnZWx1a3RcIik7XHJcblxyXG4gICAgICAgICAgICB9KSovXHJcblxyXG4gICAgICAgICAgICB2YXIgIHVzZXJuYW1lID0gICRzY29wZS51c2VyLnVzZXJuYW1lLFxyXG4gICAgICAgICAgICAgICAgcGFzc3dvcmQgPSAkc2NvcGUudXNlci5wYXNzd29yZCxcclxuICAgICAgICAgICAgICAgIGJpcnRoZGF0ZSA9ICRzY29wZS51c2VyLmJpcnRoZGF0ZSxcclxuICAgICAgICAgICAgICAgIHppcGNvZGUgPSAkc2NvcGUudXNlci56aXBjb2RlLFxyXG4gICAgICAgICAgICAgICAgc2V4ID0gJHNjb3BlLnVzZXIuc2V4LFxyXG4gICAgICAgICAgICAgICAgYmlvZ3JhcGh5ID0gJHNjb3BlLnVzZXIuYmlvZ3JhcGh5O1xyXG5cclxuICAgICAgICAgICAgdmFyIHVybCA9IFwiaHR0cDovL2xvY2FsaG9zdDozMDAwL2FwaS91c2Vycy91cGRhdGVwcm9maWxlXCI7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKHVybCk7XHJcbiAgICAgICAgICAgICRodHRwLnBvc3QodXJsLCB7XHJcbiAgICAgICAgICAgICAgICB1c2VybmFtZSA6IHVzZXJuYW1lLFxyXG4gICAgICAgICAgICAgICAgcGFzc3dvcmQgOiBwYXNzd29yZCxcclxuICAgICAgICAgICAgICAgIGJpcnRoZGF0ZSA6IGJpcnRoZGF0ZSxcclxuICAgICAgICAgICAgICAgIHppcGNvZGUgOiB6aXBjb2RlLFxyXG4gICAgICAgICAgICAgICAgc2V4IDogc2V4LFxyXG4gICAgICAgICAgICAgICAgYmlvZ3JhcGh5IDpiaW9ncmFwaHlcclxuXHJcbiAgICAgICAgICAgIH0pLnN1Y2Nlc3MoZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAgICAgICAgICRzY29wZS5lcnJvciA9IGRhdGEuZXJyb3I7XHJcblxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCRzY29wZS51c2VyLnVzZXJuYW1lLCAkc2NvcGUudXNlci5wYXNzd29yZCwgJHNjb3BlLnVzZXIuYmlydGhkYXRlLCAkc2NvcGUudXNlci56aXBjb2RlLCAkc2NvcGUudXNlci5zZXgsICRzY29wZS51c2VyLmJpb2dyYXBoeSk7XHJcblxyXG5cclxuXHJcblxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgICRzY29wZS5nZXRVc2VyQnlJRCA9IGZ1bmN0aW9uKCl7XHJcblxyXG4gICAgICAgICAgICBkYlNlcnZpY2UuZ2V0SXRlbSgndXNlcicpLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2Upe1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2cocmVzcG9uc2UpO1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLnVzZXJQcm9maWxlID0gcmVzcG9uc2U7XHJcblxyXG4gICAgICAgICAgICB9KTtcclxuXHJcblxyXG4gICAgICAgIH07XHJcblxyXG5cclxuICAgIH07XHJcblxyXG4gICAgYW5ndWxhci5tb2R1bGUoXCJhcHBcIikuY29udHJvbGxlcihcIlVzZXJzQ29udHJvbGxlclwiLCBbXCIkc2NvcGVcIixcIiRyb3V0ZVBhcmFtc1wiLCBcIiRodHRwXCIsIFwiZGJTZXJ2aWNlXCIsIFVzZXJzQ29udHJvbGxlcl0pO1xyXG5cclxufSkoKTsiLCIvKipcclxuICogQ3JlYXRlZCBieSBNYXJ0aGUgb24gMTUvMTIvMTUuXHJcbiAqL1xyXG4oZnVuY3Rpb24oKXtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG4gICAgdmFyIHNlbGVjdGVkSW50ZXJlc3QgPSBbXTtcclxuXHJcbiAgICB2YXIgbG9naW5Db250cm9sbGVyID0gZnVuY3Rpb24gKCRzY29wZSwgJHJvb3RTY29wZSwgJGh0dHAsICRsb2NhdGlvbikge1xyXG5cclxuICAgICAgICAkc2NvcGUubG9naW4gPSBmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgJGh0dHBcclxuICAgICAgICAgICAgICAgIC5wb3N0KCcvbG9naW4nLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWU6IHRoaXMudXNlcm5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgcGFzc3dvcmQ6IHRoaXMucGFzc3dvcmRcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAuc3VjY2VzcyhmdW5jdGlvbihkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS51c2VyID0gZGF0YS51c2VyO1xyXG4gICAgICAgICAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFwidXNlcm5hbWVcIiwgJHJvb3RTY29wZS51c2VyLnVzZXJuYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICAkc2NvcGUuZXJyb3IgPSBkYXRhLmVycm9yO1xyXG4gICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbi5wYXRoKGRhdGEucmVkaXJlY3QpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgJHNjb3BlLmludGVyZXN0cyA9IFsnSmF6eicsICdIaXBob3AnLCAnTmV3IHdhdmUnLCAnVHJhdmVsaW5nJywnUGFydHknXTtcclxuICAgICAgICAkc2NvcGUubHN0ID0gW107XHJcbiAgICAgICAgJHNjb3BlLmNoYW5nZSA9IGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgICRzY29wZS5sc3QucHVzaCgnMicpO1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygkc2NvcGUubHN0KTtcclxuICAgICAgICB9O1xyXG4gICAgICAgICRzY29wZS5zdGF0ZUNoYW5nZWQgPSBmdW5jdGlvbiAocUlkKSB7XHJcbiAgICAgICAgICAgIC8vaWYoISRzY29wZS5pbnRlcmVzdHNbcUlkXSl7IC8vSWYgaXQgaXMgY2hlY2tlZFxyXG4gICAgICAgICAgICBpZihzZWxlY3RlZEludGVyZXN0LmluZGV4T2YocUlkKSAhPT0gLTEpIHtcclxuICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coJ2FydE5yIGFscmVhZHkgZXhpc3RzISBERUxFVEUnKTtcclxuICAgICAgICAgICAgICAgIHZhciBpbmRleCA9IHNlbGVjdGVkSW50ZXJlc3QuaW5kZXhPZihxSWQpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGluZGV4ID4gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZEludGVyZXN0LnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgc2VsZWN0ZWRJbnRlcmVzdC5wdXNoKHFJZCk7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhzZWxlY3RlZEludGVyZXN0KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgJHNjb3BlLmdlb2xvY2F0aW9uID0gXCJcIjtcclxuICAgICAgICAkc2NvcGUuZ2V0TG9jYXRpb24gPSBmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICBpZiAobmF2aWdhdG9yLmdlb2xvY2F0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICBuYXZpZ2F0b3IuZ2VvbG9jYXRpb24uZ2V0Q3VycmVudFBvc2l0aW9uKHN1Y2Nlc3NDYWxsYmFjaywgZXJyb3JDYWxsYmFjaywge21heGltdW1BZ2U6NjAwMDAwfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUuZXJyb3IgPSBcIkdlb2xvY2F0aW9uIGlzIG5vdCBzdXBwb3J0ZWQgYnkgdGhpcyBicm93c2VyLlwiO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIHN1Y2Nlc3NDYWxsYmFjayhwb3NpdGlvbikge1xyXG4gICAgICAgICAgICAgICAgLy8gQnkgdXNpbmcgdGhlICdtYXhpbXVtQWdlJyBvcHRpb24gYWJvdmUsIHRoZSBwb3NpdGlvblxyXG4gICAgICAgICAgICAgICAgLy8gb2JqZWN0IGlzIGd1YXJhbnRlZWQgdG8gYmUgYXQgbW9zdCAxMCBtaW51dGVzIG9sZC5cclxuICAgICAgICAgICAgICAgICRzY29wZS5nZW9sb2NhdGlvbiA9ICB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGF0aXR1ZGU6IHBvc2l0aW9uLmNvb3Jkcy5sYXRpdHVkZSxcclxuICAgICAgICAgICAgICAgICAgICBsb25naXR1ZGU6IHBvc2l0aW9uLmNvb3Jkcy5sYXRpdHVkZVxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCRzY29wZS5nZW9sb2NhdGlvbik7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIGVycm9yQ2FsbGJhY2soZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBhIGRpdiBlbGVtZW50IHdpdGggZXJyb3IubWVzc2FnZS5cclxuICAgICAgICAgICAgICAgICRzY29wZS5nZW9sb2NhdGlvbiA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKGVycm9yLmNvZGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIGVycm9yLlBFUk1JU1NJT05fREVOSUVEOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuZXJyb3IgPSBcIlVzZXIgZGVuaWVkIHRoZSByZXF1ZXN0IGZvciBHZW9sb2NhdGlvbi5cIjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBlcnJvci5QT1NJVElPTl9VTkFWQUlMQUJMRTpcclxuICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmVycm9yID0gXCJMb2NhdGlvbiBpbmZvcm1hdGlvbiBpcyB1bmF2YWlsYWJsZS5cIjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBlcnJvci5USU1FT1VUOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuZXJyb3IgPSBcIlRoZSByZXF1ZXN0IHRvIGdldCB1c2VyIGxvY2F0aW9uIHRpbWVkIG91dC5cIjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBlcnJvci5VTktOT1dOX0VSUk9SOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuZXJyb3IgPSBcIkFuIHVua25vd24gZXJyb3Igb2NjdXJyZWQuXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgICRzY29wZS5yZWdpc3RlciA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIlJFR0lTVEVSXCIpO1xyXG5cclxuXHJcblxyXG5cclxuICAgICAgICAgICAgJGh0dHAucG9zdCgnL3JlZ2lzdGVyJywge1xyXG4gICAgICAgICAgICAgICAgZmlyc3RuYW1lOiB0aGlzLmZpcnN0bmFtZSxcclxuICAgICAgICAgICAgICAgIGxhc3RuYW1lIDogdGhpcy5sYXN0bmFtZSxcclxuICAgICAgICAgICAgICAgIC8vZW1haWwgOiB0aGlzLmVtYWlsLCovXHJcbiAgICAgICAgICAgICAgICB1c2VybmFtZSA6IHRoaXMudXNlcm5hbWUsXHJcbiAgICAgICAgICAgICAgICBwYXNzd29yZCA6IHRoaXMucGFzc3dvcmQsXHJcbiAgICAgICAgICAgICAgICB6aXBjb2RlOiB0aGlzLnppcGNvZGUsXHJcbiAgICAgICAgICAgICAgICBiaXJ0aGRhdGUgOiB0aGlzLmJpcnRoZGF0ZSxcclxuICAgICAgICAgICAgICAgIHNleCA6IHRoaXMuc2V4LFxyXG4gICAgICAgICAgICAgICAgYmlvZ3JhcGh5IDogdGhpcy5iaW9ncmFwaHksXHJcbiAgICAgICAgICAgICAgICBnZW9sb2NhdGlvbjokc2NvcGUuZ2VvbG9jYXRpb24sXHJcbiAgICAgICAgICAgICAgICBpbnRlcmVzdHM6c2VsZWN0ZWRJbnRlcmVzdFxyXG5cclxuICAgICAgICAgICAgfSkuc3VjY2VzcyhmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLmVycm9yID0gZGF0YS5lcnJvcjtcclxuICAgICAgICAgICAgICAgICRsb2NhdGlvbi5wYXRoKGRhdGEucmVkaXJlY3QpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgfTtcclxuICAgIH07XHJcblxyXG4gICAgdmFyIHNpZ251cENvbnRyb2xsZXIgPSBmdW5jdGlvbiAoJHNjb3BlKSB7XHJcbiAgICAgICAgJHNjb3BlLmNhdGVnb3JpZXMgPSBbJyddO1xyXG4gICAgICAgICRzY29wZS5uZXdDYXRlZ29yeSA9IFwiXCI7XHJcbiAgICAgICAgJHNjb3BlLnNhdmVDYXRlZ29yeSA9IGZ1bmN0aW9uICgpIHtcclxuXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICB9O1xyXG5cclxuICAgIHZhciBlZGl0YWJsZUNoZWNrYm94Q29udHJvbGxlciA9IGZ1bmN0aW9uICgkc2NvcGUpIHtcclxuICAgICAgICAkc2NvcGUuY2F0ZWdvcnkgPSBcIlwiO1xyXG4gICAgICAgICRzY29wZS5zaG93TGFiZWwgPSBmYWxzZTtcclxuICAgICAgICAkc2NvcGUuc2hvd1RleHRib3ggPSB0cnVlO1xyXG4gICAgICAgICRzY29wZS5zYXZlQ2F0ZWdvcnkgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGlmICgkc2NvcGUuY2F0ZWdvcnkpIHtcclxuICAgICAgICAgICAgICAgICRzY29wZS5zaG93TGFiZWwgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLnNob3dUZXh0Ym94ID0gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUuc2hvd0xhYmVsID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUuc2hvd1RleHRib3ggPSB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgICAgICAkc2NvcGUuZWRpdCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgJHNjb3BlLnNob3dMYWJlbCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAkc2NvcGUuc2hvd1RleHRib3ggPSB0cnVlO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgJHNjb3BlLmlzQ2hlY2tlZCA9IGZ1bmN0aW9uKHFJZCl7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKHFJZCk7XHJcbiAgICAgICAgICAgIGlmKHFJZCE9PSAgXCIgXCIpIHtcclxuICAgICAgICAgICAgICAgIGlmIChzZWxlY3RlZEludGVyZXN0LmluZGV4T2YocUlkKSAhPT0gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgaW5kZXggPSBzZWxlY3RlZEludGVyZXN0LmluZGV4T2YocUlkKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZEludGVyZXN0LnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHNlbGVjdGVkSW50ZXJlc3QpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRJbnRlcmVzdC5wdXNoKHFJZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coc2VsZWN0ZWRJbnRlcmVzdCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgICAgICRzY29wZS5zdGF0ZUNoYW5nZWQgPSBmdW5jdGlvbiAocUlkKSB7XHJcblxyXG4gICAgICAgIH07XHJcblxyXG4gICAgfTtcclxuXHJcbiAgICBhbmd1bGFyLm1vZHVsZShcImFwcFwiKVxyXG4gICAgICAgIC5jb250cm9sbGVyKFwibG9naW5Db250cm9sbGVyXCIsIFtcIiRzY29wZVwiLCBcIiRyb290U2NvcGVcIiwgXCIkaHR0cFwiLCBcIiRsb2NhdGlvblwiLCBsb2dpbkNvbnRyb2xsZXJdKVxyXG4gICAgICAgIC5jb250cm9sbGVyKFwic2lnbnVwQ29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgc2lnbnVwQ29udHJvbGxlcl0pXHJcbiAgICAgICAgLmNvbnRyb2xsZXIoXCJlZGl0YWJsZUNoZWNrYm94Q29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgZWRpdGFibGVDaGVja2JveENvbnRyb2xsZXJdKTtcclxufSkoKTsiLCIvKipcclxuICogQ3JlYXRlZCBieSBOaWtpdGEgb24gMjEvMTIvMjAxNS5cclxuICovXHJcbihmdW5jdGlvbiAoKSB7XHJcbiAgICBcInVzZSBzdHJpY3RcIjtcclxuXHJcbiAgICAvKnZhciBzaWdudXBDb250cm9sbGVyID0gZnVuY3Rpb24gKCRzY29wZSkge1xyXG4gICAgICAgICRzY29wZS5jYXRlZ29yaWVzID0gWycnXTtcclxuICAgICAgICAkc2NvcGUubmV3Q2F0ZWdvcnkgPSBcIlwiO1xyXG4gICAgICAgICRzY29wZS5zYXZlQ2F0ZWdvcnkgPSBmdW5jdGlvbiAoKSB7XHJcblxyXG4gICAgICAgIH07XHJcblxyXG4gICAgfTtcclxuXHJcbiAgICB2YXIgZWRpdGFibGVDaGVja2JveENvbnRyb2xsZXIgPSBmdW5jdGlvbiAoJHNjb3BlKSB7XHJcbiAgICAgICAgJHNjb3BlLmNhdGVnb3J5ID0gXCJcIjtcclxuICAgICAgICAkc2NvcGUuc2hvd0xhYmVsID0gZmFsc2U7XHJcbiAgICAgICAgJHNjb3BlLnNob3dUZXh0Ym94ID0gdHJ1ZTtcclxuICAgICAgICAkc2NvcGUuc2F2ZUNhdGVnb3J5ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBpZiAoJHNjb3BlLmNhdGVnb3J5KSB7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUuc2hvd0xhYmVsID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICRzY29wZS5zaG93VGV4dGJveCA9IGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLnNob3dMYWJlbCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLnNob3dUZXh0Ym94ID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgJHNjb3BlLmVkaXQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICRzY29wZS5zaG93TGFiZWwgPSBmYWxzZTtcclxuICAgICAgICAgICAgJHNjb3BlLnNob3dUZXh0Ym94ID0gdHJ1ZTtcclxuICAgICAgICB9O1xyXG5cclxuICAgIH07XHJcbiAgICBhbmd1bGFyLm1vZHVsZShcImFwcFwiKVxyXG4gICAgICAgIC5jb250cm9sbGVyKFwic2lnbnVwQ29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgc2lnbnVwQ29udHJvbGxlcl0pXHJcbiAgICAgICAgLmNvbnRyb2xsZXIoXCJlZGl0YWJsZUNoZWNrYm94Q29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgZWRpdGFibGVDaGVja2JveENvbnRyb2xsZXJdKTsqL1xyXG5cclxuXHJcbn0pKCk7IiwiLyoqXHJcbiAqIENyZWF0ZWQgYnkgTWFydGhlIG9uIDE2LzEyLzE1LlxyXG4gKi9cclxuKGZ1bmN0aW9uICgpIHtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG5cclxuICAgIHZhciB1c2VyQ29udHJvbGxlciA9IGZ1bmN0aW9uICgkc2NvcGUsICRyb290U2NvcGUsICRodHRwLCAkbG9jYXRpb24pIHtcclxuICAgICAgICAkaHR0cC5nZXQoJy91c2VyJykuc3VjY2VzcyhmdW5jdGlvbihkYXRhKSB7XHJcbiAgICAgICAgICAgICRzY29wZS51c2VyID0gZGF0YTtcclxuICAgICAgICAgICAgJHJvb3RTY29wZS51c2VyID0gZGF0YTtcclxuXHJcbiAgICAgICAgICAgIGlmKGRhdGEudXNlcm5hbWUgPT0gJ2FkbWluJyl7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUuYXV0aCA9IHtpc0F1dGg6IHRydWUsIGlzQWRtaW4gOiB0cnVlfTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmKGRhdGEudXNlcm5hbWUgIT0gJ2FkbWluJyAmJiBkYXRhLnVzZXJuYW1lICE9PSB1bmRlZmluZWQpe1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLmF1dGggPSB7aXNBdXRoOiB0cnVlLCBpc0FkbWluIDogZmFsc2V9O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYoZGF0YS51c2VybmFtZSA9PT0gdW5kZWZpbmVkKXtcclxuICAgICAgICAgICAgICAgICRzY29wZS5hdXRoID0ge2lzQXV0aDogZmFsc2UsIGlzQWRtaW4gOiBmYWxzZX07XHJcblxyXG4gICAgICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICB9KTtcclxuXHJcblxyXG4gICAgICAgIC8qJHNjb3BlLmxvZ291dCA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAkaHR0cC5nZXQoJy9sb2dvdXQnKS5zdWNjZXNzKGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAkbG9jYXRpb24ucGF0aChkYXRhLnJlZGlyZWN0KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTsqL1xyXG4gICAgfTtcclxuXHJcblxyXG4gICAgYW5ndWxhci5tb2R1bGUoXCJhcHBcIikuY29udHJvbGxlcihcInVzZXJDb250cm9sbGVyXCIsIFtcIiRzY29wZVwiLCBcIiRyb290U2NvcGVcIiwgXCIkaHR0cFwiLCBcIiRsb2NhdGlvblwiLCB1c2VyQ29udHJvbGxlcl0pO1xyXG59KSgpOyJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
