/**
 * Created by Marthe on 10/12/15.
 */

(function(){
    var app = angular.module("app", ["ngRoute"]);
    app.config(function($routeProvider){
        $routeProvider
            .when("/",{
                templateUrl: "./views/home.html"
            })
            .when("/signup",{
                templateUrl: "views/signup.html"
            })
            .when("/home",{
                templateUrl: "./views/home.html"
            })
            .when("/matches",{
                templateUrl: "./views/matches.html"
            })
            .when("/howto",{
                templateUrl: "./views/howTo.html"
            })
            .when("/activities",{
                templateUrl: "./views/activities.html"
            })
            .when("/admin",{
                templateUrl: "./views/admin.html"
            })
            .when("/searchprofiles",{
                templateUrl: "./views/searchProfiles.html"
            })
            .when("/myprofile",{
                templateUrl: "./views/myProfile.html"
            })
            .when("/userdetails/:username",{
                templateUrl: "./views/detailsUser.html",
                controller: 'UsersController'
            })
            .when("/detailsuser",{
                templateUrl: "./views/detailsUser.html"
            })
            .when("/activitydetails/:activityName", {
                templateUrl: "./views/detailsActivity.html",
                controller: "ActivitiesController"

            })
            .when("/chat",{
                templateUrl: "./views/chat.html"
            });


    });

    app.run(function ($rootScope) {
        $rootScope.user = {};
    });

    app.directive('ngEnter', function () {
        return function (scope, element, attrs) {
            element.bind("keydown keypress", function (event) {
                if (event.which === 13) {
                    scope.$apply(function () {
                        scope.$eval(attrs.ngEnter);
                    });

                    event.preventDefault();
                }
            });
        };
    });


    app.directive('fileModel', ['$parse', function ($parse) {
        return {
            restrict: 'A',
            link: function(scope, element, attrs) {
                var model = $parse(attrs.fileModel);
                var modelSetter = model.assign;

                element.bind('change', function(){
                    scope.$apply(function(){
                        modelSetter(scope, element[0].files[0]);
                    });
                });
            }
        };
    }]);

    app.service('fileUpload', ['$http', function ($http) {
        this.uploadFileToUrl = function(file, uploadUrl){
            var fd = new FormData();
            fd.append('file', file);
            $http.post(uploadUrl, fd, {
                transformRequest: angular.identity,
                headers: {'Content-Type': undefined}
            })
                .success(function(){
                    console.log("success");
                })
                .error(function(){
                    console.log("error");
                });
        };
    }]);


    app.directive('editableCheckbox', function () {
        return {
            restrict: 'E',
            templateUrl: './views/editablecheckbox.html'
        };
    });


})();
/**
 * Created by iman on 15/12/15.
 */
var Activity = function(name, zipcode, street, number, description, dateFrom, dateUntil, timestamp, username, matches){
    this.activityName = name;
    this.zipcode = zipcode;
    this.street = street;
    this.number = number;
    this.description = description;
    this.dateFrom = dateFrom;
    this.dateUntil = dateUntil;
    this.timestamp = timestamp;
    this.username = username;
    this.matches = matches;
};
/**
 * Created by iman on 5/12/15.
 */
/*(function(){

    "use strict";

    var activitiesService = function () {

        var getActivities = function () {

            var localUrl = "http://localhost:3000/data/activities.json";
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open("GET", localUrl, false);
            xmlHttp.send(null);

            if(xmlHttp.status == 200) {

                var data = JSON.parse(xmlHttp.responseText);

                //console.log(data);

                var arrActivities = [];

                for (var i = 0; i < data.length; i++) {

                    var d = data[i];

                    var newActivity = new Activity();
                    newActivity.img = d.img;
                    newActivity.name = d.name;
                    newActivity.place = d.place;
                    newActivity.participants = d.participants;
                    newActivity.myEvent = d.myEvent;

                    var text = "";

                    for(var ii=0; ii< d.keywords.length; ii++){
                        if(ii == d.keywords.length-1){
                            text += d.keywords[ii];
                        }
                        else{
                            text += d.keywords[ii];
                            text += ", ";
                        }
                    }

                    newActivity.keywords = text;
                    arrActivities.push(newActivity);
                }

                return arrActivities;

            }

        };

        //public gedeelte
        return{

            getActivities:getActivities

        };

    };

    angular.module("app").factory("activitiesService", [activitiesService]);
    //                                  ^ deze naam bepaalt welke naam je nodig hebt in je controller als verwijzing!

})();*/
/**
 * Created by Nikita on 7/01/2016.
 */


(function () {

    "use strict";

    var chatService = function ($rootScope) {
        var socket = io.connect(window.location.host);

        var on = function (eventName, callback) {
            socket.on(eventName, function () {
                var args = arguments;
                $rootScope.$apply(function () {
                    callback.apply(socket, args);
                });
            });
        };

        var emit = function (eventName, data, callback) {
            socket.emit(eventName, data, function () {
                var args = arguments;
                $rootScope.$apply(function () {
                    callback.apply(socket, args);
                });
            });
        };


        return {
            on: on,
            emit: emit,
            socket: socket
        };
    };

    angular.module("app").factory("chatService", ["$rootScope", chatService]);

})();
/**
 * Created by iman on 15/12/15.
 */


(function(){

    "use strict";

    var dbService = function ($http) {

        var getCollection = function (collection) {


            var url = "http://localhost:3000/api/" + collection;
            return $http.get(url).then(function(response){
                return response.data;

            });

        };

        var getByID = function (collection, id) {
            var url = "http://localhost:3000/api/" + collection + "/" + id;
            return $http.get(url).then(function(response){
                return response.data;

            });

        };

        var getDetailsUser = function (collection, username) {
            var url = "http://localhost:3000/api/" + collection + "/userdetail/" + username;
            return $http.get(url).then(function(response){
                return response.data;

            });

        };

        var deleteUser =  function (collection, username) {
            var url = "http://localhost:3000/api/" + collection + "/userdelete/" + username;
            return $http.get(url).then(function (response) {
                return response.data;

            });
        };


        var getItem = function(item){

            var url = "http://localhost:3000/api/" + item;
            return $http.get('/user').then(function(response){

                return response.data;

            });

        };

        var getDetailsActivity = function (collection, activityname) {
            var url = "http://localhost:3000/api/" + collection + "/activitydetail/" + activityname;
            return $http.get(url).then(function(response){
                return response.data;

            });

        };

        var getNoiseWords = function () {

            var url = "http://localhost:3000/data/noisewords.json";
            return $http.get(url).then(function(response){

                return response.data;

            });

        };


        //public gedeelte
        return{

            getCollection:getCollection,
            getByID:getByID,
            getItem:getItem,
            getDetailsUser: getDetailsUser,
            deleteUser: deleteUser,
            getDetailsActivity: getDetailsActivity,
            getNoiseWords: getNoiseWords

        };

    };

    angular.module("app").factory("dbService", ["$http", dbService]);
    //                                  ^ deze naam bepaalt welke naam je nodig hebt in je controller als verwijzing!

})();
/**
 * Created by iman on 5/12/15.
 */
(function(){

    "use strict";

    var matchesService = function () {

        var getMatches = function (nameUser) {

            var variabelURL = "together";
            var localUrl = "http://localhost:3000/data/matches.json";
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open("GET", localUrl, false);
            xmlHttp.send(null);

            if(xmlHttp.status == 200) {

                var data = JSON.parse(xmlHttp.responseText);
                var arr = [];
                var arrMatches = [];
                var arrMatchUsers = [];
                var arrMatchInterests = [];

                for(var i=0; i < data.length; i++){

                    var obj = {
                        "user": data[i].user,
                        "matches":data[i].matches
                    };

                    arr.push(obj);

                }

                for(var ii = 0; ii<arr.length; ii++){

                    var index = arr[ii].user.indexOf(nameUser);
                    if(index === 0){
                        arrMatches.push(arr[ii].matches);
                    }
                    //console.log("Index: "+index);
                }

                //console.log(arr);
                //console.log(arrMatches[0]);


                var arrMatchesByUser = arrMatches[0];
                //console.log("Aantal matches: " + arrMatchesByUser.length);

                return arrMatchesByUser;

                /*
                for(var iii = 0; iii<arrMatches[0].length; iii++){

                    var matchUser = arrMatches[0][iii].user;
                    var matchInterests = arrMatches[0][iii].interests;

                    arrMatchUsers.push(matchUser);
                    arrMatchInterests.push(matchInterests);

                    //console.log(matchUser);
                    //console.log(matchInterests);
                }

                console.log(arrMatchUsers);
                console.log(arrMatchInterests);
                */

            }



        };

        //public gedeelte
        return{

            getMatches:getMatches,

        };

    };

    angular.module("app").factory("matchesService", [matchesService]);
    //                                  ^ deze naam bepaalt welke naam je nodig hebt in je controller als verwijzing!

})();
/**
 * Created by iman on 5/12/15.
 */

(function () {

    "use strict";
    var dateTimeNow = new Date().toISOString().substring(0, 10) + " " + new Date().toISOString().substring(11, 16);

    var ActivitiesController = function ($scope, dbService, $http, $location, $routeParams, $route) {
        $scope.interestedAct = true;
        $scope.nameButton = "Interested";

        $scope.getActivities = function () {
            dbService.getCollection('activities').then(function (response) {

                var arrTemp = response.activitielist;
                var arrActs = [];


                for (var i = 0, l = arrTemp.length; i < l; i++) {
                    if (new Date(arrTemp[i].untilDate).getTime() >= new Date(dateTimeNow).getTime()) {
                        arrActs.push(arrTemp[i]);
                    }
                }

                $scope.arrActivities = arrActs;

            });


        };

        String.prototype.replaceAll = function (token, newToken, ignoreCase) {
            var _token;
            var str = this + "";
            var i = -1;

            if (typeof token === "string") {

                if (ignoreCase) {

                    _token = token.toLowerCase();

                    while ((
                        i = str.toLowerCase().indexOf(
                            token, i >= 0 ? i + newToken.length : 0
                        ) ) !== -1
                        ) {
                        str = str.substring(0, i) +
                            newToken +
                            str.substring(i + token.length);
                    }

                } else {
                    return this.split(token).join(newToken);
                }

            }
            return str;
        };

        function isInArray(value, array) {
            return array.indexOf(value);
        }

        function getKeywordsFromDescription(description, callback) {

            description = description.replaceAll('.', '');
            description = description.replaceAll(',', '');
            description = description.replaceAll('?', '');
            description = description.replaceAll('!', '');
            description = description.replaceAll('"', '');
            description = description.replaceAll("'", '');

            var words = description.split(" ");
            var keyWords = "";

            dbService.getNoiseWords().then(function (response) {

                var noiseWords = response.noisewords;

                for (var i = 0; i < words.length; i++) {

                    if (isInArray(words[i].toLowerCase(), noiseWords) == -1) {
                        keyWords += words[i];
                        keyWords += " ";
                    }
                }

                //return keyWords;
                if (!keyWords.isEmpty) {
                    callback(null, keyWords);
                }

                else {
                    callback("No keywords found.", null);
                }

            });
        }

        function stringConsistOf2Numbers(number, callback) {
            var output = number + '';
            if (output.length < 2) {
                output = '0' + output;
                number = output.toString();

            }
            else {
                number = number.toString();
            }


            if (!number.isEmpty) {
                callback(null, number);
            }

            else {
                callback("No number.", null);
            }


        }

        function fullDate(number, number2, callback) {
            stringConsistOf2Numbers(number, function (error, numberToString) {
                number = numberToString;
                if (error) {
                    console.log(error);

                }
            });
            stringConsistOf2Numbers(number2, function (error, numberToString) {
                number2 = numberToString;
                if (error) {
                    console.log(error);

                }
            });

            if (!number.isEmpty && !number2.isEmpty) {
                callback(null, number, number2);
            }

            else {
                callback("No number.", null);
            }


        }


        $scope.addActivity = function () {
            var activityName = this.activityName;
            var street = this.street;
            var number = this.number;
            var zipcode = this.zipcode;
            var description = this.comment;
            var dateFrom = this.dateFrom;
            var dateUntil = this.dateUntil;
            var timestamp = new Date().getTime();
            var startTimeHour = this.startTimeHour;
            var startTimeMin = this.startTimeMin;
            var endTimeHour = this.endTimeHour;
            var endTimeMin = this.endTimeMin;
            var dateFromDay = this.dateFromDay;
            var dateFromMonth = this.dateFromMonth;
            var dateFromYear = this.dateFromYear.toString();
            var dateUntilDay = this.dateUntilDay;
            var dateUntilMonth = this.dateUntilMonth;
            var dateUntilYear = this.dateUntilYear.toString();

            fullDate(dateFromDay, dateFromMonth, function (error, dateFromdayString, dateFromMonthString) {
                dateFromDay = dateFromdayString;
                dateFromMonth = dateFromMonthString;
                if (error) {
                    console.log(error);
                }
            });
            fullDate(dateUntilDay, dateUntilMonth, function (error, dateUntilDayString, dateUntilMonthString) {
                dateUntilDay = dateUntilDayString;
                dateUntilMonth = dateUntilMonthString;
                if (error) {
                    console.log(error);
                }
            });


            if ((street !== undefined) &&
                (number !== undefined) &&
                (zipcode !== undefined) &&
                (description !== undefined) &&
                (timestamp !== undefined)) {

                $scope.error = "";

                if (startTimeMin < 60 && startTimeHour < 25) {

                    stringConsistOf2Numbers(startTimeHour, function (error, startTimeHourString) {
                        startTimeHour = startTimeHourString;
                        if (error) {
                            console.log(error);
                        }
                    });
                    stringConsistOf2Numbers(startTimeMin, function (error, startTimeMinString) {
                        startTimeMin = startTimeMinString;
                        if (error) {
                            console.log(error);

                        }
                    });

                    console.log(startTimeHour);
                    console.log(startTimeMin);

                    if (startTimeMin.length === 2 && startTimeHour.length === 2) {
                        console.log("je komt hier terecht");

                        if (endTimeMin < 60 && endTimeHour < 24) {
                            stringConsistOf2Numbers(endTimeHour, function (error, endTimeHourString) {
                                endTimeHour = endTimeHourString;
                                if (error) {
                                    console.log(error);
                                }
                            });
                            stringConsistOf2Numbers(endTimeMin, function (error, endTimeMinString) {
                                endTimeMin = endTimeMinString;
                                if (error) {
                                    console.log(error);

                                }
                            });

                            console.log(endTimeHour);
                            console.log(endTimeMin);

                            if (endTimeMin.toString().length === 2 && endTimeHour.toString().length === 2) {

                                console.log(startTimeHour + ":" + startTimeMin);

                                getKeywordsFromDescription(description, function (error, data) {
                                    description = data;
                                    if (!error) {
                                        console.log(startTimeHour + ":" + startTimeMin);

                                        var url = "http://localhost:3000/api/activities/addactivity";
                                        $http.post(url, {
                                            activityName: activityName,
                                            street: street,
                                            number: number,
                                            zipcode: zipcode,
                                            description: description,
                                            dateFrom: dateFromYear + "-" + dateFromMonth + "-" + dateFromDay + " " + startTimeHour + ":" + startTimeMin,
                                            dateUntil: dateUntilYear + "-" + dateFromMonth + "-" + dateUntilDay + " " + endTimeHour + ":" + endTimeMin,
                                            timestamp: timestamp

                                        }).success(function (data) {
                                            $scope.error = data.error;
                                            $scope.getActivities();
                                            resetForm();

                                            //$location.path(data.redirect);
                                        });

                                    }
                                    else {
                                        console.log(error);
                                    }
                                });
                            }

                            else {
                                $scope.error = "Enddate input is not correct";
                            }
                        }

                        else {
                            $scope.error = "Endtime input is not correct";
                        }

                    }

                    else {
                        $scope.error = 'De startime length is not correct!!!! ';
                    }
                }
                else {
                    $scope.error = "Starttime input is not correct";
                }


            }
            else {
                $scope.error = "ERROR: All fields are required.8888";
            }
        };

        $scope.getDetailActivity = function (currentUser) {
            dbService.getDetailsActivity('activities', $routeParams.activityName).then(function (response) {
                $scope.arrDetailsActivity = response.activity;
                initmap();

                console.log($scope.arrDetailsActivity.matches);
                for (var i = 0; i < $scope.arrDetailsActivity.matches.length; i++) {
                    if ($scope.arrDetailsActivity.matches[i] === currentUser) {
                        $scope.nameButton = "Not interested";
                        $scope.interestedAct = false;
                    }
                }
                return $scope.arrDetailsActivity;


            });
        };

        $scope.interested = function (activityName, interestedUser, createrUser) {
            var url = "";
            var interestedAct = $scope.interestedAct;
            if (interestedAct !== false) {

                url = "http://localhost:3000/api/activities/interested";
                $http.post(url, {
                    activityName: activityName,
                    interestedUser: interestedUser,
                    createrUser: createrUser
                }).success(function (data) {
                    console.log(data);
                    console.log(interestedUser + " is geïnteresseerd in " + activityName + " door " + createrUser);
                    $scope.interestedAct = false;
                    $scope.nameButton = "Not interested";
                    $scope.error = data.error;
                });
            } else {
                console.log(interestedAct);
                url = "http://localhost:3000/api/activities/deleteinterested";
                $http.post(url, {
                    activityName: activityName,
                    interestedUser: interestedUser,
                    createrUser: createrUser
                }).success(function (data) {
                    console.log(data);
                    console.log(interestedUser + " is niet meer geïnteresseerd in " + activityName + " door " + createrUser);
                    $scope.interestedAct = true;
                    $scope.nameButton = "Interested";

                    $scope.error = data.error;
                });
            }
        };

        function recentFirst(a, b) {
            if (a.timestamp > b.timestamp)
                return -1;
            if (a.timestamp < b.timestamp)
                return 1;
            return 0;
        }

        function popularFirst(arr) {
            var max = arr[0];
            var maxIndex = 0;

            for (var i = 1; i < arr.length; i++) {
                if (arr[i].matches.length > max.matches.length) {
                    maxIndex = i;
                    max = arr[i];
                }
            }

            return maxIndex;
        }

        $scope.showActivitiesOnHomePage = function(){
            $scope.getMostRecentActivities();
            $scope.getMostPopularActivities();
        };

        $scope.getMostRecentActivities = function () {

            dbService.getCollection('activities').then(function (response) {
                var numberOfActivities = 3;
                var arrTemp = response.activitielist;
                var arrAllActivities = [];


                for (var i = 0, l = arrTemp.length; i < l; i++) {
                    if (new Date(arrTemp[i].untilDate).getTime() >= new Date(dateTimeNow).getTime()) {
                        console.log(new Date(arrTemp[i].untilDate));
                        arrAllActivities.push(arrTemp[i]);
                    }
                }

                arrAllActivities.sort(recentFirst);

                var arrMostRecentActivities = [];

                for (var ii = 0; ii < numberOfActivities; ii++) {
                    arrMostRecentActivities.push(arrAllActivities[ii]);
                }

                var matches = [];

                for (var iii = 0; iii < arrMostRecentActivities.length; iii++) {

                    var dummyActivity = new Activity("No name", 8500, "Together", 2, "no description", "2016-01-01 00:01", "2017-12-31 23:59", new Date(), "no username", matches);
                    if (arrMostRecentActivities[iii] === undefined) {
                        arrMostRecentActivities.splice(iii, 1, dummyActivity);
                    }
                }
                $scope.arrMostRecentActivities = arrMostRecentActivities;

            });
        };

        $scope.getMostPopularActivities = function(){

            dbService.getCollection('activities').then(function(response){

                var numberOfActivities = 3;
                var arrTemp = response.activitielist;
                var arrAllActivities = [];

                for (var i = 0, l = arrTemp.length; i < l; i++) {
                    if(new Date(arrTemp[i].untilDate).getTime() >= new Date(dateTimeNow).getTime()) {
                        //console.log(new Date(arrTemp[i].untilDate));
                        arrAllActivities.push(arrTemp[i]);
                    }
                }

                var arrMostPopularActivities = [];

                for(var j = 0; j < numberOfActivities; j++){

                    var indexMostPop = popularFirst(arrAllActivities);
                    arrMostPopularActivities.push(arrAllActivities[indexMostPop]);
                    arrAllActivities.splice(indexMostPop, 1);
                }

                $scope.arrMostPopularActivities = arrMostPopularActivities;

            });
        };



        function geocodeAddress(geocoder, resultsMap) {
            var street = $scope.arrDetailsActivity.street;
            var number = $scope.arrDetailsActivity.number;
            var zipcode = $scope.arrDetailsActivity.zipcode;

            var address = street + " " + number + ", " + zipcode; //hier address uit db instoppen

            geocoder.geocode({'address': address}, function (results, status) {
                if (status === google.maps.GeocoderStatus.OK) {
                    resultsMap.setCenter(results[0].geometry.location);
                    var marker = new google.maps.Marker({
                        map: resultsMap,
                        position: results[0].geometry.location
                    });

                    console.log(marker);

                } else {
                    alert('Geocode was not successful for the following reason: ' + status);
                }
            });
        }

        function resetForm() {
            var frm = document.getElementsByName('ActivityForm')[0];
            console.log('je komt in de resetform');
            frm.reset();
        }
    };

    angular.module("app").controller("ActivitiesController", ["$scope", "dbService", "$http", "$location", "$routeParams", "fileUpload", ActivitiesController]);


})();
/**
 * Created by Nikita on 7/01/2016.
 */
(function () {

    "use strict";

    var ChatController = function($scope, $rootScope, $routeParams, dbService, $http) {

        console.log($rootScope.currentUser.username);
        console.log($rootScope.contactedUser.username);
        //$scope.contactedUser.username = $rootScope.contactedUser.username;

        $scope.init = function () {
            chatService.emit("init_users",{user:$rootScope.currentUser, collection:"users"});
        };

    };
    angular.module("app").controller("ChatController", ["$scope", "$rootScope", "$routeParams", "dbService","$http", ChatController]);

})();
/**
 * Created by iman on 5/12/15.
 */

(function(){

    "use strict";

    var MatchesController = function($scope, dbService) {

        var clicksOnBtn = 0;

        $scope.showDiv = function(){
            $scope.filter = {showFilter:true};
            clicksOnBtn++;

            if(clicksOnBtn > 1){
                $scope.filter = {showFilter:false};
                clicksOnBtn = 0;
            }
        };

        $scope.hideDiv = function(){
            clicksOnBtn = 0;
            $scope.filter = {showFilter:false};
        };

        $scope.sortProperty = "title";
        $scope.filterQuery = "";
        $scope.filterMatches = function(i){
            if($scope.filterQuery === ""){
                return true;
            }

            /*
             else if(i.username.toLowerCase().indexOf($scope.filterQuery.toLocaleLowerCase()) >= 0){
             return true;
             }
             */

            else if(i.sex === undefined){
                return false;
            }

            else if($scope.filterQuery.toLowerCase() == i.sex.toLowerCase()){
                return true;
            }

            else if($scope.filterQuery.toLowerCase() === "nofilter"){
                $scope.filterQuery = "";
            }

            return false;
        };

        /*
        $scope.showMatches = function(){

            var nameUser = "Luna";

            var arrMatchesByUser = matchesService.getMatches(nameUser);

            $scope.aantalMatches = arrMatchesByUser.length;

            $scope.arrMatches = arrMatchesByUser;

            var text = "";
            for(var i=0; i<arrMatchesByUser.length; i++){
                text = arrMatchesByUser[i].interests.toString().replace(" ,", " ");
                arrMatchesByUser[i].interests = text;
            }

        };
        */

        //http://www.falsepositives.com/index.php/2009/12/01/javascript-function-to-get-the-intersect-of-2-arrays/
        function intersect(arr1, arr2)
        {
            var r = [], o = {}, l = arr2.length, i, v;
            for (i = 0; i < l; i++) {
                o[arr2[i]] = true;
            }
            l = arr1.length;
            for (i = 0; i < l; i++) {
                v = arr1[i];
                if (v in o) {
                    r.push(v);
                }
            }

            return r;
        }

        $scope.showMatches = function(){

            /*
             var username = "";
             if($rootScope.user.username !== undefined){
             username = $rootScope.user.username;
             }
             */

            var username;

            username = localStorage.getItem("username");

            dbService.getCollection('users').then(function(response){

                var arrProfiles = response.userlist;
                for(var i = 0; i < arrProfiles.length; i++){
                    if(arrProfiles[i].username === username) {
                        arrProfiles.splice(i, 1);
                    }
                }
                for(var ii = 0; ii < arrProfiles.length; ii++){
                    if(arrProfiles[ii].username === "admin") {
                        arrProfiles.splice(ii, 1);
                    }
                }


                dbService.getItem(username).then(function(response){

                    var user = response;
                    var arrMatches = [];

                    console.log(user.interests);

                    for(var i=0, l=arrProfiles.length; i<l; i++){

                        var sameInterests = [];
                        sameInterests = intersect(user.interests, arrProfiles[i].interests);

                        if(sameInterests.length !== 0){
                            arrMatches.push(arrProfiles[i]);
                        }

                    }

                    $scope.arrMatches = arrMatches;

                });
            });
        };

    };

    angular.module("app").controller("MatchesController", ["$scope", "dbService", MatchesController]);

})();
/**
 * Created by iman on 20/12/15.
 */


(function(){

    "use strict";

    var ProfilesController = function($scope, $rootScope, $routeParams, dbService, $http, $location) {

        var clicksOnBtn = 0;
        $scope.startChat = function(currentUser, contactedUser){
            $http.post("/chat", {
                currentUser: currentUser,
                contactedUser:contactedUser

            }).success(function (data) {
                $scope.error = data.error;
                $rootScope.currentUser = data.currentUser;
                $rootScope.contactedUser = data.contactedUser;

                localStorage.setItem("currentusername", $rootScope.currentUser.username);
                localStorage.setItem("contactedusername", $rootScope.contactedUser.username);

                $location.path(data.redirect);
            });
        };



        $scope.showDiv = function(){
            $scope.filter = {showFilter:true};
            clicksOnBtn++;

            if(clicksOnBtn > 1){
                $scope.filter = {showFilter:false};
                clicksOnBtn = 0;
            }
        };

        $scope.hideDiv = function(){
            clicksOnBtn = 0;
            $scope.filter = {showFilter:false};
        };

        $scope.showProfiles = function(){

            /*
            var username = "";
            if($rootScope.user.username !== undefined){
                username = $rootScope.user.username;
            }
            */
            var username = "";
            username = localStorage.getItem("username");

            dbService.getCollection('users').then(function(response){

                var arrProfiles = response.userlist;
                for(var i = 0; i < arrProfiles.length; i++){
                    if(arrProfiles[i].username === username) {
                        arrProfiles.splice(i, 1);
                    }
                }
                for(var ii = 0; ii < arrProfiles.length; ii++){
                    if(arrProfiles[ii].username === "admin") {
                        arrProfiles.splice(ii, 1);
                    }
                }
                $scope.arrProfiles = arrProfiles;

            });

        };

        $scope.sortProperty = "title";
        $scope.filterQuery = "";
        $scope.filterProfiles = function(i){
            if($scope.filterQuery === ""){
                return true;
            }

            /*
             else if(i.username.toLowerCase().indexOf($scope.filterQuery.toLocaleLowerCase()) >= 0){
             return true;
             }
             */

            else if(i.sex === undefined){
                return false;
            }

            else if($scope.filterQuery.toLowerCase() == i.sex.toLowerCase()){
                return true;
            }

            else if($scope.filterQuery.toLowerCase() === "nofilter"){
                $scope.filterQuery = "";
            }

            return false;
        };
    };

    angular.module("app").controller("ProfilesController", ["$scope", "$rootScope", "$routeParams", "dbService","$http", "$location", ProfilesController]);

})();
/**
 * Created by iman on 20/12/15.
 */
(function(){

    "use strict";

    var UsersController = function($scope, $routeParams, dbService) {

        $scope.getUsers = function(){

            dbService.getCollection('users').then(function(response){

                //console.log(response);
                $scope.arrUsers = response.userlist;

                for( var i = 0; i<$scope.arrUsers.length; i++){

                    if($scope.arrUsers[i].deleted === false){
                        $scope.deleted = false;
                    }

                    else{
                        $scope.deleted = true;
                    }



                }


            });

        };

        $scope.getDetailUser = function(){

            dbService.getDetailsUser('users', $routeParams.username).then(function(response){
                $scope.arrDetails = response.correctuser;
            });
        };

        $scope.deleteUser = function(username){
            dbService.deleteUser('users', username).then(function(response){
                $scope.infodeletedUser = response;
                $scope.getUsers();
            });
        };

        $scope.getUserByID = function(){

            dbService.getItem('user').then(function(response){
                console.log(response);
                $scope.userProfile = response;

            });


        };


    };

    angular.module("app").controller("UsersController", ["$scope", "$routeParams", "dbService", UsersController]);

})();
/**
 * Created by Marthe on 30/12/15.
 */


(function(){
    "use strict";



var locationController = function($scope) {

    console.log('TESTEST');

    $scope.initmap = function() {
        var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 8,
            center: {lat: 50.8194894, lng: 3.2577076}
        });
        var geocoder = new google.maps.Geocoder();

        geocodeAddress(geocoder, map);

    };

    function geocodeAddress(geocoder, resultsMap) {
        var address = "Graaf Karel de Goedelaan 5, Kortrijk"; //hier address uit db instoppen

        geocoder.geocode({'address': address}, function (results, status) {
            if (status === google.maps.GeocoderStatus.OK) {
                resultsMap.setCenter(results[0].geometry.location);
                var marker = new google.maps.Marker({
                    map: resultsMap,
                    position: results[0].geometry.location
                });

                console.log(marker);

            } else {
                alert('Geocode was not successful for the following reason: ' + status);
            }
        });
    }
};

    angular.module("app").controller("locationController", ["$scope", locationController]);
})();
/**
 * Created by Marthe on 15/12/15.
 */
(function(){
    "use strict";
    var selectedInterest = [];

    var loginController = function ($scope, $rootScope, $http, $location) {

        $scope.login = function() {
            $http
                .post('/login', {
                    username: this.username,
                    password: this.password
                })
                .success(function(data) {
                    console.log(data);
                    $rootScope.user = data.user;
                    localStorage.setItem("username", $rootScope.user.username);
                    $scope.error = data.error;
                    $location.path(data.redirect);
                });
        };

        $scope.interests = ['Jazz', 'Hiphop', 'New wave', 'Traveling','Party'];
        $scope.lst = [];
        $scope.change = function(){
            $scope.lst.push('2');
            console.log($scope.lst);
        };
        $scope.stateChanged = function (qId) {
            //if(!$scope.interests[qId]){ //If it is checked
            if(selectedInterest.indexOf(qId) !== -1) {
                //console.log('artNr already exists! DELETE');
                var index = selectedInterest.indexOf(qId);
                if (index > -1) {
                    selectedInterest.splice(index, 1);
                }
            }else{
                selectedInterest.push(qId);
                console.log(selectedInterest);
            }
        };

        $scope.register = function() {
            console.log("REGISTER");


            $http.post('/register', {
                firstname: this.firstname,
                lastname : this.lastname,
                //email : this.email,*/
                username : this.username,
                password : this.password,
                zipcode: this.zipcode,
                birthdate : this.birthdate,
                sex : this.sex,
                biography : this.biography,
                interests:selectedInterest

            }).success(function (data) {
                $scope.error = data.error;
                $location.path(data.redirect);
            });

        };
    };

    var signupController = function ($scope) {
        $scope.categories = [''];
        $scope.newCategory = "";
        $scope.saveCategory = function () {

        };

    };

    var editableCheckboxController = function ($scope) {
        $scope.category = "";
        $scope.showLabel = false;
        $scope.showTextbox = true;
        $scope.saveCategory = function () {
            if ($scope.category) {
                $scope.showLabel = true;
                $scope.showTextbox = false;
            }
            else {
                $scope.showLabel = false;
                $scope.showTextbox = true;
            }
        };
        $scope.edit = function () {
            $scope.showLabel = false;
            $scope.showTextbox = true;
        };
        $scope.isChecked = function(qId){
            console.log(qId);
            if(qId!==  " ") {
                if (selectedInterest.indexOf(qId) !== -1) {
                    var index = selectedInterest.indexOf(qId);
                    if (index > -1) {
                        selectedInterest.splice(index, 1);
                        console.log(selectedInterest);
                    }
                } else {
                    selectedInterest.push(qId);
                    console.log(selectedInterest);
                }
            }
        };
        $scope.stateChanged = function (qId) {

        };

    };

    angular.module("app")
        .controller("loginController", ["$scope", "$rootScope", "$http", "$location", loginController])
        .controller("signupController", ["$scope", signupController])
        .controller("editableCheckboxController", ["$scope", editableCheckboxController]);
})();
/**
 * Created by Nikita on 21/12/2015.
 */
(function () {
    "use strict";

    /*var signupController = function ($scope) {
        $scope.categories = [''];
        $scope.newCategory = "";
        $scope.saveCategory = function () {

        };

    };

    var editableCheckboxController = function ($scope) {
        $scope.category = "";
        $scope.showLabel = false;
        $scope.showTextbox = true;
        $scope.saveCategory = function () {
            if ($scope.category) {
                $scope.showLabel = true;
                $scope.showTextbox = false;
            }
            else {
                $scope.showLabel = false;
                $scope.showTextbox = true;
            }
        };
        $scope.edit = function () {
            $scope.showLabel = false;
            $scope.showTextbox = true;
        };

    };
    angular.module("app")
        .controller("signupController", ["$scope", signupController])
        .controller("editableCheckboxController", ["$scope", editableCheckboxController]);*/


})();
/**
 * Created by Marthe on 16/12/15.
 */
(function () {
    "use strict";

    var userController = function ($scope, $rootScope, $http, $location) {
        $http.get('/user').success(function(data) {
            $scope.user = data;
            $rootScope.user = data;

            if(data.username == 'admin'){
                $scope.auth = {isAuth: true, isAdmin : true};
            }
            else if(data.username != 'admin' && data.username !== undefined){
                $scope.auth = {isAuth: true, isAdmin : false};
            }
            else if(data.username === undefined){
                $scope.auth = {isAuth: false, isAdmin : false};

            }


        });


        /*$scope.logout = function() {
            $http.get('/logout').success(function (data) {
                $location.path(data.redirect);
            });
        };*/
    };


    angular.module("app").controller("userController", ["$scope", "$rootScope", "$http", "$location", userController]);
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsIkFjdGl2aXR5LmpzIiwiYWN0aXZpdGllc1NlcnZpY2UuanMiLCJjaGF0U2VydmljZS5qcyIsImRiU2VydmljZS5qcyIsIm1hdGNoZXNTZXJ2aWNlLmpzIiwiQWN0aXZpdGllc0NvbnRyb2xsZXIuanMiLCJDaGF0Q29udHJvbGxlci5qcyIsIk1hdGNoZXNDb250cm9sbGVyLmpzIiwiUHJvZmlsZXNDb250cm9sbGVyLmpzIiwiVXNlcnNDb250cm9sbGVyLmpzIiwibG9jYXRpb25Db250cm9sbGVyLmpzIiwibG9naW5Db250cm9sbGVyLmpzIiwic2lnbnVwQ29udHJvbGxlci5qcyIsInVzZXJDb250cm9sbGVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNuSEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDZEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNyRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3hDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ25HQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN6RkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDL2RBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3BCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNySkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDM0dBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2pFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDOUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDeEhBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN4Q0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6ImFwcC5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENyZWF0ZWQgYnkgTWFydGhlIG9uIDEwLzEyLzE1LlxuICovXG5cbihmdW5jdGlvbigpe1xuICAgIHZhciBhcHAgPSBhbmd1bGFyLm1vZHVsZShcImFwcFwiLCBbXCJuZ1JvdXRlXCJdKTtcbiAgICBhcHAuY29uZmlnKGZ1bmN0aW9uKCRyb3V0ZVByb3ZpZGVyKXtcbiAgICAgICAgJHJvdXRlUHJvdmlkZXJcbiAgICAgICAgICAgIC53aGVuKFwiL1wiLHtcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL3ZpZXdzL2hvbWUuaHRtbFwiXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLndoZW4oXCIvc2lnbnVwXCIse1xuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcInZpZXdzL3NpZ251cC5odG1sXCJcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAud2hlbihcIi9ob21lXCIse1xuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vdmlld3MvaG9tZS5odG1sXCJcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAud2hlbihcIi9tYXRjaGVzXCIse1xuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vdmlld3MvbWF0Y2hlcy5odG1sXCJcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAud2hlbihcIi9ob3d0b1wiLHtcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL3ZpZXdzL2hvd1RvLmh0bWxcIlxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC53aGVuKFwiL2FjdGl2aXRpZXNcIix7XG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwiLi92aWV3cy9hY3Rpdml0aWVzLmh0bWxcIlxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC53aGVuKFwiL2FkbWluXCIse1xuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vdmlld3MvYWRtaW4uaHRtbFwiXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLndoZW4oXCIvc2VhcmNocHJvZmlsZXNcIix7XG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwiLi92aWV3cy9zZWFyY2hQcm9maWxlcy5odG1sXCJcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAud2hlbihcIi9teXByb2ZpbGVcIix7XG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwiLi92aWV3cy9teVByb2ZpbGUuaHRtbFwiXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLndoZW4oXCIvdXNlcmRldGFpbHMvOnVzZXJuYW1lXCIse1xuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vdmlld3MvZGV0YWlsc1VzZXIuaHRtbFwiLFxuICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6ICdVc2Vyc0NvbnRyb2xsZXInXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLndoZW4oXCIvZGV0YWlsc3VzZXJcIix7XG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwiLi92aWV3cy9kZXRhaWxzVXNlci5odG1sXCJcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAud2hlbihcIi9hY3Rpdml0eWRldGFpbHMvOmFjdGl2aXR5TmFtZVwiLCB7XG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwiLi92aWV3cy9kZXRhaWxzQWN0aXZpdHkuaHRtbFwiLFxuICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6IFwiQWN0aXZpdGllc0NvbnRyb2xsZXJcIlxuXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLndoZW4oXCIvY2hhdFwiLHtcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL3ZpZXdzL2NoYXQuaHRtbFwiXG4gICAgICAgICAgICB9KTtcblxuXG4gICAgfSk7XG5cbiAgICBhcHAucnVuKGZ1bmN0aW9uICgkcm9vdFNjb3BlKSB7XG4gICAgICAgICRyb290U2NvcGUudXNlciA9IHt9O1xuICAgIH0pO1xuXG4gICAgYXBwLmRpcmVjdGl2ZSgnbmdFbnRlcicsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cnMpIHtcbiAgICAgICAgICAgIGVsZW1lbnQuYmluZChcImtleWRvd24ga2V5cHJlc3NcIiwgZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAgICAgICAgICAgaWYgKGV2ZW50LndoaWNoID09PSAxMykge1xuICAgICAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGV2YWwoYXR0cnMubmdFbnRlcik7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgfSk7XG5cblxuICAgIGFwcC5kaXJlY3RpdmUoJ2ZpbGVNb2RlbCcsIFsnJHBhcnNlJywgZnVuY3Rpb24gKCRwYXJzZSkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgcmVzdHJpY3Q6ICdBJyxcbiAgICAgICAgICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycykge1xuICAgICAgICAgICAgICAgIHZhciBtb2RlbCA9ICRwYXJzZShhdHRycy5maWxlTW9kZWwpO1xuICAgICAgICAgICAgICAgIHZhciBtb2RlbFNldHRlciA9IG1vZGVsLmFzc2lnbjtcblxuICAgICAgICAgICAgICAgIGVsZW1lbnQuYmluZCgnY2hhbmdlJywgZnVuY3Rpb24oKXtcbiAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICAgICAgICAgICAgICBtb2RlbFNldHRlcihzY29wZSwgZWxlbWVudFswXS5maWxlc1swXSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgIH1dKTtcblxuICAgIGFwcC5zZXJ2aWNlKCdmaWxlVXBsb2FkJywgWyckaHR0cCcsIGZ1bmN0aW9uICgkaHR0cCkge1xuICAgICAgICB0aGlzLnVwbG9hZEZpbGVUb1VybCA9IGZ1bmN0aW9uKGZpbGUsIHVwbG9hZFVybCl7XG4gICAgICAgICAgICB2YXIgZmQgPSBuZXcgRm9ybURhdGEoKTtcbiAgICAgICAgICAgIGZkLmFwcGVuZCgnZmlsZScsIGZpbGUpO1xuICAgICAgICAgICAgJGh0dHAucG9zdCh1cGxvYWRVcmwsIGZkLCB7XG4gICAgICAgICAgICAgICAgdHJhbnNmb3JtUmVxdWVzdDogYW5ndWxhci5pZGVudGl0eSxcbiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7J0NvbnRlbnQtVHlwZSc6IHVuZGVmaW5lZH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLnN1Y2Nlc3MoZnVuY3Rpb24oKXtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJzdWNjZXNzXCIpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLmVycm9yKGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiZXJyb3JcIik7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgfV0pO1xuXG5cbiAgICBhcHAuZGlyZWN0aXZlKCdlZGl0YWJsZUNoZWNrYm94JywgZnVuY3Rpb24gKCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgcmVzdHJpY3Q6ICdFJyxcbiAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnLi92aWV3cy9lZGl0YWJsZWNoZWNrYm94Lmh0bWwnXG4gICAgICAgIH07XG4gICAgfSk7XG5cblxufSkoKTsiLCIvKipcbiAqIENyZWF0ZWQgYnkgaW1hbiBvbiAxNS8xMi8xNS5cbiAqL1xudmFyIEFjdGl2aXR5ID0gZnVuY3Rpb24obmFtZSwgemlwY29kZSwgc3RyZWV0LCBudW1iZXIsIGRlc2NyaXB0aW9uLCBkYXRlRnJvbSwgZGF0ZVVudGlsLCB0aW1lc3RhbXAsIHVzZXJuYW1lLCBtYXRjaGVzKXtcbiAgICB0aGlzLmFjdGl2aXR5TmFtZSA9IG5hbWU7XG4gICAgdGhpcy56aXBjb2RlID0gemlwY29kZTtcbiAgICB0aGlzLnN0cmVldCA9IHN0cmVldDtcbiAgICB0aGlzLm51bWJlciA9IG51bWJlcjtcbiAgICB0aGlzLmRlc2NyaXB0aW9uID0gZGVzY3JpcHRpb247XG4gICAgdGhpcy5kYXRlRnJvbSA9IGRhdGVGcm9tO1xuICAgIHRoaXMuZGF0ZVVudGlsID0gZGF0ZVVudGlsO1xuICAgIHRoaXMudGltZXN0YW1wID0gdGltZXN0YW1wO1xuICAgIHRoaXMudXNlcm5hbWUgPSB1c2VybmFtZTtcbiAgICB0aGlzLm1hdGNoZXMgPSBtYXRjaGVzO1xufTsiLCIvKipcbiAqIENyZWF0ZWQgYnkgaW1hbiBvbiA1LzEyLzE1LlxuICovXG4vKihmdW5jdGlvbigpe1xuXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG5cbiAgICB2YXIgYWN0aXZpdGllc1NlcnZpY2UgPSBmdW5jdGlvbiAoKSB7XG5cbiAgICAgICAgdmFyIGdldEFjdGl2aXRpZXMgPSBmdW5jdGlvbiAoKSB7XG5cbiAgICAgICAgICAgIHZhciBsb2NhbFVybCA9IFwiaHR0cDovL2xvY2FsaG9zdDozMDAwL2RhdGEvYWN0aXZpdGllcy5qc29uXCI7XG4gICAgICAgICAgICB2YXIgeG1sSHR0cCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgICAgICAgICAgeG1sSHR0cC5vcGVuKFwiR0VUXCIsIGxvY2FsVXJsLCBmYWxzZSk7XG4gICAgICAgICAgICB4bWxIdHRwLnNlbmQobnVsbCk7XG5cbiAgICAgICAgICAgIGlmKHhtbEh0dHAuc3RhdHVzID09IDIwMCkge1xuXG4gICAgICAgICAgICAgICAgdmFyIGRhdGEgPSBKU09OLnBhcnNlKHhtbEh0dHAucmVzcG9uc2VUZXh0KTtcblxuICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coZGF0YSk7XG5cbiAgICAgICAgICAgICAgICB2YXIgYXJyQWN0aXZpdGllcyA9IFtdO1xuXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgdmFyIGQgPSBkYXRhW2ldO1xuXG4gICAgICAgICAgICAgICAgICAgIHZhciBuZXdBY3Rpdml0eSA9IG5ldyBBY3Rpdml0eSgpO1xuICAgICAgICAgICAgICAgICAgICBuZXdBY3Rpdml0eS5pbWcgPSBkLmltZztcbiAgICAgICAgICAgICAgICAgICAgbmV3QWN0aXZpdHkubmFtZSA9IGQubmFtZTtcbiAgICAgICAgICAgICAgICAgICAgbmV3QWN0aXZpdHkucGxhY2UgPSBkLnBsYWNlO1xuICAgICAgICAgICAgICAgICAgICBuZXdBY3Rpdml0eS5wYXJ0aWNpcGFudHMgPSBkLnBhcnRpY2lwYW50cztcbiAgICAgICAgICAgICAgICAgICAgbmV3QWN0aXZpdHkubXlFdmVudCA9IGQubXlFdmVudDtcblxuICAgICAgICAgICAgICAgICAgICB2YXIgdGV4dCA9IFwiXCI7XG5cbiAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBpaT0wOyBpaTwgZC5rZXl3b3Jkcy5sZW5ndGg7IGlpKyspe1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYoaWkgPT0gZC5rZXl3b3Jkcy5sZW5ndGgtMSl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCArPSBkLmtleXdvcmRzW2lpXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2V7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCArPSBkLmtleXdvcmRzW2lpXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ICs9IFwiLCBcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIG5ld0FjdGl2aXR5LmtleXdvcmRzID0gdGV4dDtcbiAgICAgICAgICAgICAgICAgICAgYXJyQWN0aXZpdGllcy5wdXNoKG5ld0FjdGl2aXR5KTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gYXJyQWN0aXZpdGllcztcblxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH07XG5cbiAgICAgICAgLy9wdWJsaWMgZ2VkZWVsdGVcbiAgICAgICAgcmV0dXJue1xuXG4gICAgICAgICAgICBnZXRBY3Rpdml0aWVzOmdldEFjdGl2aXRpZXNcblxuICAgICAgICB9O1xuXG4gICAgfTtcblxuICAgIGFuZ3VsYXIubW9kdWxlKFwiYXBwXCIpLmZhY3RvcnkoXCJhY3Rpdml0aWVzU2VydmljZVwiLCBbYWN0aXZpdGllc1NlcnZpY2VdKTtcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBeIGRlemUgbmFhbSBiZXBhYWx0IHdlbGtlIG5hYW0gamUgbm9kaWcgaGVidCBpbiBqZSBjb250cm9sbGVyIGFscyB2ZXJ3aWp6aW5nIVxuXG59KSgpOyovIiwiLyoqXG4gKiBDcmVhdGVkIGJ5IE5pa2l0YSBvbiA3LzAxLzIwMTYuXG4gKi9cblxuXG4oZnVuY3Rpb24gKCkge1xuXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG5cbiAgICB2YXIgY2hhdFNlcnZpY2UgPSBmdW5jdGlvbiAoJHJvb3RTY29wZSkge1xuICAgICAgICB2YXIgc29ja2V0ID0gaW8uY29ubmVjdCh3aW5kb3cubG9jYXRpb24uaG9zdCk7XG5cbiAgICAgICAgdmFyIG9uID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgY2FsbGJhY2spIHtcbiAgICAgICAgICAgIHNvY2tldC5vbihldmVudE5hbWUsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IGFyZ3VtZW50cztcbiAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRhcHBseShmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrLmFwcGx5KHNvY2tldCwgYXJncyk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcblxuICAgICAgICB2YXIgZW1pdCA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGRhdGEsIGNhbGxiYWNrKSB7XG4gICAgICAgICAgICBzb2NrZXQuZW1pdChldmVudE5hbWUsIGRhdGEsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IGFyZ3VtZW50cztcbiAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRhcHBseShmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrLmFwcGx5KHNvY2tldCwgYXJncyk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcblxuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBvbjogb24sXG4gICAgICAgICAgICBlbWl0OiBlbWl0LFxuICAgICAgICAgICAgc29ja2V0OiBzb2NrZXRcbiAgICAgICAgfTtcbiAgICB9O1xuXG4gICAgYW5ndWxhci5tb2R1bGUoXCJhcHBcIikuZmFjdG9yeShcImNoYXRTZXJ2aWNlXCIsIFtcIiRyb290U2NvcGVcIiwgY2hhdFNlcnZpY2VdKTtcblxufSkoKTsiLCIvKipcbiAqIENyZWF0ZWQgYnkgaW1hbiBvbiAxNS8xMi8xNS5cbiAqL1xuXG5cbihmdW5jdGlvbigpe1xuXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG5cbiAgICB2YXIgZGJTZXJ2aWNlID0gZnVuY3Rpb24gKCRodHRwKSB7XG5cbiAgICAgICAgdmFyIGdldENvbGxlY3Rpb24gPSBmdW5jdGlvbiAoY29sbGVjdGlvbikge1xuXG5cbiAgICAgICAgICAgIHZhciB1cmwgPSBcImh0dHA6Ly9sb2NhbGhvc3Q6MzAwMC9hcGkvXCIgKyBjb2xsZWN0aW9uO1xuICAgICAgICAgICAgcmV0dXJuICRodHRwLmdldCh1cmwpLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2Upe1xuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5kYXRhO1xuXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9O1xuXG4gICAgICAgIHZhciBnZXRCeUlEID0gZnVuY3Rpb24gKGNvbGxlY3Rpb24sIGlkKSB7XG4gICAgICAgICAgICB2YXIgdXJsID0gXCJodHRwOi8vbG9jYWxob3N0OjMwMDAvYXBpL1wiICsgY29sbGVjdGlvbiArIFwiL1wiICsgaWQ7XG4gICAgICAgICAgICByZXR1cm4gJGh0dHAuZ2V0KHVybCkudGhlbihmdW5jdGlvbihyZXNwb25zZSl7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH07XG5cbiAgICAgICAgdmFyIGdldERldGFpbHNVc2VyID0gZnVuY3Rpb24gKGNvbGxlY3Rpb24sIHVzZXJuYW1lKSB7XG4gICAgICAgICAgICB2YXIgdXJsID0gXCJodHRwOi8vbG9jYWxob3N0OjMwMDAvYXBpL1wiICsgY29sbGVjdGlvbiArIFwiL3VzZXJkZXRhaWwvXCIgKyB1c2VybmFtZTtcbiAgICAgICAgICAgIHJldHVybiAkaHR0cC5nZXQodXJsKS50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKXtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YTtcblxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfTtcblxuICAgICAgICB2YXIgZGVsZXRlVXNlciA9ICBmdW5jdGlvbiAoY29sbGVjdGlvbiwgdXNlcm5hbWUpIHtcbiAgICAgICAgICAgIHZhciB1cmwgPSBcImh0dHA6Ly9sb2NhbGhvc3Q6MzAwMC9hcGkvXCIgKyBjb2xsZWN0aW9uICsgXCIvdXNlcmRlbGV0ZS9cIiArIHVzZXJuYW1lO1xuICAgICAgICAgICAgcmV0dXJuICRodHRwLmdldCh1cmwpLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7XG5cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuXG5cbiAgICAgICAgdmFyIGdldEl0ZW0gPSBmdW5jdGlvbihpdGVtKXtcblxuICAgICAgICAgICAgdmFyIHVybCA9IFwiaHR0cDovL2xvY2FsaG9zdDozMDAwL2FwaS9cIiArIGl0ZW07XG4gICAgICAgICAgICByZXR1cm4gJGh0dHAuZ2V0KCcvdXNlcicpLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2Upe1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH07XG5cbiAgICAgICAgdmFyIGdldERldGFpbHNBY3Rpdml0eSA9IGZ1bmN0aW9uIChjb2xsZWN0aW9uLCBhY3Rpdml0eW5hbWUpIHtcbiAgICAgICAgICAgIHZhciB1cmwgPSBcImh0dHA6Ly9sb2NhbGhvc3Q6MzAwMC9hcGkvXCIgKyBjb2xsZWN0aW9uICsgXCIvYWN0aXZpdHlkZXRhaWwvXCIgKyBhY3Rpdml0eW5hbWU7XG4gICAgICAgICAgICByZXR1cm4gJGh0dHAuZ2V0KHVybCkudGhlbihmdW5jdGlvbihyZXNwb25zZSl7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH07XG5cbiAgICAgICAgdmFyIGdldE5vaXNlV29yZHMgPSBmdW5jdGlvbiAoKSB7XG5cbiAgICAgICAgICAgIHZhciB1cmwgPSBcImh0dHA6Ly9sb2NhbGhvc3Q6MzAwMC9kYXRhL25vaXNld29yZHMuanNvblwiO1xuICAgICAgICAgICAgcmV0dXJuICRodHRwLmdldCh1cmwpLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2Upe1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH07XG5cblxuICAgICAgICAvL3B1YmxpYyBnZWRlZWx0ZVxuICAgICAgICByZXR1cm57XG5cbiAgICAgICAgICAgIGdldENvbGxlY3Rpb246Z2V0Q29sbGVjdGlvbixcbiAgICAgICAgICAgIGdldEJ5SUQ6Z2V0QnlJRCxcbiAgICAgICAgICAgIGdldEl0ZW06Z2V0SXRlbSxcbiAgICAgICAgICAgIGdldERldGFpbHNVc2VyOiBnZXREZXRhaWxzVXNlcixcbiAgICAgICAgICAgIGRlbGV0ZVVzZXI6IGRlbGV0ZVVzZXIsXG4gICAgICAgICAgICBnZXREZXRhaWxzQWN0aXZpdHk6IGdldERldGFpbHNBY3Rpdml0eSxcbiAgICAgICAgICAgIGdldE5vaXNlV29yZHM6IGdldE5vaXNlV29yZHNcblxuICAgICAgICB9O1xuXG4gICAgfTtcblxuICAgIGFuZ3VsYXIubW9kdWxlKFwiYXBwXCIpLmZhY3RvcnkoXCJkYlNlcnZpY2VcIiwgW1wiJGh0dHBcIiwgZGJTZXJ2aWNlXSk7XG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXiBkZXplIG5hYW0gYmVwYWFsdCB3ZWxrZSBuYWFtIGplIG5vZGlnIGhlYnQgaW4gamUgY29udHJvbGxlciBhbHMgdmVyd2lqemluZyFcblxufSkoKTsiLCIvKipcbiAqIENyZWF0ZWQgYnkgaW1hbiBvbiA1LzEyLzE1LlxuICovXG4oZnVuY3Rpb24oKXtcblxuICAgIFwidXNlIHN0cmljdFwiO1xuXG4gICAgdmFyIG1hdGNoZXNTZXJ2aWNlID0gZnVuY3Rpb24gKCkge1xuXG4gICAgICAgIHZhciBnZXRNYXRjaGVzID0gZnVuY3Rpb24gKG5hbWVVc2VyKSB7XG5cbiAgICAgICAgICAgIHZhciB2YXJpYWJlbFVSTCA9IFwidG9nZXRoZXJcIjtcbiAgICAgICAgICAgIHZhciBsb2NhbFVybCA9IFwiaHR0cDovL2xvY2FsaG9zdDozMDAwL2RhdGEvbWF0Y2hlcy5qc29uXCI7XG4gICAgICAgICAgICB2YXIgeG1sSHR0cCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgICAgICAgICAgeG1sSHR0cC5vcGVuKFwiR0VUXCIsIGxvY2FsVXJsLCBmYWxzZSk7XG4gICAgICAgICAgICB4bWxIdHRwLnNlbmQobnVsbCk7XG5cbiAgICAgICAgICAgIGlmKHhtbEh0dHAuc3RhdHVzID09IDIwMCkge1xuXG4gICAgICAgICAgICAgICAgdmFyIGRhdGEgPSBKU09OLnBhcnNlKHhtbEh0dHAucmVzcG9uc2VUZXh0KTtcbiAgICAgICAgICAgICAgICB2YXIgYXJyID0gW107XG4gICAgICAgICAgICAgICAgdmFyIGFyck1hdGNoZXMgPSBbXTtcbiAgICAgICAgICAgICAgICB2YXIgYXJyTWF0Y2hVc2VycyA9IFtdO1xuICAgICAgICAgICAgICAgIHZhciBhcnJNYXRjaEludGVyZXN0cyA9IFtdO1xuXG4gICAgICAgICAgICAgICAgZm9yKHZhciBpPTA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKXtcblxuICAgICAgICAgICAgICAgICAgICB2YXIgb2JqID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJ1c2VyXCI6IGRhdGFbaV0udXNlcixcbiAgICAgICAgICAgICAgICAgICAgICAgIFwibWF0Y2hlc1wiOmRhdGFbaV0ubWF0Y2hlc1xuICAgICAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgICAgIGFyci5wdXNoKG9iaik7XG5cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBmb3IodmFyIGlpID0gMDsgaWk8YXJyLmxlbmd0aDsgaWkrKyl7XG5cbiAgICAgICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gYXJyW2lpXS51c2VyLmluZGV4T2YobmFtZVVzZXIpO1xuICAgICAgICAgICAgICAgICAgICBpZihpbmRleCA9PT0gMCl7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcnJNYXRjaGVzLnB1c2goYXJyW2lpXS5tYXRjaGVzKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKFwiSW5kZXg6IFwiK2luZGV4KTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKGFycik7XG4gICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhhcnJNYXRjaGVzWzBdKTtcblxuXG4gICAgICAgICAgICAgICAgdmFyIGFyck1hdGNoZXNCeVVzZXIgPSBhcnJNYXRjaGVzWzBdO1xuICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coXCJBYW50YWwgbWF0Y2hlczogXCIgKyBhcnJNYXRjaGVzQnlVc2VyLmxlbmd0aCk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gYXJyTWF0Y2hlc0J5VXNlcjtcblxuICAgICAgICAgICAgICAgIC8qXG4gICAgICAgICAgICAgICAgZm9yKHZhciBpaWkgPSAwOyBpaWk8YXJyTWF0Y2hlc1swXS5sZW5ndGg7IGlpaSsrKXtcblxuICAgICAgICAgICAgICAgICAgICB2YXIgbWF0Y2hVc2VyID0gYXJyTWF0Y2hlc1swXVtpaWldLnVzZXI7XG4gICAgICAgICAgICAgICAgICAgIHZhciBtYXRjaEludGVyZXN0cyA9IGFyck1hdGNoZXNbMF1baWlpXS5pbnRlcmVzdHM7XG5cbiAgICAgICAgICAgICAgICAgICAgYXJyTWF0Y2hVc2Vycy5wdXNoKG1hdGNoVXNlcik7XG4gICAgICAgICAgICAgICAgICAgIGFyck1hdGNoSW50ZXJlc3RzLnB1c2gobWF0Y2hJbnRlcmVzdHMpO1xuXG4gICAgICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2cobWF0Y2hVc2VyKTtcbiAgICAgICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhtYXRjaEludGVyZXN0cyk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYXJyTWF0Y2hVc2Vycyk7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYXJyTWF0Y2hJbnRlcmVzdHMpO1xuICAgICAgICAgICAgICAgICovXG5cbiAgICAgICAgICAgIH1cblxuXG5cbiAgICAgICAgfTtcblxuICAgICAgICAvL3B1YmxpYyBnZWRlZWx0ZVxuICAgICAgICByZXR1cm57XG5cbiAgICAgICAgICAgIGdldE1hdGNoZXM6Z2V0TWF0Y2hlcyxcblxuICAgICAgICB9O1xuXG4gICAgfTtcblxuICAgIGFuZ3VsYXIubW9kdWxlKFwiYXBwXCIpLmZhY3RvcnkoXCJtYXRjaGVzU2VydmljZVwiLCBbbWF0Y2hlc1NlcnZpY2VdKTtcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBeIGRlemUgbmFhbSBiZXBhYWx0IHdlbGtlIG5hYW0gamUgbm9kaWcgaGVidCBpbiBqZSBjb250cm9sbGVyIGFscyB2ZXJ3aWp6aW5nIVxuXG59KSgpOyIsIi8qKlxuICogQ3JlYXRlZCBieSBpbWFuIG9uIDUvMTIvMTUuXG4gKi9cblxuKGZ1bmN0aW9uICgpIHtcblxuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIHZhciBkYXRlVGltZU5vdyA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5zdWJzdHJpbmcoMCwgMTApICsgXCIgXCIgKyBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkuc3Vic3RyaW5nKDExLCAxNik7XG5cbiAgICB2YXIgQWN0aXZpdGllc0NvbnRyb2xsZXIgPSBmdW5jdGlvbiAoJHNjb3BlLCBkYlNlcnZpY2UsICRodHRwLCAkbG9jYXRpb24sICRyb3V0ZVBhcmFtcywgJHJvdXRlKSB7XG4gICAgICAgICRzY29wZS5pbnRlcmVzdGVkQWN0ID0gdHJ1ZTtcbiAgICAgICAgJHNjb3BlLm5hbWVCdXR0b24gPSBcIkludGVyZXN0ZWRcIjtcblxuICAgICAgICAkc2NvcGUuZ2V0QWN0aXZpdGllcyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGRiU2VydmljZS5nZXRDb2xsZWN0aW9uKCdhY3Rpdml0aWVzJykudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHtcblxuICAgICAgICAgICAgICAgIHZhciBhcnJUZW1wID0gcmVzcG9uc2UuYWN0aXZpdGllbGlzdDtcbiAgICAgICAgICAgICAgICB2YXIgYXJyQWN0cyA9IFtdO1xuXG5cbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGFyclRlbXAubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChuZXcgRGF0ZShhcnJUZW1wW2ldLnVudGlsRGF0ZSkuZ2V0VGltZSgpID49IG5ldyBEYXRlKGRhdGVUaW1lTm93KS5nZXRUaW1lKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFyckFjdHMucHVzaChhcnJUZW1wW2ldKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICRzY29wZS5hcnJBY3Rpdml0aWVzID0gYXJyQWN0cztcblxuICAgICAgICAgICAgfSk7XG5cblxuICAgICAgICB9O1xuXG4gICAgICAgIFN0cmluZy5wcm90b3R5cGUucmVwbGFjZUFsbCA9IGZ1bmN0aW9uICh0b2tlbiwgbmV3VG9rZW4sIGlnbm9yZUNhc2UpIHtcbiAgICAgICAgICAgIHZhciBfdG9rZW47XG4gICAgICAgICAgICB2YXIgc3RyID0gdGhpcyArIFwiXCI7XG4gICAgICAgICAgICB2YXIgaSA9IC0xO1xuXG4gICAgICAgICAgICBpZiAodHlwZW9mIHRva2VuID09PSBcInN0cmluZ1wiKSB7XG5cbiAgICAgICAgICAgICAgICBpZiAoaWdub3JlQ2FzZSkge1xuXG4gICAgICAgICAgICAgICAgICAgIF90b2tlbiA9IHRva2VuLnRvTG93ZXJDYXNlKCk7XG5cbiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKChcbiAgICAgICAgICAgICAgICAgICAgICAgIGkgPSBzdHIudG9Mb3dlckNhc2UoKS5pbmRleE9mKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuLCBpID49IDAgPyBpICsgbmV3VG9rZW4ubGVuZ3RoIDogMFxuICAgICAgICAgICAgICAgICAgICAgICAgKSApICE9PSAtMVxuICAgICAgICAgICAgICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdHIgPSBzdHIuc3Vic3RyaW5nKDAsIGkpICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdUb2tlbiArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyLnN1YnN0cmluZyhpICsgdG9rZW4ubGVuZ3RoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3BsaXQodG9rZW4pLmpvaW4obmV3VG9rZW4pO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHN0cjtcbiAgICAgICAgfTtcblxuICAgICAgICBmdW5jdGlvbiBpc0luQXJyYXkodmFsdWUsIGFycmF5KSB7XG4gICAgICAgICAgICByZXR1cm4gYXJyYXkuaW5kZXhPZih2YWx1ZSk7XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBnZXRLZXl3b3Jkc0Zyb21EZXNjcmlwdGlvbihkZXNjcmlwdGlvbiwgY2FsbGJhY2spIHtcblxuICAgICAgICAgICAgZGVzY3JpcHRpb24gPSBkZXNjcmlwdGlvbi5yZXBsYWNlQWxsKCcuJywgJycpO1xuICAgICAgICAgICAgZGVzY3JpcHRpb24gPSBkZXNjcmlwdGlvbi5yZXBsYWNlQWxsKCcsJywgJycpO1xuICAgICAgICAgICAgZGVzY3JpcHRpb24gPSBkZXNjcmlwdGlvbi5yZXBsYWNlQWxsKCc/JywgJycpO1xuICAgICAgICAgICAgZGVzY3JpcHRpb24gPSBkZXNjcmlwdGlvbi5yZXBsYWNlQWxsKCchJywgJycpO1xuICAgICAgICAgICAgZGVzY3JpcHRpb24gPSBkZXNjcmlwdGlvbi5yZXBsYWNlQWxsKCdcIicsICcnKTtcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gZGVzY3JpcHRpb24ucmVwbGFjZUFsbChcIidcIiwgJycpO1xuXG4gICAgICAgICAgICB2YXIgd29yZHMgPSBkZXNjcmlwdGlvbi5zcGxpdChcIiBcIik7XG4gICAgICAgICAgICB2YXIga2V5V29yZHMgPSBcIlwiO1xuXG4gICAgICAgICAgICBkYlNlcnZpY2UuZ2V0Tm9pc2VXb3JkcygpLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7XG5cbiAgICAgICAgICAgICAgICB2YXIgbm9pc2VXb3JkcyA9IHJlc3BvbnNlLm5vaXNld29yZHM7XG5cbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHdvcmRzLmxlbmd0aDsgaSsrKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzSW5BcnJheSh3b3Jkc1tpXS50b0xvd2VyQ2FzZSgpLCBub2lzZVdvcmRzKSA9PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAga2V5V29yZHMgKz0gd29yZHNbaV07XG4gICAgICAgICAgICAgICAgICAgICAgICBrZXlXb3JkcyArPSBcIiBcIjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vcmV0dXJuIGtleVdvcmRzO1xuICAgICAgICAgICAgICAgIGlmICgha2V5V29yZHMuaXNFbXB0eSkge1xuICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhudWxsLCBrZXlXb3Jkcyk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKFwiTm8ga2V5d29yZHMgZm91bmQuXCIsIG51bGwpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBzdHJpbmdDb25zaXN0T2YyTnVtYmVycyhudW1iZXIsIGNhbGxiYWNrKSB7XG4gICAgICAgICAgICB2YXIgb3V0cHV0ID0gbnVtYmVyICsgJyc7XG4gICAgICAgICAgICBpZiAob3V0cHV0Lmxlbmd0aCA8IDIpIHtcbiAgICAgICAgICAgICAgICBvdXRwdXQgPSAnMCcgKyBvdXRwdXQ7XG4gICAgICAgICAgICAgICAgbnVtYmVyID0gb3V0cHV0LnRvU3RyaW5nKCk7XG5cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIG51bWJlciA9IG51bWJlci50b1N0cmluZygpO1xuICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgICAgIGlmICghbnVtYmVyLmlzRW1wdHkpIHtcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhudWxsLCBudW1iZXIpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhcIk5vIG51bWJlci5cIiwgbnVsbCk7XG4gICAgICAgICAgICB9XG5cblxuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gZnVsbERhdGUobnVtYmVyLCBudW1iZXIyLCBjYWxsYmFjaykge1xuICAgICAgICAgICAgc3RyaW5nQ29uc2lzdE9mMk51bWJlcnMobnVtYmVyLCBmdW5jdGlvbiAoZXJyb3IsIG51bWJlclRvU3RyaW5nKSB7XG4gICAgICAgICAgICAgICAgbnVtYmVyID0gbnVtYmVyVG9TdHJpbmc7XG4gICAgICAgICAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycm9yKTtcblxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgc3RyaW5nQ29uc2lzdE9mMk51bWJlcnMobnVtYmVyMiwgZnVuY3Rpb24gKGVycm9yLCBudW1iZXJUb1N0cmluZykge1xuICAgICAgICAgICAgICAgIG51bWJlcjIgPSBudW1iZXJUb1N0cmluZztcbiAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyb3IpO1xuXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGlmICghbnVtYmVyLmlzRW1wdHkgJiYgIW51bWJlcjIuaXNFbXB0eSkge1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIG51bWJlciwgbnVtYmVyMik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKFwiTm8gbnVtYmVyLlwiLCBudWxsKTtcbiAgICAgICAgICAgIH1cblxuXG4gICAgICAgIH1cblxuXG4gICAgICAgICRzY29wZS5hZGRBY3Rpdml0eSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciBhY3Rpdml0eU5hbWUgPSB0aGlzLmFjdGl2aXR5TmFtZTtcbiAgICAgICAgICAgIHZhciBzdHJlZXQgPSB0aGlzLnN0cmVldDtcbiAgICAgICAgICAgIHZhciBudW1iZXIgPSB0aGlzLm51bWJlcjtcbiAgICAgICAgICAgIHZhciB6aXBjb2RlID0gdGhpcy56aXBjb2RlO1xuICAgICAgICAgICAgdmFyIGRlc2NyaXB0aW9uID0gdGhpcy5jb21tZW50O1xuICAgICAgICAgICAgdmFyIGRhdGVGcm9tID0gdGhpcy5kYXRlRnJvbTtcbiAgICAgICAgICAgIHZhciBkYXRlVW50aWwgPSB0aGlzLmRhdGVVbnRpbDtcbiAgICAgICAgICAgIHZhciB0aW1lc3RhbXAgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICAgICAgICAgIHZhciBzdGFydFRpbWVIb3VyID0gdGhpcy5zdGFydFRpbWVIb3VyO1xuICAgICAgICAgICAgdmFyIHN0YXJ0VGltZU1pbiA9IHRoaXMuc3RhcnRUaW1lTWluO1xuICAgICAgICAgICAgdmFyIGVuZFRpbWVIb3VyID0gdGhpcy5lbmRUaW1lSG91cjtcbiAgICAgICAgICAgIHZhciBlbmRUaW1lTWluID0gdGhpcy5lbmRUaW1lTWluO1xuICAgICAgICAgICAgdmFyIGRhdGVGcm9tRGF5ID0gdGhpcy5kYXRlRnJvbURheTtcbiAgICAgICAgICAgIHZhciBkYXRlRnJvbU1vbnRoID0gdGhpcy5kYXRlRnJvbU1vbnRoO1xuICAgICAgICAgICAgdmFyIGRhdGVGcm9tWWVhciA9IHRoaXMuZGF0ZUZyb21ZZWFyLnRvU3RyaW5nKCk7XG4gICAgICAgICAgICB2YXIgZGF0ZVVudGlsRGF5ID0gdGhpcy5kYXRlVW50aWxEYXk7XG4gICAgICAgICAgICB2YXIgZGF0ZVVudGlsTW9udGggPSB0aGlzLmRhdGVVbnRpbE1vbnRoO1xuICAgICAgICAgICAgdmFyIGRhdGVVbnRpbFllYXIgPSB0aGlzLmRhdGVVbnRpbFllYXIudG9TdHJpbmcoKTtcblxuICAgICAgICAgICAgZnVsbERhdGUoZGF0ZUZyb21EYXksIGRhdGVGcm9tTW9udGgsIGZ1bmN0aW9uIChlcnJvciwgZGF0ZUZyb21kYXlTdHJpbmcsIGRhdGVGcm9tTW9udGhTdHJpbmcpIHtcbiAgICAgICAgICAgICAgICBkYXRlRnJvbURheSA9IGRhdGVGcm9tZGF5U3RyaW5nO1xuICAgICAgICAgICAgICAgIGRhdGVGcm9tTW9udGggPSBkYXRlRnJvbU1vbnRoU3RyaW5nO1xuICAgICAgICAgICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnJvcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBmdWxsRGF0ZShkYXRlVW50aWxEYXksIGRhdGVVbnRpbE1vbnRoLCBmdW5jdGlvbiAoZXJyb3IsIGRhdGVVbnRpbERheVN0cmluZywgZGF0ZVVudGlsTW9udGhTdHJpbmcpIHtcbiAgICAgICAgICAgICAgICBkYXRlVW50aWxEYXkgPSBkYXRlVW50aWxEYXlTdHJpbmc7XG4gICAgICAgICAgICAgICAgZGF0ZVVudGlsTW9udGggPSBkYXRlVW50aWxNb250aFN0cmluZztcbiAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyb3IpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG5cbiAgICAgICAgICAgIGlmICgoc3RyZWV0ICE9PSB1bmRlZmluZWQpICYmXG4gICAgICAgICAgICAgICAgKG51bWJlciAhPT0gdW5kZWZpbmVkKSAmJlxuICAgICAgICAgICAgICAgICh6aXBjb2RlICE9PSB1bmRlZmluZWQpICYmXG4gICAgICAgICAgICAgICAgKGRlc2NyaXB0aW9uICE9PSB1bmRlZmluZWQpICYmXG4gICAgICAgICAgICAgICAgKHRpbWVzdGFtcCAhPT0gdW5kZWZpbmVkKSkge1xuXG4gICAgICAgICAgICAgICAgJHNjb3BlLmVycm9yID0gXCJcIjtcblxuICAgICAgICAgICAgICAgIGlmIChzdGFydFRpbWVNaW4gPCA2MCAmJiBzdGFydFRpbWVIb3VyIDwgMjUpIHtcblxuICAgICAgICAgICAgICAgICAgICBzdHJpbmdDb25zaXN0T2YyTnVtYmVycyhzdGFydFRpbWVIb3VyLCBmdW5jdGlvbiAoZXJyb3IsIHN0YXJ0VGltZUhvdXJTdHJpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0VGltZUhvdXIgPSBzdGFydFRpbWVIb3VyU3RyaW5nO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgc3RyaW5nQ29uc2lzdE9mMk51bWJlcnMoc3RhcnRUaW1lTWluLCBmdW5jdGlvbiAoZXJyb3IsIHN0YXJ0VGltZU1pblN0cmluZykge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRUaW1lTWluID0gc3RhcnRUaW1lTWluU3RyaW5nO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyb3IpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHN0YXJ0VGltZUhvdXIpO1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhzdGFydFRpbWVNaW4pO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGFydFRpbWVNaW4ubGVuZ3RoID09PSAyICYmIHN0YXJ0VGltZUhvdXIubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcImplIGtvbXQgaGllciB0ZXJlY2h0XCIpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZW5kVGltZU1pbiA8IDYwICYmIGVuZFRpbWVIb3VyIDwgMjQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmdDb25zaXN0T2YyTnVtYmVycyhlbmRUaW1lSG91ciwgZnVuY3Rpb24gKGVycm9yLCBlbmRUaW1lSG91clN0cmluZykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmRUaW1lSG91ciA9IGVuZFRpbWVIb3VyU3RyaW5nO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmluZ0NvbnNpc3RPZjJOdW1iZXJzKGVuZFRpbWVNaW4sIGZ1bmN0aW9uIChlcnJvciwgZW5kVGltZU1pblN0cmluZykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmRUaW1lTWluID0gZW5kVGltZU1pblN0cmluZztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnJvcik7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZW5kVGltZUhvdXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVuZFRpbWVNaW4pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVuZFRpbWVNaW4udG9TdHJpbmcoKS5sZW5ndGggPT09IDIgJiYgZW5kVGltZUhvdXIudG9TdHJpbmcoKS5sZW5ndGggPT09IDIpIHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhzdGFydFRpbWVIb3VyICsgXCI6XCIgKyBzdGFydFRpbWVNaW4pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldEtleXdvcmRzRnJvbURlc2NyaXB0aW9uKGRlc2NyaXB0aW9uLCBmdW5jdGlvbiAoZXJyb3IsIGRhdGEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gZGF0YTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhzdGFydFRpbWVIb3VyICsgXCI6XCIgKyBzdGFydFRpbWVNaW4pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHVybCA9IFwiaHR0cDovL2xvY2FsaG9zdDozMDAwL2FwaS9hY3Rpdml0aWVzL2FkZGFjdGl2aXR5XCI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGh0dHAucG9zdCh1cmwsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZpdHlOYW1lOiBhY3Rpdml0eU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmVldDogc3RyZWV0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBudW1iZXI6IG51bWJlcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgemlwY29kZTogemlwY29kZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IGRlc2NyaXB0aW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRlRnJvbTogZGF0ZUZyb21ZZWFyICsgXCItXCIgKyBkYXRlRnJvbU1vbnRoICsgXCItXCIgKyBkYXRlRnJvbURheSArIFwiIFwiICsgc3RhcnRUaW1lSG91ciArIFwiOlwiICsgc3RhcnRUaW1lTWluLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRlVW50aWw6IGRhdGVVbnRpbFllYXIgKyBcIi1cIiArIGRhdGVGcm9tTW9udGggKyBcIi1cIiArIGRhdGVVbnRpbERheSArIFwiIFwiICsgZW5kVGltZUhvdXIgKyBcIjpcIiArIGVuZFRpbWVNaW4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogdGltZXN0YW1wXG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KS5zdWNjZXNzKGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5lcnJvciA9IGRhdGEuZXJyb3I7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5nZXRBY3Rpdml0aWVzKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc2V0Rm9ybSgpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vJGxvY2F0aW9uLnBhdGgoZGF0YS5yZWRpcmVjdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5lcnJvciA9IFwiRW5kZGF0ZSBpbnB1dCBpcyBub3QgY29ycmVjdFwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmVycm9yID0gXCJFbmR0aW1lIGlucHV0IGlzIG5vdCBjb3JyZWN0XCI7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmVycm9yID0gJ0RlIHN0YXJ0aW1lIGxlbmd0aCBpcyBub3QgY29ycmVjdCEhISEgJztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmVycm9yID0gXCJTdGFydHRpbWUgaW5wdXQgaXMgbm90IGNvcnJlY3RcIjtcbiAgICAgICAgICAgICAgICB9XG5cblxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgJHNjb3BlLmVycm9yID0gXCJFUlJPUjogQWxsIGZpZWxkcyBhcmUgcmVxdWlyZWQuODg4OFwiO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgICRzY29wZS5nZXREZXRhaWxBY3Rpdml0eSA9IGZ1bmN0aW9uIChjdXJyZW50VXNlcikge1xuICAgICAgICAgICAgZGJTZXJ2aWNlLmdldERldGFpbHNBY3Rpdml0eSgnYWN0aXZpdGllcycsICRyb3V0ZVBhcmFtcy5hY3Rpdml0eU5hbWUpLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgJHNjb3BlLmFyckRldGFpbHNBY3Rpdml0eSA9IHJlc3BvbnNlLmFjdGl2aXR5O1xuICAgICAgICAgICAgICAgIGluaXRtYXAoKTtcblxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCRzY29wZS5hcnJEZXRhaWxzQWN0aXZpdHkubWF0Y2hlcyk7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCAkc2NvcGUuYXJyRGV0YWlsc0FjdGl2aXR5Lm1hdGNoZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCRzY29wZS5hcnJEZXRhaWxzQWN0aXZpdHkubWF0Y2hlc1tpXSA9PT0gY3VycmVudFVzZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5uYW1lQnV0dG9uID0gXCJOb3QgaW50ZXJlc3RlZFwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmludGVyZXN0ZWRBY3QgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gJHNjb3BlLmFyckRldGFpbHNBY3Rpdml0eTtcblxuXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcblxuICAgICAgICAkc2NvcGUuaW50ZXJlc3RlZCA9IGZ1bmN0aW9uIChhY3Rpdml0eU5hbWUsIGludGVyZXN0ZWRVc2VyLCBjcmVhdGVyVXNlcikge1xuICAgICAgICAgICAgdmFyIHVybCA9IFwiXCI7XG4gICAgICAgICAgICB2YXIgaW50ZXJlc3RlZEFjdCA9ICRzY29wZS5pbnRlcmVzdGVkQWN0O1xuICAgICAgICAgICAgaWYgKGludGVyZXN0ZWRBY3QgIT09IGZhbHNlKSB7XG5cbiAgICAgICAgICAgICAgICB1cmwgPSBcImh0dHA6Ly9sb2NhbGhvc3Q6MzAwMC9hcGkvYWN0aXZpdGllcy9pbnRlcmVzdGVkXCI7XG4gICAgICAgICAgICAgICAgJGh0dHAucG9zdCh1cmwsIHtcbiAgICAgICAgICAgICAgICAgICAgYWN0aXZpdHlOYW1lOiBhY3Rpdml0eU5hbWUsXG4gICAgICAgICAgICAgICAgICAgIGludGVyZXN0ZWRVc2VyOiBpbnRlcmVzdGVkVXNlcixcbiAgICAgICAgICAgICAgICAgICAgY3JlYXRlclVzZXI6IGNyZWF0ZXJVc2VyXG4gICAgICAgICAgICAgICAgfSkuc3VjY2VzcyhmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coaW50ZXJlc3RlZFVzZXIgKyBcIiBpcyBnZcOvbnRlcmVzc2VlcmQgaW4gXCIgKyBhY3Rpdml0eU5hbWUgKyBcIiBkb29yIFwiICsgY3JlYXRlclVzZXIpO1xuICAgICAgICAgICAgICAgICAgICAkc2NvcGUuaW50ZXJlc3RlZEFjdCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAkc2NvcGUubmFtZUJ1dHRvbiA9IFwiTm90IGludGVyZXN0ZWRcIjtcbiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmVycm9yID0gZGF0YS5lcnJvcjtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coaW50ZXJlc3RlZEFjdCk7XG4gICAgICAgICAgICAgICAgdXJsID0gXCJodHRwOi8vbG9jYWxob3N0OjMwMDAvYXBpL2FjdGl2aXRpZXMvZGVsZXRlaW50ZXJlc3RlZFwiO1xuICAgICAgICAgICAgICAgICRodHRwLnBvc3QodXJsLCB7XG4gICAgICAgICAgICAgICAgICAgIGFjdGl2aXR5TmFtZTogYWN0aXZpdHlOYW1lLFxuICAgICAgICAgICAgICAgICAgICBpbnRlcmVzdGVkVXNlcjogaW50ZXJlc3RlZFVzZXIsXG4gICAgICAgICAgICAgICAgICAgIGNyZWF0ZXJVc2VyOiBjcmVhdGVyVXNlclxuICAgICAgICAgICAgICAgIH0pLnN1Y2Nlc3MoZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGludGVyZXN0ZWRVc2VyICsgXCIgaXMgbmlldCBtZWVyIGdlw69udGVyZXNzZWVyZCBpbiBcIiArIGFjdGl2aXR5TmFtZSArIFwiIGRvb3IgXCIgKyBjcmVhdGVyVXNlcik7XG4gICAgICAgICAgICAgICAgICAgICRzY29wZS5pbnRlcmVzdGVkQWN0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLm5hbWVCdXR0b24gPSBcIkludGVyZXN0ZWRcIjtcblxuICAgICAgICAgICAgICAgICAgICAkc2NvcGUuZXJyb3IgPSBkYXRhLmVycm9yO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIGZ1bmN0aW9uIHJlY2VudEZpcnN0KGEsIGIpIHtcbiAgICAgICAgICAgIGlmIChhLnRpbWVzdGFtcCA+IGIudGltZXN0YW1wKVxuICAgICAgICAgICAgICAgIHJldHVybiAtMTtcbiAgICAgICAgICAgIGlmIChhLnRpbWVzdGFtcCA8IGIudGltZXN0YW1wKVxuICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBwb3B1bGFyRmlyc3QoYXJyKSB7XG4gICAgICAgICAgICB2YXIgbWF4ID0gYXJyWzBdO1xuICAgICAgICAgICAgdmFyIG1heEluZGV4ID0gMDtcblxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBpZiAoYXJyW2ldLm1hdGNoZXMubGVuZ3RoID4gbWF4Lm1hdGNoZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIG1heEluZGV4ID0gaTtcbiAgICAgICAgICAgICAgICAgICAgbWF4ID0gYXJyW2ldO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIG1heEluZGV4O1xuICAgICAgICB9XG5cbiAgICAgICAgJHNjb3BlLnNob3dBY3Rpdml0aWVzT25Ib21lUGFnZSA9IGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICAkc2NvcGUuZ2V0TW9zdFJlY2VudEFjdGl2aXRpZXMoKTtcbiAgICAgICAgICAgICRzY29wZS5nZXRNb3N0UG9wdWxhckFjdGl2aXRpZXMoKTtcbiAgICAgICAgfTtcblxuICAgICAgICAkc2NvcGUuZ2V0TW9zdFJlY2VudEFjdGl2aXRpZXMgPSBmdW5jdGlvbiAoKSB7XG5cbiAgICAgICAgICAgIGRiU2VydmljZS5nZXRDb2xsZWN0aW9uKCdhY3Rpdml0aWVzJykudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICB2YXIgbnVtYmVyT2ZBY3Rpdml0aWVzID0gMztcbiAgICAgICAgICAgICAgICB2YXIgYXJyVGVtcCA9IHJlc3BvbnNlLmFjdGl2aXRpZWxpc3Q7XG4gICAgICAgICAgICAgICAgdmFyIGFyckFsbEFjdGl2aXRpZXMgPSBbXTtcblxuXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBhcnJUZW1wLmxlbmd0aDsgaSA8IGw7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBpZiAobmV3IERhdGUoYXJyVGVtcFtpXS51bnRpbERhdGUpLmdldFRpbWUoKSA+PSBuZXcgRGF0ZShkYXRlVGltZU5vdykuZ2V0VGltZSgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhuZXcgRGF0ZShhcnJUZW1wW2ldLnVudGlsRGF0ZSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYXJyQWxsQWN0aXZpdGllcy5wdXNoKGFyclRlbXBbaV0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgYXJyQWxsQWN0aXZpdGllcy5zb3J0KHJlY2VudEZpcnN0KTtcblxuICAgICAgICAgICAgICAgIHZhciBhcnJNb3N0UmVjZW50QWN0aXZpdGllcyA9IFtdO1xuXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaWkgPSAwOyBpaSA8IG51bWJlck9mQWN0aXZpdGllczsgaWkrKykge1xuICAgICAgICAgICAgICAgICAgICBhcnJNb3N0UmVjZW50QWN0aXZpdGllcy5wdXNoKGFyckFsbEFjdGl2aXRpZXNbaWldKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB2YXIgbWF0Y2hlcyA9IFtdO1xuXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaWlpID0gMDsgaWlpIDwgYXJyTW9zdFJlY2VudEFjdGl2aXRpZXMubGVuZ3RoOyBpaWkrKykge1xuXG4gICAgICAgICAgICAgICAgICAgIHZhciBkdW1teUFjdGl2aXR5ID0gbmV3IEFjdGl2aXR5KFwiTm8gbmFtZVwiLCA4NTAwLCBcIlRvZ2V0aGVyXCIsIDIsIFwibm8gZGVzY3JpcHRpb25cIiwgXCIyMDE2LTAxLTAxIDAwOjAxXCIsIFwiMjAxNy0xMi0zMSAyMzo1OVwiLCBuZXcgRGF0ZSgpLCBcIm5vIHVzZXJuYW1lXCIsIG1hdGNoZXMpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYXJyTW9zdFJlY2VudEFjdGl2aXRpZXNbaWlpXSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcnJNb3N0UmVjZW50QWN0aXZpdGllcy5zcGxpY2UoaWlpLCAxLCBkdW1teUFjdGl2aXR5KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAkc2NvcGUuYXJyTW9zdFJlY2VudEFjdGl2aXRpZXMgPSBhcnJNb3N0UmVjZW50QWN0aXZpdGllcztcblxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgJHNjb3BlLmdldE1vc3RQb3B1bGFyQWN0aXZpdGllcyA9IGZ1bmN0aW9uKCl7XG5cbiAgICAgICAgICAgIGRiU2VydmljZS5nZXRDb2xsZWN0aW9uKCdhY3Rpdml0aWVzJykudGhlbihmdW5jdGlvbihyZXNwb25zZSl7XG5cbiAgICAgICAgICAgICAgICB2YXIgbnVtYmVyT2ZBY3Rpdml0aWVzID0gMztcbiAgICAgICAgICAgICAgICB2YXIgYXJyVGVtcCA9IHJlc3BvbnNlLmFjdGl2aXRpZWxpc3Q7XG4gICAgICAgICAgICAgICAgdmFyIGFyckFsbEFjdGl2aXRpZXMgPSBbXTtcblxuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gYXJyVGVtcC5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYobmV3IERhdGUoYXJyVGVtcFtpXS51bnRpbERhdGUpLmdldFRpbWUoKSA+PSBuZXcgRGF0ZShkYXRlVGltZU5vdykuZ2V0VGltZSgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKG5ldyBEYXRlKGFyclRlbXBbaV0udW50aWxEYXRlKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcnJBbGxBY3Rpdml0aWVzLnB1c2goYXJyVGVtcFtpXSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB2YXIgYXJyTW9zdFBvcHVsYXJBY3Rpdml0aWVzID0gW107XG5cbiAgICAgICAgICAgICAgICBmb3IodmFyIGogPSAwOyBqIDwgbnVtYmVyT2ZBY3Rpdml0aWVzOyBqKyspe1xuXG4gICAgICAgICAgICAgICAgICAgIHZhciBpbmRleE1vc3RQb3AgPSBwb3B1bGFyRmlyc3QoYXJyQWxsQWN0aXZpdGllcyk7XG4gICAgICAgICAgICAgICAgICAgIGFyck1vc3RQb3B1bGFyQWN0aXZpdGllcy5wdXNoKGFyckFsbEFjdGl2aXRpZXNbaW5kZXhNb3N0UG9wXSk7XG4gICAgICAgICAgICAgICAgICAgIGFyckFsbEFjdGl2aXRpZXMuc3BsaWNlKGluZGV4TW9zdFBvcCwgMSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgJHNjb3BlLmFyck1vc3RQb3B1bGFyQWN0aXZpdGllcyA9IGFyck1vc3RQb3B1bGFyQWN0aXZpdGllcztcblxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG5cblxuXG4gICAgICAgIGZ1bmN0aW9uIGdlb2NvZGVBZGRyZXNzKGdlb2NvZGVyLCByZXN1bHRzTWFwKSB7XG4gICAgICAgICAgICB2YXIgc3RyZWV0ID0gJHNjb3BlLmFyckRldGFpbHNBY3Rpdml0eS5zdHJlZXQ7XG4gICAgICAgICAgICB2YXIgbnVtYmVyID0gJHNjb3BlLmFyckRldGFpbHNBY3Rpdml0eS5udW1iZXI7XG4gICAgICAgICAgICB2YXIgemlwY29kZSA9ICRzY29wZS5hcnJEZXRhaWxzQWN0aXZpdHkuemlwY29kZTtcblxuICAgICAgICAgICAgdmFyIGFkZHJlc3MgPSBzdHJlZXQgKyBcIiBcIiArIG51bWJlciArIFwiLCBcIiArIHppcGNvZGU7IC8vaGllciBhZGRyZXNzIHVpdCBkYiBpbnN0b3BwZW5cblxuICAgICAgICAgICAgZ2VvY29kZXIuZ2VvY29kZSh7J2FkZHJlc3MnOiBhZGRyZXNzfSwgZnVuY3Rpb24gKHJlc3VsdHMsIHN0YXR1cykge1xuICAgICAgICAgICAgICAgIGlmIChzdGF0dXMgPT09IGdvb2dsZS5tYXBzLkdlb2NvZGVyU3RhdHVzLk9LKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdHNNYXAuc2V0Q2VudGVyKHJlc3VsdHNbMF0uZ2VvbWV0cnkubG9jYXRpb24pO1xuICAgICAgICAgICAgICAgICAgICB2YXIgbWFya2VyID0gbmV3IGdvb2dsZS5tYXBzLk1hcmtlcih7XG4gICAgICAgICAgICAgICAgICAgICAgICBtYXA6IHJlc3VsdHNNYXAsXG4gICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogcmVzdWx0c1swXS5nZW9tZXRyeS5sb2NhdGlvblxuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhtYXJrZXIpO1xuXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgYWxlcnQoJ0dlb2NvZGUgd2FzIG5vdCBzdWNjZXNzZnVsIGZvciB0aGUgZm9sbG93aW5nIHJlYXNvbjogJyArIHN0YXR1cyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiByZXNldEZvcm0oKSB7XG4gICAgICAgICAgICB2YXIgZnJtID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeU5hbWUoJ0FjdGl2aXR5Rm9ybScpWzBdO1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ2plIGtvbXQgaW4gZGUgcmVzZXRmb3JtJyk7XG4gICAgICAgICAgICBmcm0ucmVzZXQoKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBhbmd1bGFyLm1vZHVsZShcImFwcFwiKS5jb250cm9sbGVyKFwiQWN0aXZpdGllc0NvbnRyb2xsZXJcIiwgW1wiJHNjb3BlXCIsIFwiZGJTZXJ2aWNlXCIsIFwiJGh0dHBcIiwgXCIkbG9jYXRpb25cIiwgXCIkcm91dGVQYXJhbXNcIiwgXCJmaWxlVXBsb2FkXCIsIEFjdGl2aXRpZXNDb250cm9sbGVyXSk7XG5cblxufSkoKTsiLCIvKipcbiAqIENyZWF0ZWQgYnkgTmlraXRhIG9uIDcvMDEvMjAxNi5cbiAqL1xuKGZ1bmN0aW9uICgpIHtcblxuICAgIFwidXNlIHN0cmljdFwiO1xuXG4gICAgdmFyIENoYXRDb250cm9sbGVyID0gZnVuY3Rpb24oJHNjb3BlLCAkcm9vdFNjb3BlLCAkcm91dGVQYXJhbXMsIGRiU2VydmljZSwgJGh0dHApIHtcblxuICAgICAgICBjb25zb2xlLmxvZygkcm9vdFNjb3BlLmN1cnJlbnRVc2VyLnVzZXJuYW1lKTtcbiAgICAgICAgY29uc29sZS5sb2coJHJvb3RTY29wZS5jb250YWN0ZWRVc2VyLnVzZXJuYW1lKTtcbiAgICAgICAgLy8kc2NvcGUuY29udGFjdGVkVXNlci51c2VybmFtZSA9ICRyb290U2NvcGUuY29udGFjdGVkVXNlci51c2VybmFtZTtcblxuICAgICAgICAkc2NvcGUuaW5pdCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGNoYXRTZXJ2aWNlLmVtaXQoXCJpbml0X3VzZXJzXCIse3VzZXI6JHJvb3RTY29wZS5jdXJyZW50VXNlciwgY29sbGVjdGlvbjpcInVzZXJzXCJ9KTtcbiAgICAgICAgfTtcblxuICAgIH07XG4gICAgYW5ndWxhci5tb2R1bGUoXCJhcHBcIikuY29udHJvbGxlcihcIkNoYXRDb250cm9sbGVyXCIsIFtcIiRzY29wZVwiLCBcIiRyb290U2NvcGVcIiwgXCIkcm91dGVQYXJhbXNcIiwgXCJkYlNlcnZpY2VcIixcIiRodHRwXCIsIENoYXRDb250cm9sbGVyXSk7XG5cbn0pKCk7IiwiLyoqXG4gKiBDcmVhdGVkIGJ5IGltYW4gb24gNS8xMi8xNS5cbiAqL1xuXG4oZnVuY3Rpb24oKXtcblxuICAgIFwidXNlIHN0cmljdFwiO1xuXG4gICAgdmFyIE1hdGNoZXNDb250cm9sbGVyID0gZnVuY3Rpb24oJHNjb3BlLCBkYlNlcnZpY2UpIHtcblxuICAgICAgICB2YXIgY2xpY2tzT25CdG4gPSAwO1xuXG4gICAgICAgICRzY29wZS5zaG93RGl2ID0gZnVuY3Rpb24oKXtcbiAgICAgICAgICAgICRzY29wZS5maWx0ZXIgPSB7c2hvd0ZpbHRlcjp0cnVlfTtcbiAgICAgICAgICAgIGNsaWNrc09uQnRuKys7XG5cbiAgICAgICAgICAgIGlmKGNsaWNrc09uQnRuID4gMSl7XG4gICAgICAgICAgICAgICAgJHNjb3BlLmZpbHRlciA9IHtzaG93RmlsdGVyOmZhbHNlfTtcbiAgICAgICAgICAgICAgICBjbGlja3NPbkJ0biA9IDA7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgJHNjb3BlLmhpZGVEaXYgPSBmdW5jdGlvbigpe1xuICAgICAgICAgICAgY2xpY2tzT25CdG4gPSAwO1xuICAgICAgICAgICAgJHNjb3BlLmZpbHRlciA9IHtzaG93RmlsdGVyOmZhbHNlfTtcbiAgICAgICAgfTtcblxuICAgICAgICAkc2NvcGUuc29ydFByb3BlcnR5ID0gXCJ0aXRsZVwiO1xuICAgICAgICAkc2NvcGUuZmlsdGVyUXVlcnkgPSBcIlwiO1xuICAgICAgICAkc2NvcGUuZmlsdGVyTWF0Y2hlcyA9IGZ1bmN0aW9uKGkpe1xuICAgICAgICAgICAgaWYoJHNjb3BlLmZpbHRlclF1ZXJ5ID09PSBcIlwiKXtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLypcbiAgICAgICAgICAgICBlbHNlIGlmKGkudXNlcm5hbWUudG9Mb3dlckNhc2UoKS5pbmRleE9mKCRzY29wZS5maWx0ZXJRdWVyeS50b0xvY2FsZUxvd2VyQ2FzZSgpKSA+PSAwKXtcbiAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgKi9cblxuICAgICAgICAgICAgZWxzZSBpZihpLnNleCA9PT0gdW5kZWZpbmVkKXtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGVsc2UgaWYoJHNjb3BlLmZpbHRlclF1ZXJ5LnRvTG93ZXJDYXNlKCkgPT0gaS5zZXgudG9Mb3dlckNhc2UoKSl7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGVsc2UgaWYoJHNjb3BlLmZpbHRlclF1ZXJ5LnRvTG93ZXJDYXNlKCkgPT09IFwibm9maWx0ZXJcIil7XG4gICAgICAgICAgICAgICAgJHNjb3BlLmZpbHRlclF1ZXJ5ID0gXCJcIjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8qXG4gICAgICAgICRzY29wZS5zaG93TWF0Y2hlcyA9IGZ1bmN0aW9uKCl7XG5cbiAgICAgICAgICAgIHZhciBuYW1lVXNlciA9IFwiTHVuYVwiO1xuXG4gICAgICAgICAgICB2YXIgYXJyTWF0Y2hlc0J5VXNlciA9IG1hdGNoZXNTZXJ2aWNlLmdldE1hdGNoZXMobmFtZVVzZXIpO1xuXG4gICAgICAgICAgICAkc2NvcGUuYWFudGFsTWF0Y2hlcyA9IGFyck1hdGNoZXNCeVVzZXIubGVuZ3RoO1xuXG4gICAgICAgICAgICAkc2NvcGUuYXJyTWF0Y2hlcyA9IGFyck1hdGNoZXNCeVVzZXI7XG5cbiAgICAgICAgICAgIHZhciB0ZXh0ID0gXCJcIjtcbiAgICAgICAgICAgIGZvcih2YXIgaT0wOyBpPGFyck1hdGNoZXNCeVVzZXIubGVuZ3RoOyBpKyspe1xuICAgICAgICAgICAgICAgIHRleHQgPSBhcnJNYXRjaGVzQnlVc2VyW2ldLmludGVyZXN0cy50b1N0cmluZygpLnJlcGxhY2UoXCIgLFwiLCBcIiBcIik7XG4gICAgICAgICAgICAgICAgYXJyTWF0Y2hlc0J5VXNlcltpXS5pbnRlcmVzdHMgPSB0ZXh0O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgIH07XG4gICAgICAgICovXG5cbiAgICAgICAgLy9odHRwOi8vd3d3LmZhbHNlcG9zaXRpdmVzLmNvbS9pbmRleC5waHAvMjAwOS8xMi8wMS9qYXZhc2NyaXB0LWZ1bmN0aW9uLXRvLWdldC10aGUtaW50ZXJzZWN0LW9mLTItYXJyYXlzL1xuICAgICAgICBmdW5jdGlvbiBpbnRlcnNlY3QoYXJyMSwgYXJyMilcbiAgICAgICAge1xuICAgICAgICAgICAgdmFyIHIgPSBbXSwgbyA9IHt9LCBsID0gYXJyMi5sZW5ndGgsIGksIHY7XG4gICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgb1thcnIyW2ldXSA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBsID0gYXJyMS5sZW5ndGg7XG4gICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgdiA9IGFycjFbaV07XG4gICAgICAgICAgICAgICAgaWYgKHYgaW4gbykge1xuICAgICAgICAgICAgICAgICAgICByLnB1c2godik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gcjtcbiAgICAgICAgfVxuXG4gICAgICAgICRzY29wZS5zaG93TWF0Y2hlcyA9IGZ1bmN0aW9uKCl7XG5cbiAgICAgICAgICAgIC8qXG4gICAgICAgICAgICAgdmFyIHVzZXJuYW1lID0gXCJcIjtcbiAgICAgICAgICAgICBpZigkcm9vdFNjb3BlLnVzZXIudXNlcm5hbWUgIT09IHVuZGVmaW5lZCl7XG4gICAgICAgICAgICAgdXNlcm5hbWUgPSAkcm9vdFNjb3BlLnVzZXIudXNlcm5hbWU7XG4gICAgICAgICAgICAgfVxuICAgICAgICAgICAgICovXG5cbiAgICAgICAgICAgIHZhciB1c2VybmFtZTtcblxuICAgICAgICAgICAgdXNlcm5hbWUgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShcInVzZXJuYW1lXCIpO1xuXG4gICAgICAgICAgICBkYlNlcnZpY2UuZ2V0Q29sbGVjdGlvbigndXNlcnMnKS50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKXtcblxuICAgICAgICAgICAgICAgIHZhciBhcnJQcm9maWxlcyA9IHJlc3BvbnNlLnVzZXJsaXN0O1xuICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBhcnJQcm9maWxlcy5sZW5ndGg7IGkrKyl7XG4gICAgICAgICAgICAgICAgICAgIGlmKGFyclByb2ZpbGVzW2ldLnVzZXJuYW1lID09PSB1c2VybmFtZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXJyUHJvZmlsZXMuc3BsaWNlKGksIDEpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGZvcih2YXIgaWkgPSAwOyBpaSA8IGFyclByb2ZpbGVzLmxlbmd0aDsgaWkrKyl7XG4gICAgICAgICAgICAgICAgICAgIGlmKGFyclByb2ZpbGVzW2lpXS51c2VybmFtZSA9PT0gXCJhZG1pblwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcnJQcm9maWxlcy5zcGxpY2UoaWksIDEpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgICAgICAgICBkYlNlcnZpY2UuZ2V0SXRlbSh1c2VybmFtZSkudGhlbihmdW5jdGlvbihyZXNwb25zZSl7XG5cbiAgICAgICAgICAgICAgICAgICAgdmFyIHVzZXIgPSByZXNwb25zZTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGFyck1hdGNoZXMgPSBbXTtcblxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyh1c2VyLmludGVyZXN0cyk7XG5cbiAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBpPTAsIGw9YXJyUHJvZmlsZXMubGVuZ3RoOyBpPGw7IGkrKyl7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzYW1lSW50ZXJlc3RzID0gW107XG4gICAgICAgICAgICAgICAgICAgICAgICBzYW1lSW50ZXJlc3RzID0gaW50ZXJzZWN0KHVzZXIuaW50ZXJlc3RzLCBhcnJQcm9maWxlc1tpXS5pbnRlcmVzdHMpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZihzYW1lSW50ZXJlc3RzLmxlbmd0aCAhPT0gMCl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyTWF0Y2hlcy5wdXNoKGFyclByb2ZpbGVzW2ldKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmFyck1hdGNoZXMgPSBhcnJNYXRjaGVzO1xuXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcblxuICAgIH07XG5cbiAgICBhbmd1bGFyLm1vZHVsZShcImFwcFwiKS5jb250cm9sbGVyKFwiTWF0Y2hlc0NvbnRyb2xsZXJcIiwgW1wiJHNjb3BlXCIsIFwiZGJTZXJ2aWNlXCIsIE1hdGNoZXNDb250cm9sbGVyXSk7XG5cbn0pKCk7IiwiLyoqXG4gKiBDcmVhdGVkIGJ5IGltYW4gb24gMjAvMTIvMTUuXG4gKi9cblxuXG4oZnVuY3Rpb24oKXtcblxuICAgIFwidXNlIHN0cmljdFwiO1xuXG4gICAgdmFyIFByb2ZpbGVzQ29udHJvbGxlciA9IGZ1bmN0aW9uKCRzY29wZSwgJHJvb3RTY29wZSwgJHJvdXRlUGFyYW1zLCBkYlNlcnZpY2UsICRodHRwLCAkbG9jYXRpb24pIHtcblxuICAgICAgICB2YXIgY2xpY2tzT25CdG4gPSAwO1xuICAgICAgICAkc2NvcGUuc3RhcnRDaGF0ID0gZnVuY3Rpb24oY3VycmVudFVzZXIsIGNvbnRhY3RlZFVzZXIpe1xuICAgICAgICAgICAgJGh0dHAucG9zdChcIi9jaGF0XCIsIHtcbiAgICAgICAgICAgICAgICBjdXJyZW50VXNlcjogY3VycmVudFVzZXIsXG4gICAgICAgICAgICAgICAgY29udGFjdGVkVXNlcjpjb250YWN0ZWRVc2VyXG5cbiAgICAgICAgICAgIH0pLnN1Y2Nlc3MoZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgICAgICAgICAkc2NvcGUuZXJyb3IgPSBkYXRhLmVycm9yO1xuICAgICAgICAgICAgICAgICRyb290U2NvcGUuY3VycmVudFVzZXIgPSBkYXRhLmN1cnJlbnRVc2VyO1xuICAgICAgICAgICAgICAgICRyb290U2NvcGUuY29udGFjdGVkVXNlciA9IGRhdGEuY29udGFjdGVkVXNlcjtcblxuICAgICAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFwiY3VycmVudHVzZXJuYW1lXCIsICRyb290U2NvcGUuY3VycmVudFVzZXIudXNlcm5hbWUpO1xuICAgICAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFwiY29udGFjdGVkdXNlcm5hbWVcIiwgJHJvb3RTY29wZS5jb250YWN0ZWRVc2VyLnVzZXJuYW1lKTtcblxuICAgICAgICAgICAgICAgICRsb2NhdGlvbi5wYXRoKGRhdGEucmVkaXJlY3QpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG5cblxuXG4gICAgICAgICRzY29wZS5zaG93RGl2ID0gZnVuY3Rpb24oKXtcbiAgICAgICAgICAgICRzY29wZS5maWx0ZXIgPSB7c2hvd0ZpbHRlcjp0cnVlfTtcbiAgICAgICAgICAgIGNsaWNrc09uQnRuKys7XG5cbiAgICAgICAgICAgIGlmKGNsaWNrc09uQnRuID4gMSl7XG4gICAgICAgICAgICAgICAgJHNjb3BlLmZpbHRlciA9IHtzaG93RmlsdGVyOmZhbHNlfTtcbiAgICAgICAgICAgICAgICBjbGlja3NPbkJ0biA9IDA7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgJHNjb3BlLmhpZGVEaXYgPSBmdW5jdGlvbigpe1xuICAgICAgICAgICAgY2xpY2tzT25CdG4gPSAwO1xuICAgICAgICAgICAgJHNjb3BlLmZpbHRlciA9IHtzaG93RmlsdGVyOmZhbHNlfTtcbiAgICAgICAgfTtcblxuICAgICAgICAkc2NvcGUuc2hvd1Byb2ZpbGVzID0gZnVuY3Rpb24oKXtcblxuICAgICAgICAgICAgLypcbiAgICAgICAgICAgIHZhciB1c2VybmFtZSA9IFwiXCI7XG4gICAgICAgICAgICBpZigkcm9vdFNjb3BlLnVzZXIudXNlcm5hbWUgIT09IHVuZGVmaW5lZCl7XG4gICAgICAgICAgICAgICAgdXNlcm5hbWUgPSAkcm9vdFNjb3BlLnVzZXIudXNlcm5hbWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAqL1xuICAgICAgICAgICAgdmFyIHVzZXJuYW1lID0gXCJcIjtcbiAgICAgICAgICAgIHVzZXJuYW1lID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oXCJ1c2VybmFtZVwiKTtcblxuICAgICAgICAgICAgZGJTZXJ2aWNlLmdldENvbGxlY3Rpb24oJ3VzZXJzJykudGhlbihmdW5jdGlvbihyZXNwb25zZSl7XG5cbiAgICAgICAgICAgICAgICB2YXIgYXJyUHJvZmlsZXMgPSByZXNwb25zZS51c2VybGlzdDtcbiAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgYXJyUHJvZmlsZXMubGVuZ3RoOyBpKyspe1xuICAgICAgICAgICAgICAgICAgICBpZihhcnJQcm9maWxlc1tpXS51c2VybmFtZSA9PT0gdXNlcm5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFyclByb2ZpbGVzLnNwbGljZShpLCAxKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBmb3IodmFyIGlpID0gMDsgaWkgPCBhcnJQcm9maWxlcy5sZW5ndGg7IGlpKyspe1xuICAgICAgICAgICAgICAgICAgICBpZihhcnJQcm9maWxlc1tpaV0udXNlcm5hbWUgPT09IFwiYWRtaW5cIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXJyUHJvZmlsZXMuc3BsaWNlKGlpLCAxKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAkc2NvcGUuYXJyUHJvZmlsZXMgPSBhcnJQcm9maWxlcztcblxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfTtcblxuICAgICAgICAkc2NvcGUuc29ydFByb3BlcnR5ID0gXCJ0aXRsZVwiO1xuICAgICAgICAkc2NvcGUuZmlsdGVyUXVlcnkgPSBcIlwiO1xuICAgICAgICAkc2NvcGUuZmlsdGVyUHJvZmlsZXMgPSBmdW5jdGlvbihpKXtcbiAgICAgICAgICAgIGlmKCRzY29wZS5maWx0ZXJRdWVyeSA9PT0gXCJcIil7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8qXG4gICAgICAgICAgICAgZWxzZSBpZihpLnVzZXJuYW1lLnRvTG93ZXJDYXNlKCkuaW5kZXhPZigkc2NvcGUuZmlsdGVyUXVlcnkudG9Mb2NhbGVMb3dlckNhc2UoKSkgPj0gMCl7XG4gICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgfVxuICAgICAgICAgICAgICovXG5cbiAgICAgICAgICAgIGVsc2UgaWYoaS5zZXggPT09IHVuZGVmaW5lZCl7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBlbHNlIGlmKCRzY29wZS5maWx0ZXJRdWVyeS50b0xvd2VyQ2FzZSgpID09IGkuc2V4LnRvTG93ZXJDYXNlKCkpe1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBlbHNlIGlmKCRzY29wZS5maWx0ZXJRdWVyeS50b0xvd2VyQ2FzZSgpID09PSBcIm5vZmlsdGVyXCIpe1xuICAgICAgICAgICAgICAgICRzY29wZS5maWx0ZXJRdWVyeSA9IFwiXCI7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfTtcbiAgICB9O1xuXG4gICAgYW5ndWxhci5tb2R1bGUoXCJhcHBcIikuY29udHJvbGxlcihcIlByb2ZpbGVzQ29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgXCIkcm9vdFNjb3BlXCIsIFwiJHJvdXRlUGFyYW1zXCIsIFwiZGJTZXJ2aWNlXCIsXCIkaHR0cFwiLCBcIiRsb2NhdGlvblwiLCBQcm9maWxlc0NvbnRyb2xsZXJdKTtcblxufSkoKTsiLCIvKipcbiAqIENyZWF0ZWQgYnkgaW1hbiBvbiAyMC8xMi8xNS5cbiAqL1xuKGZ1bmN0aW9uKCl7XG5cbiAgICBcInVzZSBzdHJpY3RcIjtcblxuICAgIHZhciBVc2Vyc0NvbnRyb2xsZXIgPSBmdW5jdGlvbigkc2NvcGUsICRyb3V0ZVBhcmFtcywgZGJTZXJ2aWNlKSB7XG5cbiAgICAgICAgJHNjb3BlLmdldFVzZXJzID0gZnVuY3Rpb24oKXtcblxuICAgICAgICAgICAgZGJTZXJ2aWNlLmdldENvbGxlY3Rpb24oJ3VzZXJzJykudGhlbihmdW5jdGlvbihyZXNwb25zZSl7XG5cbiAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKHJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgICAkc2NvcGUuYXJyVXNlcnMgPSByZXNwb25zZS51c2VybGlzdDtcblxuICAgICAgICAgICAgICAgIGZvciggdmFyIGkgPSAwOyBpPCRzY29wZS5hcnJVc2Vycy5sZW5ndGg7IGkrKyl7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYoJHNjb3BlLmFyclVzZXJzW2ldLmRlbGV0ZWQgPT09IGZhbHNlKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5kZWxldGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBlbHNle1xuICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmRlbGV0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG5cblxuXG4gICAgICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH07XG5cbiAgICAgICAgJHNjb3BlLmdldERldGFpbFVzZXIgPSBmdW5jdGlvbigpe1xuXG4gICAgICAgICAgICBkYlNlcnZpY2UuZ2V0RGV0YWlsc1VzZXIoJ3VzZXJzJywgJHJvdXRlUGFyYW1zLnVzZXJuYW1lKS50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKXtcbiAgICAgICAgICAgICAgICAkc2NvcGUuYXJyRGV0YWlscyA9IHJlc3BvbnNlLmNvcnJlY3R1c2VyO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgJHNjb3BlLmRlbGV0ZVVzZXIgPSBmdW5jdGlvbih1c2VybmFtZSl7XG4gICAgICAgICAgICBkYlNlcnZpY2UuZGVsZXRlVXNlcigndXNlcnMnLCB1c2VybmFtZSkudGhlbihmdW5jdGlvbihyZXNwb25zZSl7XG4gICAgICAgICAgICAgICAgJHNjb3BlLmluZm9kZWxldGVkVXNlciA9IHJlc3BvbnNlO1xuICAgICAgICAgICAgICAgICRzY29wZS5nZXRVc2VycygpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgJHNjb3BlLmdldFVzZXJCeUlEID0gZnVuY3Rpb24oKXtcblxuICAgICAgICAgICAgZGJTZXJ2aWNlLmdldEl0ZW0oJ3VzZXInKS50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKXtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhyZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgJHNjb3BlLnVzZXJQcm9maWxlID0gcmVzcG9uc2U7XG5cbiAgICAgICAgICAgIH0pO1xuXG5cbiAgICAgICAgfTtcblxuXG4gICAgfTtcblxuICAgIGFuZ3VsYXIubW9kdWxlKFwiYXBwXCIpLmNvbnRyb2xsZXIoXCJVc2Vyc0NvbnRyb2xsZXJcIiwgW1wiJHNjb3BlXCIsIFwiJHJvdXRlUGFyYW1zXCIsIFwiZGJTZXJ2aWNlXCIsIFVzZXJzQ29udHJvbGxlcl0pO1xuXG59KSgpOyIsIi8qKlxuICogQ3JlYXRlZCBieSBNYXJ0aGUgb24gMzAvMTIvMTUuXG4gKi9cblxuXG4oZnVuY3Rpb24oKXtcbiAgICBcInVzZSBzdHJpY3RcIjtcblxuXG5cbnZhciBsb2NhdGlvbkNvbnRyb2xsZXIgPSBmdW5jdGlvbigkc2NvcGUpIHtcblxuICAgIGNvbnNvbGUubG9nKCdURVNURVNUJyk7XG5cbiAgICAkc2NvcGUuaW5pdG1hcCA9IGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgbWFwID0gbmV3IGdvb2dsZS5tYXBzLk1hcChkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWFwJyksIHtcbiAgICAgICAgICAgIHpvb206IDgsXG4gICAgICAgICAgICBjZW50ZXI6IHtsYXQ6IDUwLjgxOTQ4OTQsIGxuZzogMy4yNTc3MDc2fVxuICAgICAgICB9KTtcbiAgICAgICAgdmFyIGdlb2NvZGVyID0gbmV3IGdvb2dsZS5tYXBzLkdlb2NvZGVyKCk7XG5cbiAgICAgICAgZ2VvY29kZUFkZHJlc3MoZ2VvY29kZXIsIG1hcCk7XG5cbiAgICB9O1xuXG4gICAgZnVuY3Rpb24gZ2VvY29kZUFkZHJlc3MoZ2VvY29kZXIsIHJlc3VsdHNNYXApIHtcbiAgICAgICAgdmFyIGFkZHJlc3MgPSBcIkdyYWFmIEthcmVsIGRlIEdvZWRlbGFhbiA1LCBLb3J0cmlqa1wiOyAvL2hpZXIgYWRkcmVzcyB1aXQgZGIgaW5zdG9wcGVuXG5cbiAgICAgICAgZ2VvY29kZXIuZ2VvY29kZSh7J2FkZHJlc3MnOiBhZGRyZXNzfSwgZnVuY3Rpb24gKHJlc3VsdHMsIHN0YXR1cykge1xuICAgICAgICAgICAgaWYgKHN0YXR1cyA9PT0gZ29vZ2xlLm1hcHMuR2VvY29kZXJTdGF0dXMuT0spIHtcbiAgICAgICAgICAgICAgICByZXN1bHRzTWFwLnNldENlbnRlcihyZXN1bHRzWzBdLmdlb21ldHJ5LmxvY2F0aW9uKTtcbiAgICAgICAgICAgICAgICB2YXIgbWFya2VyID0gbmV3IGdvb2dsZS5tYXBzLk1hcmtlcih7XG4gICAgICAgICAgICAgICAgICAgIG1hcDogcmVzdWx0c01hcCxcbiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IHJlc3VsdHNbMF0uZ2VvbWV0cnkubG9jYXRpb25cbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKG1hcmtlcik7XG5cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYWxlcnQoJ0dlb2NvZGUgd2FzIG5vdCBzdWNjZXNzZnVsIGZvciB0aGUgZm9sbG93aW5nIHJlYXNvbjogJyArIHN0YXR1cyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbn07XG5cbiAgICBhbmd1bGFyLm1vZHVsZShcImFwcFwiKS5jb250cm9sbGVyKFwibG9jYXRpb25Db250cm9sbGVyXCIsIFtcIiRzY29wZVwiLCBsb2NhdGlvbkNvbnRyb2xsZXJdKTtcbn0pKCk7IiwiLyoqXG4gKiBDcmVhdGVkIGJ5IE1hcnRoZSBvbiAxNS8xMi8xNS5cbiAqL1xuKGZ1bmN0aW9uKCl7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgdmFyIHNlbGVjdGVkSW50ZXJlc3QgPSBbXTtcblxuICAgIHZhciBsb2dpbkNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoJHNjb3BlLCAkcm9vdFNjb3BlLCAkaHR0cCwgJGxvY2F0aW9uKSB7XG5cbiAgICAgICAgJHNjb3BlLmxvZ2luID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAkaHR0cFxuICAgICAgICAgICAgICAgIC5wb3N0KCcvbG9naW4nLCB7XG4gICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLnVzZXJuYW1lLFxuICAgICAgICAgICAgICAgICAgICBwYXNzd29yZDogdGhpcy5wYXNzd29yZFxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLnN1Y2Nlc3MoZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS51c2VyID0gZGF0YS51c2VyO1xuICAgICAgICAgICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShcInVzZXJuYW1lXCIsICRyb290U2NvcGUudXNlci51c2VybmFtZSk7XG4gICAgICAgICAgICAgICAgICAgICRzY29wZS5lcnJvciA9IGRhdGEuZXJyb3I7XG4gICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbi5wYXRoKGRhdGEucmVkaXJlY3QpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuXG4gICAgICAgICRzY29wZS5pbnRlcmVzdHMgPSBbJ0phenonLCAnSGlwaG9wJywgJ05ldyB3YXZlJywgJ1RyYXZlbGluZycsJ1BhcnR5J107XG4gICAgICAgICRzY29wZS5sc3QgPSBbXTtcbiAgICAgICAgJHNjb3BlLmNoYW5nZSA9IGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICAkc2NvcGUubHN0LnB1c2goJzInKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCRzY29wZS5sc3QpO1xuICAgICAgICB9O1xuICAgICAgICAkc2NvcGUuc3RhdGVDaGFuZ2VkID0gZnVuY3Rpb24gKHFJZCkge1xuICAgICAgICAgICAgLy9pZighJHNjb3BlLmludGVyZXN0c1txSWRdKXsgLy9JZiBpdCBpcyBjaGVja2VkXG4gICAgICAgICAgICBpZihzZWxlY3RlZEludGVyZXN0LmluZGV4T2YocUlkKSAhPT0gLTEpIHtcbiAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKCdhcnROciBhbHJlYWR5IGV4aXN0cyEgREVMRVRFJyk7XG4gICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gc2VsZWN0ZWRJbnRlcmVzdC5pbmRleE9mKHFJZCk7XG4gICAgICAgICAgICAgICAgaWYgKGluZGV4ID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRJbnRlcmVzdC5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgIHNlbGVjdGVkSW50ZXJlc3QucHVzaChxSWQpO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHNlbGVjdGVkSW50ZXJlc3QpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgICRzY29wZS5yZWdpc3RlciA9IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJSRUdJU1RFUlwiKTtcblxuXG4gICAgICAgICAgICAkaHR0cC5wb3N0KCcvcmVnaXN0ZXInLCB7XG4gICAgICAgICAgICAgICAgZmlyc3RuYW1lOiB0aGlzLmZpcnN0bmFtZSxcbiAgICAgICAgICAgICAgICBsYXN0bmFtZSA6IHRoaXMubGFzdG5hbWUsXG4gICAgICAgICAgICAgICAgLy9lbWFpbCA6IHRoaXMuZW1haWwsKi9cbiAgICAgICAgICAgICAgICB1c2VybmFtZSA6IHRoaXMudXNlcm5hbWUsXG4gICAgICAgICAgICAgICAgcGFzc3dvcmQgOiB0aGlzLnBhc3N3b3JkLFxuICAgICAgICAgICAgICAgIHppcGNvZGU6IHRoaXMuemlwY29kZSxcbiAgICAgICAgICAgICAgICBiaXJ0aGRhdGUgOiB0aGlzLmJpcnRoZGF0ZSxcbiAgICAgICAgICAgICAgICBzZXggOiB0aGlzLnNleCxcbiAgICAgICAgICAgICAgICBiaW9ncmFwaHkgOiB0aGlzLmJpb2dyYXBoeSxcbiAgICAgICAgICAgICAgICBpbnRlcmVzdHM6c2VsZWN0ZWRJbnRlcmVzdFxuXG4gICAgICAgICAgICB9KS5zdWNjZXNzKGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgICAgICAgICAgJHNjb3BlLmVycm9yID0gZGF0YS5lcnJvcjtcbiAgICAgICAgICAgICAgICAkbG9jYXRpb24ucGF0aChkYXRhLnJlZGlyZWN0KTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH07XG4gICAgfTtcblxuICAgIHZhciBzaWdudXBDb250cm9sbGVyID0gZnVuY3Rpb24gKCRzY29wZSkge1xuICAgICAgICAkc2NvcGUuY2F0ZWdvcmllcyA9IFsnJ107XG4gICAgICAgICRzY29wZS5uZXdDYXRlZ29yeSA9IFwiXCI7XG4gICAgICAgICRzY29wZS5zYXZlQ2F0ZWdvcnkgPSBmdW5jdGlvbiAoKSB7XG5cbiAgICAgICAgfTtcblxuICAgIH07XG5cbiAgICB2YXIgZWRpdGFibGVDaGVja2JveENvbnRyb2xsZXIgPSBmdW5jdGlvbiAoJHNjb3BlKSB7XG4gICAgICAgICRzY29wZS5jYXRlZ29yeSA9IFwiXCI7XG4gICAgICAgICRzY29wZS5zaG93TGFiZWwgPSBmYWxzZTtcbiAgICAgICAgJHNjb3BlLnNob3dUZXh0Ym94ID0gdHJ1ZTtcbiAgICAgICAgJHNjb3BlLnNhdmVDYXRlZ29yeSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmICgkc2NvcGUuY2F0ZWdvcnkpIHtcbiAgICAgICAgICAgICAgICAkc2NvcGUuc2hvd0xhYmVsID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAkc2NvcGUuc2hvd1RleHRib3ggPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICRzY29wZS5zaG93TGFiZWwgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAkc2NvcGUuc2hvd1RleHRib3ggPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICAkc2NvcGUuZWRpdCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICRzY29wZS5zaG93TGFiZWwgPSBmYWxzZTtcbiAgICAgICAgICAgICRzY29wZS5zaG93VGV4dGJveCA9IHRydWU7XG4gICAgICAgIH07XG4gICAgICAgICRzY29wZS5pc0NoZWNrZWQgPSBmdW5jdGlvbihxSWQpe1xuICAgICAgICAgICAgY29uc29sZS5sb2cocUlkKTtcbiAgICAgICAgICAgIGlmKHFJZCE9PSAgXCIgXCIpIHtcbiAgICAgICAgICAgICAgICBpZiAoc2VsZWN0ZWRJbnRlcmVzdC5pbmRleE9mKHFJZCkgIT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBpbmRleCA9IHNlbGVjdGVkSW50ZXJlc3QuaW5kZXhPZihxSWQpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRJbnRlcmVzdC5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coc2VsZWN0ZWRJbnRlcmVzdCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZEludGVyZXN0LnB1c2gocUlkKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coc2VsZWN0ZWRJbnRlcmVzdCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICAkc2NvcGUuc3RhdGVDaGFuZ2VkID0gZnVuY3Rpb24gKHFJZCkge1xuXG4gICAgICAgIH07XG5cbiAgICB9O1xuXG4gICAgYW5ndWxhci5tb2R1bGUoXCJhcHBcIilcbiAgICAgICAgLmNvbnRyb2xsZXIoXCJsb2dpbkNvbnRyb2xsZXJcIiwgW1wiJHNjb3BlXCIsIFwiJHJvb3RTY29wZVwiLCBcIiRodHRwXCIsIFwiJGxvY2F0aW9uXCIsIGxvZ2luQ29udHJvbGxlcl0pXG4gICAgICAgIC5jb250cm9sbGVyKFwic2lnbnVwQ29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgc2lnbnVwQ29udHJvbGxlcl0pXG4gICAgICAgIC5jb250cm9sbGVyKFwiZWRpdGFibGVDaGVja2JveENvbnRyb2xsZXJcIiwgW1wiJHNjb3BlXCIsIGVkaXRhYmxlQ2hlY2tib3hDb250cm9sbGVyXSk7XG59KSgpOyIsIi8qKlxuICogQ3JlYXRlZCBieSBOaWtpdGEgb24gMjEvMTIvMjAxNS5cbiAqL1xuKGZ1bmN0aW9uICgpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcblxuICAgIC8qdmFyIHNpZ251cENvbnRyb2xsZXIgPSBmdW5jdGlvbiAoJHNjb3BlKSB7XG4gICAgICAgICRzY29wZS5jYXRlZ29yaWVzID0gWycnXTtcbiAgICAgICAgJHNjb3BlLm5ld0NhdGVnb3J5ID0gXCJcIjtcbiAgICAgICAgJHNjb3BlLnNhdmVDYXRlZ29yeSA9IGZ1bmN0aW9uICgpIHtcblxuICAgICAgICB9O1xuXG4gICAgfTtcblxuICAgIHZhciBlZGl0YWJsZUNoZWNrYm94Q29udHJvbGxlciA9IGZ1bmN0aW9uICgkc2NvcGUpIHtcbiAgICAgICAgJHNjb3BlLmNhdGVnb3J5ID0gXCJcIjtcbiAgICAgICAgJHNjb3BlLnNob3dMYWJlbCA9IGZhbHNlO1xuICAgICAgICAkc2NvcGUuc2hvd1RleHRib3ggPSB0cnVlO1xuICAgICAgICAkc2NvcGUuc2F2ZUNhdGVnb3J5ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgaWYgKCRzY29wZS5jYXRlZ29yeSkge1xuICAgICAgICAgICAgICAgICRzY29wZS5zaG93TGFiZWwgPSB0cnVlO1xuICAgICAgICAgICAgICAgICRzY29wZS5zaG93VGV4dGJveCA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgJHNjb3BlLnNob3dMYWJlbCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICRzY29wZS5zaG93VGV4dGJveCA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgICRzY29wZS5lZGl0ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgJHNjb3BlLnNob3dMYWJlbCA9IGZhbHNlO1xuICAgICAgICAgICAgJHNjb3BlLnNob3dUZXh0Ym94ID0gdHJ1ZTtcbiAgICAgICAgfTtcblxuICAgIH07XG4gICAgYW5ndWxhci5tb2R1bGUoXCJhcHBcIilcbiAgICAgICAgLmNvbnRyb2xsZXIoXCJzaWdudXBDb250cm9sbGVyXCIsIFtcIiRzY29wZVwiLCBzaWdudXBDb250cm9sbGVyXSlcbiAgICAgICAgLmNvbnRyb2xsZXIoXCJlZGl0YWJsZUNoZWNrYm94Q29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgZWRpdGFibGVDaGVja2JveENvbnRyb2xsZXJdKTsqL1xuXG5cbn0pKCk7IiwiLyoqXG4gKiBDcmVhdGVkIGJ5IE1hcnRoZSBvbiAxNi8xMi8xNS5cbiAqL1xuKGZ1bmN0aW9uICgpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcblxuICAgIHZhciB1c2VyQ29udHJvbGxlciA9IGZ1bmN0aW9uICgkc2NvcGUsICRyb290U2NvcGUsICRodHRwLCAkbG9jYXRpb24pIHtcbiAgICAgICAgJGh0dHAuZ2V0KCcvdXNlcicpLnN1Y2Nlc3MoZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAgICAgJHNjb3BlLnVzZXIgPSBkYXRhO1xuICAgICAgICAgICAgJHJvb3RTY29wZS51c2VyID0gZGF0YTtcblxuICAgICAgICAgICAgaWYoZGF0YS51c2VybmFtZSA9PSAnYWRtaW4nKXtcbiAgICAgICAgICAgICAgICAkc2NvcGUuYXV0aCA9IHtpc0F1dGg6IHRydWUsIGlzQWRtaW4gOiB0cnVlfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYoZGF0YS51c2VybmFtZSAhPSAnYWRtaW4nICYmIGRhdGEudXNlcm5hbWUgIT09IHVuZGVmaW5lZCl7XG4gICAgICAgICAgICAgICAgJHNjb3BlLmF1dGggPSB7aXNBdXRoOiB0cnVlLCBpc0FkbWluIDogZmFsc2V9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZihkYXRhLnVzZXJuYW1lID09PSB1bmRlZmluZWQpe1xuICAgICAgICAgICAgICAgICRzY29wZS5hdXRoID0ge2lzQXV0aDogZmFsc2UsIGlzQWRtaW4gOiBmYWxzZX07XG5cbiAgICAgICAgICAgIH1cblxuXG4gICAgICAgIH0pO1xuXG5cbiAgICAgICAgLyokc2NvcGUubG9nb3V0ID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAkaHR0cC5nZXQoJy9sb2dvdXQnKS5zdWNjZXNzKGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgICAgICAgICAgJGxvY2F0aW9uLnBhdGgoZGF0YS5yZWRpcmVjdCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTsqL1xuICAgIH07XG5cblxuICAgIGFuZ3VsYXIubW9kdWxlKFwiYXBwXCIpLmNvbnRyb2xsZXIoXCJ1c2VyQ29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgXCIkcm9vdFNjb3BlXCIsIFwiJGh0dHBcIiwgXCIkbG9jYXRpb25cIiwgdXNlckNvbnRyb2xsZXJdKTtcbn0pKCk7Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
