/**
 * Created by Marthe on 10/12/15.
 */

(function(){
    var app = angular.module("app", ["ngRoute"]);
    app.config(function($routeProvider){
        $routeProvider
            .when("/",{
                templateUrl: "./views/home.html"
            })
            .when("/signup",{
                templateUrl: "views/signup.html"
            })
            .when("/home",{
                templateUrl: "./views/home.html"
            })
            .when("/matches",{
                templateUrl: "./views/matches.html"
            })
            .when("/howto",{
                templateUrl: "./views/howTo.html"
            })
            .when("/activities",{
                templateUrl: "./views/activities.html"
            })
            .when("/admin",{
                templateUrl: "./views/admin.html"
            })
            .when("/searchprofiles",{
                templateUrl: "./views/searchProfiles.html"
            })
            .when("/myprofile",{
                templateUrl: "./views/myProfile.html"
            })
            .when("/userdetails/:username",{
                templateUrl: "./views/detailsUser.html",
                controller: 'UsersController'
            })
            .when("/detailsuser",{
                templateUrl: "./views/detailsUser.html"
            })
            .when("/activitydetails/:activityName", {
                templateUrl: "./views/detailsActivity.html",
                controller: "ActivitiesController"

            });


    });

    app.run(function ($rootScope) {
        $rootScope.user = {};
    });

    app.directive('ngEnter', function () {
        return function (scope, element, attrs) {
            element.bind("keydown keypress", function (event) {
                if (event.which === 13) {
                    scope.$apply(function () {
                        scope.$eval(attrs.ngEnter);
                    });

                    event.preventDefault();
                }
            });
        };
    });


    app.directive('fileModel', ['$parse', function ($parse) {
        return {
            restrict: 'A',
            link: function(scope, element, attrs) {
                var model = $parse(attrs.fileModel);
                var modelSetter = model.assign;

                element.bind('change', function(){
                    scope.$apply(function(){
                        modelSetter(scope, element[0].files[0]);
                    });
                });
            }
        };
    }]);

    app.service('fileUpload', ['$http', function ($http) {
        this.uploadFileToUrl = function(file, uploadUrl){
            var fd = new FormData();
            fd.append('file', file);
            $http.post(uploadUrl, fd, {
                transformRequest: angular.identity,
                headers: {'Content-Type': undefined}
            })
                .success(function(){
                    console.log("success");
                })
                .error(function(){
                    console.log("error");
                });
        };
    }]);


    app.directive('editableCheckbox', function () {
        return {
            restrict: 'E',
            templateUrl: './views/editablecheckbox.html'
        };
    });


})();
/**
 * Created by iman on 15/12/15.
 */
var Activity = function(img, name, place, keywords, participants, myEvent){
    this.img = img;
    this.name = name;
    this.place = place;
    this.keywords = keywords;
    this.participants = participants;
    this.myEvent = myEvent;
};
/**
 * Created by iman on 5/12/15.
 */
/*(function(){

    "use strict";

    var activitiesService = function () {

        var getActivities = function () {

            var localUrl = "http://localhost:3000/data/activities.json";
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open("GET", localUrl, false);
            xmlHttp.send(null);

            if(xmlHttp.status == 200) {

                var data = JSON.parse(xmlHttp.responseText);

                //console.log(data);

                var arrActivities = [];

                for (var i = 0; i < data.length; i++) {

                    var d = data[i];

                    var newActivity = new Activity();
                    newActivity.img = d.img;
                    newActivity.name = d.name;
                    newActivity.place = d.place;
                    newActivity.participants = d.participants;
                    newActivity.myEvent = d.myEvent;

                    var text = "";

                    for(var ii=0; ii< d.keywords.length; ii++){
                        if(ii == d.keywords.length-1){
                            text += d.keywords[ii];
                        }
                        else{
                            text += d.keywords[ii];
                            text += ", ";
                        }
                    }

                    newActivity.keywords = text;
                    arrActivities.push(newActivity);
                }

                return arrActivities;

            }

        };

        //public gedeelte
        return{

            getActivities:getActivities

        };

    };

    angular.module("app").factory("activitiesService", [activitiesService]);
    //                                  ^ deze naam bepaalt welke naam je nodig hebt in je controller als verwijzing!

})();*/
/**
 * Created by iman on 15/12/15.
 */


(function(){

    "use strict";

    var dbService = function ($http) {

        var getCollection = function (collection) {


            var url = "http://localhost:3000/api/" + collection;
            return $http.get(url).then(function(response){
                return response.data;

            });

        };

        var getByID = function (collection, id) {
            var url = "http://localhost:3000/api/" + collection + "/" + id;
            return $http.get(url).then(function(response){
                return response.data;

            });

        };

        var getDetailsUser = function (collection, username) {
            var url = "http://localhost:3000/api/" + collection + "/userdetail/" + username;
            return $http.get(url).then(function(response){
                return response.data;

            });

        };

        var getItem = function(item){

            var url = "http://localhost:3000/api/" + item;
            return $http.get('/user').then(function(response){

                return response.data;

            });

        };

        var getDetailsActivity = function (collection, activityname) {
            var url = "http://localhost:3000/api/" + collection + "/activitydetail/" + activityname;
            return $http.get(url).then(function(response){
                return response.data;

            });

        };

        var getNoiseWords = function () {

            var url = "http://localhost:3000/data/noisewords.json";
            return $http.get(url).then(function(response){

                return response.data;

            });

        };


        //public gedeelte
        return{

            getCollection:getCollection,
            getByID:getByID,
            getItem:getItem,
            getDetailsUser: getDetailsUser,
            getDetailsActivity: getDetailsActivity,
            getNoiseWords: getNoiseWords

        };

    };

    angular.module("app").factory("dbService", ["$http", dbService]);
    //                                  ^ deze naam bepaalt welke naam je nodig hebt in je controller als verwijzing!

})();
/**
 * Created by iman on 5/12/15.
 */
(function(){

    "use strict";

    var matchesService = function () {

        var getMatches = function (nameUser) {

            var variabelURL = "together";
            var localUrl = "http://localhost:3000/data/matches.json";
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open("GET", localUrl, false);
            xmlHttp.send(null);

            if(xmlHttp.status == 200) {

                var data = JSON.parse(xmlHttp.responseText);
                var arr = [];
                var arrMatches = [];
                var arrMatchUsers = [];
                var arrMatchInterests = [];

                for(var i=0; i < data.length; i++){

                    var obj = {
                        "user": data[i].user,
                        "matches":data[i].matches
                    };

                    arr.push(obj);

                }

                for(var ii = 0; ii<arr.length; ii++){

                    var index = arr[ii].user.indexOf(nameUser);
                    if(index === 0){
                        arrMatches.push(arr[ii].matches);
                    }
                    //console.log("Index: "+index);
                }

                //console.log(arr);
                //console.log(arrMatches[0]);


                var arrMatchesByUser = arrMatches[0];
                //console.log("Aantal matches: " + arrMatchesByUser.length);

                return arrMatchesByUser;

                /*
                for(var iii = 0; iii<arrMatches[0].length; iii++){

                    var matchUser = arrMatches[0][iii].user;
                    var matchInterests = arrMatches[0][iii].interests;

                    arrMatchUsers.push(matchUser);
                    arrMatchInterests.push(matchInterests);

                    //console.log(matchUser);
                    //console.log(matchInterests);
                }

                console.log(arrMatchUsers);
                console.log(arrMatchInterests);
                */

            }



        };

        //public gedeelte
        return{

            getMatches:getMatches,

        };

    };

    angular.module("app").factory("matchesService", [matchesService]);
    //                                  ^ deze naam bepaalt welke naam je nodig hebt in je controller als verwijzing!

})();
/**
 * Created by iman on 5/12/15.
 */

(function() {

    "use strict";
    var ActivitiesController = function ($scope, dbService, $http, $location, $routeParams, $route) {
        $scope.interestedAct=true;
        $scope.nameButton = "Interested";

        $scope.getActivities = function () {
            dbService.getCollection('activities').then(function (response) {

                var arrTemp = response.activitielist;
                var arrActs = [];

                /*var today = new Date().toISOString().substring(0, 10),
                    todaySplit = today.split("-"),
                    sumToday =  todaySplit[0] +  todaySplit[1] +  todaySplit[2];*/

                for (var i = 0, l = arrTemp.length; i < l; i++) {
                    /*var activtyDateSplit = arrTemp[i].untilDate.substring(0,10).split("-"),
                        sumActivity =  activtyDateSplit[0] + activtyDateSplit[1] + activtyDateSplit[2];
                    if ( sumActivity >= sumToday) {*/
                      arrActs.push(arrTemp[i]);
                }

                $scope.arrActivities = arrActs;

            });


        };

        String.prototype.replaceAll = function( token, newToken, ignoreCase ) {
            var _token;
            var str = this + "";
            var i = -1;

            if ( typeof token === "string" ) {

                if ( ignoreCase ) {

                    _token = token.toLowerCase();

                    while( (
                        i = str.toLowerCase().indexOf(
                            token, i >= 0 ? i + newToken.length : 0
                        ) ) !== -1
                        ) {
                        str = str.substring( 0, i ) +
                            newToken +
                            str.substring( i + token.length );
                    }

                } else {
                    return this.split( token ).join( newToken );
                }

            }
            return str;
        };

        function isInArray(value, array) {
            return array.indexOf(value);
        }
        function getKeywordsFromDescription(description, callback) {

            description = description.replaceAll('.', '');
            description = description.replaceAll(',', '');
            description = description.replaceAll('?', '');
            description = description.replaceAll('!', '');
            description = description.replaceAll('"', '');
            description = description.replaceAll("'", '');

            var words = description.split(" ");
            var keyWords = "";

            dbService.getNoiseWords().then(function(response) {

                var noiseWords = response.noisewords;

                for (var i = 0; i < words.length; i++) {

                    if (isInArray(words[i].toLowerCase(), noiseWords) == -1) {
                        keyWords += words[i];
                        keyWords += " ";
                    }
                }

                //return keyWords;
                if(!keyWords.isEmpty){
                    callback(null, keyWords);
                }

                else{
                    callback("No keywords found.", null);
                }

            });
        }
        function stringConsistOf2Numbers(number, callback){
                var output = number + '';
                if (output.length < 2) {
                    output = '0' + output;
                    number = output.toString();

                }
                else{
                    number = number.toString();
                }


            if(!number.isEmpty){
                callback(null, number);
            }

            else{
                callback("No number.", null);
            }


        }
        function fullDate(number, number2, callback){
            stringConsistOf2Numbers(number, function(error, numberToString){
                number = numberToString;
                if(error){
                    console.log(error);

                }
            });
            stringConsistOf2Numbers(number2, function(error, numberToString){
                number2 = numberToString;
                if(error){
                    console.log(error);

                }
            });

            if(!number.isEmpty && !number2.isEmpty){
                callback(null, number, number2);
            }

            else{
                callback("No number.", null);
            }



        }


        $scope.addActivity = function() {
            var activityName = this.activityName;
            var street = this.street;
            var number = this.number;
            var zipcode = this.zipcode;
            var description = this.comment;
            var dateFrom = this.dateFrom;
            var dateUntil = this.dateUntil;
            var timestamp = new Date().getTime();
            var startTimeHour  = this.startTimeHour;
            var startTimeMin = this.startTimeMin;
            var endTimeHour = this.endTimeHour;
            var endTimeMin = this.endTimeMin;
            var dateFromDay = this.dateFromDay;
            var dateFromMonth = this.dateFromMonth;
            var dateFromYear = this.dateFromYear.toString();
            var dateUntilDay = this.dateUntilDay;
            var dateUntilMonth = this.dateUntilMonth;
            var dateUntilYear = this.dateUntilYear.toString();

            fullDate(dateFromDay, dateFromMonth, function(error, dateFromdayString, dateFromMonthString){
                dateFromDay = dateFromdayString;
                dateFromMonth = dateFromMonthString;
                if(error){
                    console.log(error);
                }
            });
            fullDate(dateUntilDay, dateUntilMonth, function(error, dateUntilDayString, dateUntilMonthString){
                dateUntilDay = dateUntilDayString;
                dateUntilMonth = dateUntilMonthString;
                if(error){
                    console.log(error);
                }
            });


            if((street !== undefined) &&
                (number !== undefined) &&
                (zipcode !== undefined) &&
                (description !== undefined) &&
                (timestamp !== undefined)){

                $scope.error = "";

                if (startTimeMin < 60 && startTimeHour < 25) {

                    stringConsistOf2Numbers(startTimeHour, function(error, startTimeHourString){
                        startTimeHour = startTimeHourString;
                        if(error){
                            console.log(error);
                        }
                    });
                    stringConsistOf2Numbers(startTimeMin, function(error, startTimeMinString){
                        startTimeMin = startTimeMinString;
                        if(error){
                            console.log(error);

                        }
                    });

                    console.log(startTimeHour);
                    console.log(startTimeMin);

                    if (startTimeMin.length === 2  && startTimeHour.length === 2) {
                        console.log("je komt hier terecht");

                        if(endTimeMin < 60 && endTimeHour < 24){
                            stringConsistOf2Numbers(endTimeHour, function(error, endTimeHourString){
                                endTimeHour = endTimeHourString;
                                if(error){
                                    console.log(error);
                                }
                            });
                            stringConsistOf2Numbers(endTimeMin, function(error, endTimeMinString){
                                endTimeMin = endTimeMinString;
                                if(error){
                                    console.log(error);

                                }
                            });

                            console.log(endTimeHour);
                            console.log(endTimeMin);

                            if (endTimeMin.toString().length === 2 && endTimeHour.toString().length === 2) {

                                console.log(startTimeHour + ":" + startTimeMin);

                                getKeywordsFromDescription(description, function (error, data) {
                                    description = data;
                                    if(!error){
                                        console.log(startTimeHour + ":" + startTimeMin);

                                        var url = "http://localhost:3000/api/activities/addactivity";
                                        $http.post(url, {
                                            activityName:activityName,
                                            street : street,
                                            number: number,
                                            zipcode: zipcode,
                                            description : description,
                                            dateFrom : dateFromYear + "-" + dateFromMonth + "-" +  dateFromDay + " " + startTimeHour + ":" + startTimeMin ,
                                            dateUntil : dateUntilYear + "-" + dateFromMonth +"-" + dateUntilDay + " " + endTimeHour + ":" +  endTimeMin,
                                            timestamp : timestamp

                                        }).success(function (data) {
                                            $scope.error = data.error;
                                            $scope.getActivities();
                                            resetForm();

                                            //$location.path(data.redirect);
                                        });

                                    }
                                    else{
                                        console.log(error);
                                    }
                                });
                            }

                            else {
                                $scope.error = "Enddate input is not correct";
                            }
                        }

                        else{
                            $scope.error = "Endtime input is not correct";
                        }

                    }

                    else {
                        $scope.error = 'De startime length is not correct!!!! ';
                    }
                }
                else {
                    $scope.error = "Starttime input is not correct";
                }


            }
            else{
                $scope.error = "ERROR: All fields are required.8888";
            }
        };

        $scope.getDetailActivity = function(currentUser){
            dbService.getDetailsActivity('activities', $routeParams.activityName).then(function(response){
                $scope.arrDetailsActivity = response.activity;
                initmap();

                console.log($scope.arrDetailsActivity.matches);
                for (var i = 0; i < $scope.arrDetailsActivity.matches.length; i++) {
                    if ($scope.arrDetailsActivity.matches[i] === currentUser) {
                        $scope.nameButton = "Not interested";
                        $scope.interestedAct = false;
                    }
                }
                return $scope.arrDetailsActivity;


            });
        };

        $scope.interested = function(activityName,interestedUser, createrUser){
            var url = "";
            var interestedAct = $scope.interestedAct;
            if(interestedAct !== false) {

                url = "http://localhost:3000/api/activities/interested";
                $http.post(url, {
                    activityName: activityName,
                    interestedUser: interestedUser,
                    createrUser: createrUser
                }).success(function (data) {
                    console.log(data);
                    console.log(interestedUser + " is geïnteresseerd in " + activityName + " door " + createrUser);
                    $scope.interestedAct = false;
                    $scope.nameButton = "Not interested";
                    $scope.error = data.error;
                });
            }else{
                console.log(interestedAct);
                url = "http://localhost:3000/api/activities/deleteinterested";
                $http.post(url, {
                    activityName: activityName,
                    interestedUser: interestedUser,
                    createrUser: createrUser
                }).success(function (data) {
                    console.log(data);
                    console.log(interestedUser + " is niet meer geïnteresseerd in " + activityName + " door " + createrUser);
                    $scope.interestedAct = true;
                    $scope.nameButton = "Interested";

                    $scope.error = data.error;
                });
            }
        };

        function recentFirst(a,b) {
            if (a.timestamp > b.timestamp)
                return -1;
            if (a.timestamp < b.timestamp)
                return 1;
            return 0;
        }

        $scope.getMostRecentActivities = function(){
            dbService.getCollection('activities').then(function(response){

                var numberOfActivities = 3;
                var arrTemp = response.activitielist;
                var arrAllActivities = [];

                for (var i = 0, l = arrTemp.length; i < l; i++) {
                    if (new Date(arrTemp[i].untilDate).getTime() > new Date().getTime()) {
                        arrAllActivities.push(arrTemp[i]);
                    }
                }

                arrAllActivities.sort(recentFirst);

                var arrMostRecentActivities = [];

                for(var ii=0; ii<numberOfActivities; ii++){
                    arrMostRecentActivities.push(arrAllActivities[ii]);
                }
                $scope.arrMostRecentActivities = arrMostRecentActivities;

            });
        };

        function initmap() {

            var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: {lat: 50.8194894, lng: 3.2577076}
            });
            var geocoder = new google.maps.Geocoder();

            geocodeAddress(geocoder, map);


        }

        function geocodeAddress(geocoder, resultsMap) {
            var street = $scope.arrDetailsActivity.street;
            var number = $scope.arrDetailsActivity.number;
            var zipcode = $scope.arrDetailsActivity.zipcode;

            var address = street + " " + number + ", " + zipcode; //hier address uit db instoppen

            geocoder.geocode({'address': address}, function (results, status) {
                if (status === google.maps.GeocoderStatus.OK) {
                    resultsMap.setCenter(results[0].geometry.location);
                    var marker = new google.maps.Marker({
                        map: resultsMap,
                        position: results[0].geometry.location
                    });

                    console.log(marker);

                } else {
                    alert('Geocode was not successful for the following reason: ' + status);
                }
            });
        }

        function resetForm(){
            var frm = document.getElementsByName('ActivityForm')[0];
            console.log('je komt in de resetform');
            frm.reset();
        }
    };

    angular.module("app").controller("ActivitiesController", ["$scope", "dbService", "$http","$location", "$routeParams","fileUpload", ActivitiesController]);


})();
/**
 * Created by iman on 5/12/15.
 */

(function(){

    "use strict";

    var MatchesController = function($scope, matchesService) {

        $scope.showMatches = function(){

            var nameUser = "Luna";

            var arrMatchesByUser = matchesService.getMatches(nameUser);

            $scope.aantalMatches = arrMatchesByUser.length;

            $scope.arrMatches = arrMatchesByUser;

            var text = "";
            for(var i=0; i<arrMatchesByUser.length; i++){
                text = arrMatchesByUser[i].interests.toString().replace(" ,", " ");
                arrMatchesByUser[i].interests = text;
            }

        };
    };

    angular.module("app").controller("MatchesController", ["$scope", "matchesService", MatchesController]);

})();
/**
 * Created by iman on 20/12/15.
 */


(function(){

    "use strict";

    var ProfilesController = function($scope, $rootScope, $routeParams, dbService) {

        var clicksOnBtn = 0;

        $scope.showDiv = function(){
            $scope.filter = {showFilter:true};
            clicksOnBtn++;

            if(clicksOnBtn > 1){
                $scope.filter = {showFilter:false};
                clicksOnBtn = 0;
            }
        };

        $scope.hideDiv = function(){
            clicksOnBtn = 0;
            $scope.filter = {showFilter:false};
        };

        $scope.showProfiles = function(){

            var username = "";
            if($rootScope.user.username !== undefined){
                username = $rootScope.user.username;
            }

            dbService.getCollection('users').then(function(response){

                var arrProfiles = response.userlist;
                for(var i = 0; i < arrProfiles.length; i++){
                    if(arrProfiles[i].username === username) {
                        arrProfiles.splice(i, 1);
                    }
                }
                for(var ii = 0; ii < arrProfiles.length; ii++){
                    if(arrProfiles[ii].username === "admin") {
                        arrProfiles.splice(ii, 1);
                    }
                }
                $scope.arrProfiles = arrProfiles;

            });

        };

        $scope.sortProperty = "title";
        $scope.filterQuery = "";
        $scope.filterImages = function(i){
            if($scope.filterQuery === ""){
                return true;
            }

            /*
             else if(i.username.toLowerCase().indexOf($scope.filterQuery.toLocaleLowerCase()) >= 0){
             return true;
             }
             */

            else if(i.sex === undefined){
                return false;
            }

            else if($scope.filterQuery.toLowerCase() == i.sex.toLowerCase()){
                return true;
            }

            else if($scope.filterQuery.toLowerCase() === "nofilter"){
                $scope.filterQuery = "";
            }

            return false;
        };
    };

    angular.module("app").controller("ProfilesController", ["$scope", "$rootScope", "$routeParams", "dbService", ProfilesController]);

})();
/**
 * Created by iman on 20/12/15.
 */
(function(){

    "use strict";

    var UsersController = function($scope, $routeParams, dbService) {

        $scope.getUsers = function(){

            dbService.getCollection('users').then(function(response){

                //console.log(response);
                $scope.arrUsers = response.userlist;

            });

        };

        $scope.getDetailUser = function(){

            dbService.getDetailsUser('users', $routeParams.username).then(function(response){
                $scope.arrDetails = response.activity;
            });
        };

        $scope.getUserByID = function(){

            dbService.getItem('user').then(function(response){

                console.log(response);
                $scope.userProfile = response;

            });

        };


    };

    angular.module("app").controller("UsersController", ["$scope", "$routeParams", "dbService", UsersController]);

})();
/**
 * Created by Marthe on 30/12/15.
 */


(function(){
    "use strict";



var locationController = function($scope) {

    console.log('TESTEST');

    $scope.initmap = function() {
        var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 8,
            center: {lat: 50.8194894, lng: 3.2577076}
        });
        var geocoder = new google.maps.Geocoder();

        geocodeAddress(geocoder, map);

    };

    function geocodeAddress(geocoder, resultsMap) {
        var address = "Graaf Karel de Goedelaan 5, Kortrijk"; //hier address uit db instoppen

        geocoder.geocode({'address': address}, function (results, status) {
            if (status === google.maps.GeocoderStatus.OK) {
                resultsMap.setCenter(results[0].geometry.location);
                var marker = new google.maps.Marker({
                    map: resultsMap,
                    position: results[0].geometry.location
                });

                console.log(marker);

            } else {
                alert('Geocode was not successful for the following reason: ' + status);
            }
        });
    }
};

    angular.module("app").controller("locationController", ["$scope", locationController]);
})();
/**
 * Created by Marthe on 15/12/15.
 */
(function(){
    "use strict";
    var selectedInterest = [];

    var loginController = function ($scope, $http, $location) {

        $scope.login = function() {
            $http
                .post('/login', {
                    username: this.username,
                    password: this.password
                })
                .success(function(data) {
                    console.log(data);
                    $scope.error = data.error;
                    $location.path(data.redirect);
                });
        };

        $scope.interests = ['Jazz', 'Hiphop', 'New wave', 'Traveling','Party'];
        $scope.lst = [];
        $scope.change = function(){
            $scope.lst.push('2');
            console.log($scope.lst);
        };
        $scope.stateChanged = function (qId) {
            //if(!$scope.interests[qId]){ //If it is checked
            if(selectedInterest.indexOf(qId) !== -1) {
                //console.log('artNr already exists! DELETE');
                var index = selectedInterest.indexOf(qId);
                if (index > -1) {
                    selectedInterest.splice(index, 1);
                }
            }else{
                selectedInterest.push(qId);
                console.log(selectedInterest);
            }
        };

        $scope.register = function() {
            console.log("REGISTER");


            $http.post('/register', {
                firstname: this.firstname,
                lastname : this.lastname,
                //email : this.email,*/
                username : this.username,
                password : this.password,
                zipcode: this.zipcode,
                birthdate : this.birthdate,
                sex : this.sex,
                biography : this.biography,
                interests:selectedInterest

            }).success(function (data) {
                $scope.error = data.error;
                $location.path(data.redirect);
            });

        };
    };

    var signupController = function ($scope) {
        $scope.categories = [''];
        $scope.newCategory = "";
        $scope.saveCategory = function () {

        };

    };

    var editableCheckboxController = function ($scope) {
        $scope.category = "";
        $scope.showLabel = false;
        $scope.showTextbox = true;
        $scope.saveCategory = function () {
            if ($scope.category) {
                $scope.showLabel = true;
                $scope.showTextbox = false;
            }
            else {
                $scope.showLabel = false;
                $scope.showTextbox = true;
            }
        };
        $scope.edit = function () {
            $scope.showLabel = false;
            $scope.showTextbox = true;
        };
        $scope.isChecked = function(qId){
            console.log(qId);
            if(qId!==  " ") {
                if (selectedInterest.indexOf(qId) !== -1) {
                    var index = selectedInterest.indexOf(qId);
                    if (index > -1) {
                        selectedInterest.splice(index, 1);
                        console.log(selectedInterest);
                    }
                } else {
                    selectedInterest.push(qId);
                    console.log(selectedInterest);
                }
            }
        };
        $scope.stateChanged = function (qId) {

        };

    };

    angular.module("app")
        .controller("loginController", ["$scope", "$http", "$location", loginController])
        .controller("signupController", ["$scope", signupController])
        .controller("editableCheckboxController", ["$scope", editableCheckboxController]);
})();
/**
 * Created by Nikita on 21/12/2015.
 */
(function () {
    "use strict";

    /*var signupController = function ($scope) {
        $scope.categories = [''];
        $scope.newCategory = "";
        $scope.saveCategory = function () {

        };

    };

    var editableCheckboxController = function ($scope) {
        $scope.category = "";
        $scope.showLabel = false;
        $scope.showTextbox = true;
        $scope.saveCategory = function () {
            if ($scope.category) {
                $scope.showLabel = true;
                $scope.showTextbox = false;
            }
            else {
                $scope.showLabel = false;
                $scope.showTextbox = true;
            }
        };
        $scope.edit = function () {
            $scope.showLabel = false;
            $scope.showTextbox = true;
        };

    };
    angular.module("app")
        .controller("signupController", ["$scope", signupController])
        .controller("editableCheckboxController", ["$scope", editableCheckboxController]);*/


})();
/**
 * Created by Marthe on 16/12/15.
 */
(function () {
    "use strict";

    var userController = function ($scope, $rootScope, $http, $location) {
        $http.get('/user').success(function(data) {
            $scope.user = data;
            $rootScope.user = data;

            if(data.username == 'admin'){
                $scope.auth = {isAuth: true, isAdmin : true};
            }
            else if(data.username != 'admin' && data.username !== undefined){
                $scope.auth = {isAuth: true, isAdmin : false};
            }
            else if(data.username === undefined){
                $scope.auth = {isAuth: false, isAdmin : false};

            }


        });


        /*$scope.logout = function() {
            $http.get('/logout').success(function (data) {
                $location.path(data.redirect);
            });
        };*/
    };


    angular.module("app").controller("userController", ["$scope", "$rootScope", "$http", "$location", userController]);
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsIkFjdGl2aXR5LmpzIiwiYWN0aXZpdGllc1NlcnZpY2UuanMiLCJkYlNlcnZpY2UuanMiLCJtYXRjaGVzU2VydmljZS5qcyIsIkFjdGl2aXRpZXNDb250cm9sbGVyLmpzIiwiTWF0Y2hlc0NvbnRyb2xsZXIuanMiLCJQcm9maWxlc0NvbnRyb2xsZXIuanMiLCJVc2Vyc0NvbnRyb2xsZXIuanMiLCJsb2NhdGlvbkNvbnRyb2xsZXIuanMiLCJsb2dpbkNvbnRyb2xsZXIuanMiLCJzaWdudXBDb250cm9sbGVyLmpzIiwidXNlckNvbnRyb2xsZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2hIQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDVkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNyRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDekZBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3pGQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDOWFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMvQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3JGQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDM0NBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUM5Q0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3RIQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDeENBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJhcHAubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDcmVhdGVkIGJ5IE1hcnRoZSBvbiAxMC8xMi8xNS5cbiAqL1xuXG4oZnVuY3Rpb24oKXtcbiAgICB2YXIgYXBwID0gYW5ndWxhci5tb2R1bGUoXCJhcHBcIiwgW1wibmdSb3V0ZVwiXSk7XG4gICAgYXBwLmNvbmZpZyhmdW5jdGlvbigkcm91dGVQcm92aWRlcil7XG4gICAgICAgICRyb3V0ZVByb3ZpZGVyXG4gICAgICAgICAgICAud2hlbihcIi9cIix7XG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwiLi92aWV3cy9ob21lLmh0bWxcIlxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC53aGVuKFwiL3NpZ251cFwiLHtcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCJ2aWV3cy9zaWdudXAuaHRtbFwiXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLndoZW4oXCIvaG9tZVwiLHtcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL3ZpZXdzL2hvbWUuaHRtbFwiXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLndoZW4oXCIvbWF0Y2hlc1wiLHtcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL3ZpZXdzL21hdGNoZXMuaHRtbFwiXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLndoZW4oXCIvaG93dG9cIix7XG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwiLi92aWV3cy9ob3dUby5odG1sXCJcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAud2hlbihcIi9hY3Rpdml0aWVzXCIse1xuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vdmlld3MvYWN0aXZpdGllcy5odG1sXCJcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAud2hlbihcIi9hZG1pblwiLHtcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL3ZpZXdzL2FkbWluLmh0bWxcIlxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC53aGVuKFwiL3NlYXJjaHByb2ZpbGVzXCIse1xuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vdmlld3Mvc2VhcmNoUHJvZmlsZXMuaHRtbFwiXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLndoZW4oXCIvbXlwcm9maWxlXCIse1xuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vdmlld3MvbXlQcm9maWxlLmh0bWxcIlxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC53aGVuKFwiL3VzZXJkZXRhaWxzLzp1c2VybmFtZVwiLHtcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL3ZpZXdzL2RldGFpbHNVc2VyLmh0bWxcIixcbiAgICAgICAgICAgICAgICBjb250cm9sbGVyOiAnVXNlcnNDb250cm9sbGVyJ1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC53aGVuKFwiL2RldGFpbHN1c2VyXCIse1xuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vdmlld3MvZGV0YWlsc1VzZXIuaHRtbFwiXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLndoZW4oXCIvYWN0aXZpdHlkZXRhaWxzLzphY3Rpdml0eU5hbWVcIiwge1xuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vdmlld3MvZGV0YWlsc0FjdGl2aXR5Lmh0bWxcIixcbiAgICAgICAgICAgICAgICBjb250cm9sbGVyOiBcIkFjdGl2aXRpZXNDb250cm9sbGVyXCJcblxuICAgICAgICAgICAgfSk7XG5cblxuICAgIH0pO1xuXG4gICAgYXBwLnJ1bihmdW5jdGlvbiAoJHJvb3RTY29wZSkge1xuICAgICAgICAkcm9vdFNjb3BlLnVzZXIgPSB7fTtcbiAgICB9KTtcblxuICAgIGFwcC5kaXJlY3RpdmUoJ25nRW50ZXInLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7XG4gICAgICAgICAgICBlbGVtZW50LmJpbmQoXCJrZXlkb3duIGtleXByZXNzXCIsIGZ1bmN0aW9uIChldmVudCkge1xuICAgICAgICAgICAgICAgIGlmIChldmVudC53aGljaCA9PT0gMTMpIHtcbiAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiRldmFsKGF0dHJzLm5nRW50ZXIpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgIH0pO1xuXG5cbiAgICBhcHAuZGlyZWN0aXZlKCdmaWxlTW9kZWwnLCBbJyRwYXJzZScsIGZ1bmN0aW9uICgkcGFyc2UpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHJlc3RyaWN0OiAnQScsXG4gICAgICAgICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMpIHtcbiAgICAgICAgICAgICAgICB2YXIgbW9kZWwgPSAkcGFyc2UoYXR0cnMuZmlsZU1vZGVsKTtcbiAgICAgICAgICAgICAgICB2YXIgbW9kZWxTZXR0ZXIgPSBtb2RlbC5hc3NpZ247XG5cbiAgICAgICAgICAgICAgICBlbGVtZW50LmJpbmQoJ2NoYW5nZScsIGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpe1xuICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWxTZXR0ZXIoc2NvcGUsIGVsZW1lbnRbMF0uZmlsZXNbMF0pO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICB9XSk7XG5cbiAgICBhcHAuc2VydmljZSgnZmlsZVVwbG9hZCcsIFsnJGh0dHAnLCBmdW5jdGlvbiAoJGh0dHApIHtcbiAgICAgICAgdGhpcy51cGxvYWRGaWxlVG9VcmwgPSBmdW5jdGlvbihmaWxlLCB1cGxvYWRVcmwpe1xuICAgICAgICAgICAgdmFyIGZkID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgICAgICAgICBmZC5hcHBlbmQoJ2ZpbGUnLCBmaWxlKTtcbiAgICAgICAgICAgICRodHRwLnBvc3QodXBsb2FkVXJsLCBmZCwge1xuICAgICAgICAgICAgICAgIHRyYW5zZm9ybVJlcXVlc3Q6IGFuZ3VsYXIuaWRlbnRpdHksXG4gICAgICAgICAgICAgICAgaGVhZGVyczogeydDb250ZW50LVR5cGUnOiB1bmRlZmluZWR9XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5zdWNjZXNzKGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwic3VjY2Vzc1wiKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5lcnJvcihmdW5jdGlvbigpe1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcImVycm9yXCIpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgIH1dKTtcblxuXG4gICAgYXBwLmRpcmVjdGl2ZSgnZWRpdGFibGVDaGVja2JveCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHJlc3RyaWN0OiAnRScsXG4gICAgICAgICAgICB0ZW1wbGF0ZVVybDogJy4vdmlld3MvZWRpdGFibGVjaGVja2JveC5odG1sJ1xuICAgICAgICB9O1xuICAgIH0pO1xuXG5cbn0pKCk7IiwiLyoqXG4gKiBDcmVhdGVkIGJ5IGltYW4gb24gMTUvMTIvMTUuXG4gKi9cbnZhciBBY3Rpdml0eSA9IGZ1bmN0aW9uKGltZywgbmFtZSwgcGxhY2UsIGtleXdvcmRzLCBwYXJ0aWNpcGFudHMsIG15RXZlbnQpe1xuICAgIHRoaXMuaW1nID0gaW1nO1xuICAgIHRoaXMubmFtZSA9IG5hbWU7XG4gICAgdGhpcy5wbGFjZSA9IHBsYWNlO1xuICAgIHRoaXMua2V5d29yZHMgPSBrZXl3b3JkcztcbiAgICB0aGlzLnBhcnRpY2lwYW50cyA9IHBhcnRpY2lwYW50cztcbiAgICB0aGlzLm15RXZlbnQgPSBteUV2ZW50O1xufTsiLCIvKipcbiAqIENyZWF0ZWQgYnkgaW1hbiBvbiA1LzEyLzE1LlxuICovXG4vKihmdW5jdGlvbigpe1xuXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG5cbiAgICB2YXIgYWN0aXZpdGllc1NlcnZpY2UgPSBmdW5jdGlvbiAoKSB7XG5cbiAgICAgICAgdmFyIGdldEFjdGl2aXRpZXMgPSBmdW5jdGlvbiAoKSB7XG5cbiAgICAgICAgICAgIHZhciBsb2NhbFVybCA9IFwiaHR0cDovL2xvY2FsaG9zdDozMDAwL2RhdGEvYWN0aXZpdGllcy5qc29uXCI7XG4gICAgICAgICAgICB2YXIgeG1sSHR0cCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgICAgICAgICAgeG1sSHR0cC5vcGVuKFwiR0VUXCIsIGxvY2FsVXJsLCBmYWxzZSk7XG4gICAgICAgICAgICB4bWxIdHRwLnNlbmQobnVsbCk7XG5cbiAgICAgICAgICAgIGlmKHhtbEh0dHAuc3RhdHVzID09IDIwMCkge1xuXG4gICAgICAgICAgICAgICAgdmFyIGRhdGEgPSBKU09OLnBhcnNlKHhtbEh0dHAucmVzcG9uc2VUZXh0KTtcblxuICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coZGF0YSk7XG5cbiAgICAgICAgICAgICAgICB2YXIgYXJyQWN0aXZpdGllcyA9IFtdO1xuXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgdmFyIGQgPSBkYXRhW2ldO1xuXG4gICAgICAgICAgICAgICAgICAgIHZhciBuZXdBY3Rpdml0eSA9IG5ldyBBY3Rpdml0eSgpO1xuICAgICAgICAgICAgICAgICAgICBuZXdBY3Rpdml0eS5pbWcgPSBkLmltZztcbiAgICAgICAgICAgICAgICAgICAgbmV3QWN0aXZpdHkubmFtZSA9IGQubmFtZTtcbiAgICAgICAgICAgICAgICAgICAgbmV3QWN0aXZpdHkucGxhY2UgPSBkLnBsYWNlO1xuICAgICAgICAgICAgICAgICAgICBuZXdBY3Rpdml0eS5wYXJ0aWNpcGFudHMgPSBkLnBhcnRpY2lwYW50cztcbiAgICAgICAgICAgICAgICAgICAgbmV3QWN0aXZpdHkubXlFdmVudCA9IGQubXlFdmVudDtcblxuICAgICAgICAgICAgICAgICAgICB2YXIgdGV4dCA9IFwiXCI7XG5cbiAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBpaT0wOyBpaTwgZC5rZXl3b3Jkcy5sZW5ndGg7IGlpKyspe1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYoaWkgPT0gZC5rZXl3b3Jkcy5sZW5ndGgtMSl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCArPSBkLmtleXdvcmRzW2lpXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2V7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCArPSBkLmtleXdvcmRzW2lpXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ICs9IFwiLCBcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIG5ld0FjdGl2aXR5LmtleXdvcmRzID0gdGV4dDtcbiAgICAgICAgICAgICAgICAgICAgYXJyQWN0aXZpdGllcy5wdXNoKG5ld0FjdGl2aXR5KTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gYXJyQWN0aXZpdGllcztcblxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH07XG5cbiAgICAgICAgLy9wdWJsaWMgZ2VkZWVsdGVcbiAgICAgICAgcmV0dXJue1xuXG4gICAgICAgICAgICBnZXRBY3Rpdml0aWVzOmdldEFjdGl2aXRpZXNcblxuICAgICAgICB9O1xuXG4gICAgfTtcblxuICAgIGFuZ3VsYXIubW9kdWxlKFwiYXBwXCIpLmZhY3RvcnkoXCJhY3Rpdml0aWVzU2VydmljZVwiLCBbYWN0aXZpdGllc1NlcnZpY2VdKTtcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBeIGRlemUgbmFhbSBiZXBhYWx0IHdlbGtlIG5hYW0gamUgbm9kaWcgaGVidCBpbiBqZSBjb250cm9sbGVyIGFscyB2ZXJ3aWp6aW5nIVxuXG59KSgpOyovIiwiLyoqXG4gKiBDcmVhdGVkIGJ5IGltYW4gb24gMTUvMTIvMTUuXG4gKi9cblxuXG4oZnVuY3Rpb24oKXtcblxuICAgIFwidXNlIHN0cmljdFwiO1xuXG4gICAgdmFyIGRiU2VydmljZSA9IGZ1bmN0aW9uICgkaHR0cCkge1xuXG4gICAgICAgIHZhciBnZXRDb2xsZWN0aW9uID0gZnVuY3Rpb24gKGNvbGxlY3Rpb24pIHtcblxuXG4gICAgICAgICAgICB2YXIgdXJsID0gXCJodHRwOi8vbG9jYWxob3N0OjMwMDAvYXBpL1wiICsgY29sbGVjdGlvbjtcbiAgICAgICAgICAgIHJldHVybiAkaHR0cC5nZXQodXJsKS50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKXtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YTtcblxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfTtcblxuICAgICAgICB2YXIgZ2V0QnlJRCA9IGZ1bmN0aW9uIChjb2xsZWN0aW9uLCBpZCkge1xuICAgICAgICAgICAgdmFyIHVybCA9IFwiaHR0cDovL2xvY2FsaG9zdDozMDAwL2FwaS9cIiArIGNvbGxlY3Rpb24gKyBcIi9cIiArIGlkO1xuICAgICAgICAgICAgcmV0dXJuICRodHRwLmdldCh1cmwpLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2Upe1xuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5kYXRhO1xuXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9O1xuXG4gICAgICAgIHZhciBnZXREZXRhaWxzVXNlciA9IGZ1bmN0aW9uIChjb2xsZWN0aW9uLCB1c2VybmFtZSkge1xuICAgICAgICAgICAgdmFyIHVybCA9IFwiaHR0cDovL2xvY2FsaG9zdDozMDAwL2FwaS9cIiArIGNvbGxlY3Rpb24gKyBcIi91c2VyZGV0YWlsL1wiICsgdXNlcm5hbWU7XG4gICAgICAgICAgICByZXR1cm4gJGh0dHAuZ2V0KHVybCkudGhlbihmdW5jdGlvbihyZXNwb25zZSl7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH07XG5cbiAgICAgICAgdmFyIGdldEl0ZW0gPSBmdW5jdGlvbihpdGVtKXtcblxuICAgICAgICAgICAgdmFyIHVybCA9IFwiaHR0cDovL2xvY2FsaG9zdDozMDAwL2FwaS9cIiArIGl0ZW07XG4gICAgICAgICAgICByZXR1cm4gJGh0dHAuZ2V0KCcvdXNlcicpLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2Upe1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH07XG5cbiAgICAgICAgdmFyIGdldERldGFpbHNBY3Rpdml0eSA9IGZ1bmN0aW9uIChjb2xsZWN0aW9uLCBhY3Rpdml0eW5hbWUpIHtcbiAgICAgICAgICAgIHZhciB1cmwgPSBcImh0dHA6Ly9sb2NhbGhvc3Q6MzAwMC9hcGkvXCIgKyBjb2xsZWN0aW9uICsgXCIvYWN0aXZpdHlkZXRhaWwvXCIgKyBhY3Rpdml0eW5hbWU7XG4gICAgICAgICAgICByZXR1cm4gJGh0dHAuZ2V0KHVybCkudGhlbihmdW5jdGlvbihyZXNwb25zZSl7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH07XG5cbiAgICAgICAgdmFyIGdldE5vaXNlV29yZHMgPSBmdW5jdGlvbiAoKSB7XG5cbiAgICAgICAgICAgIHZhciB1cmwgPSBcImh0dHA6Ly9sb2NhbGhvc3Q6MzAwMC9kYXRhL25vaXNld29yZHMuanNvblwiO1xuICAgICAgICAgICAgcmV0dXJuICRodHRwLmdldCh1cmwpLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2Upe1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH07XG5cblxuICAgICAgICAvL3B1YmxpYyBnZWRlZWx0ZVxuICAgICAgICByZXR1cm57XG5cbiAgICAgICAgICAgIGdldENvbGxlY3Rpb246Z2V0Q29sbGVjdGlvbixcbiAgICAgICAgICAgIGdldEJ5SUQ6Z2V0QnlJRCxcbiAgICAgICAgICAgIGdldEl0ZW06Z2V0SXRlbSxcbiAgICAgICAgICAgIGdldERldGFpbHNVc2VyOiBnZXREZXRhaWxzVXNlcixcbiAgICAgICAgICAgIGdldERldGFpbHNBY3Rpdml0eTogZ2V0RGV0YWlsc0FjdGl2aXR5LFxuICAgICAgICAgICAgZ2V0Tm9pc2VXb3JkczogZ2V0Tm9pc2VXb3Jkc1xuXG4gICAgICAgIH07XG5cbiAgICB9O1xuXG4gICAgYW5ndWxhci5tb2R1bGUoXCJhcHBcIikuZmFjdG9yeShcImRiU2VydmljZVwiLCBbXCIkaHR0cFwiLCBkYlNlcnZpY2VdKTtcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBeIGRlemUgbmFhbSBiZXBhYWx0IHdlbGtlIG5hYW0gamUgbm9kaWcgaGVidCBpbiBqZSBjb250cm9sbGVyIGFscyB2ZXJ3aWp6aW5nIVxuXG59KSgpOyIsIi8qKlxuICogQ3JlYXRlZCBieSBpbWFuIG9uIDUvMTIvMTUuXG4gKi9cbihmdW5jdGlvbigpe1xuXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG5cbiAgICB2YXIgbWF0Y2hlc1NlcnZpY2UgPSBmdW5jdGlvbiAoKSB7XG5cbiAgICAgICAgdmFyIGdldE1hdGNoZXMgPSBmdW5jdGlvbiAobmFtZVVzZXIpIHtcblxuICAgICAgICAgICAgdmFyIHZhcmlhYmVsVVJMID0gXCJ0b2dldGhlclwiO1xuICAgICAgICAgICAgdmFyIGxvY2FsVXJsID0gXCJodHRwOi8vbG9jYWxob3N0OjMwMDAvZGF0YS9tYXRjaGVzLmpzb25cIjtcbiAgICAgICAgICAgIHZhciB4bWxIdHRwID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XG4gICAgICAgICAgICB4bWxIdHRwLm9wZW4oXCJHRVRcIiwgbG9jYWxVcmwsIGZhbHNlKTtcbiAgICAgICAgICAgIHhtbEh0dHAuc2VuZChudWxsKTtcblxuICAgICAgICAgICAgaWYoeG1sSHR0cC5zdGF0dXMgPT0gMjAwKSB7XG5cbiAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IEpTT04ucGFyc2UoeG1sSHR0cC5yZXNwb25zZVRleHQpO1xuICAgICAgICAgICAgICAgIHZhciBhcnIgPSBbXTtcbiAgICAgICAgICAgICAgICB2YXIgYXJyTWF0Y2hlcyA9IFtdO1xuICAgICAgICAgICAgICAgIHZhciBhcnJNYXRjaFVzZXJzID0gW107XG4gICAgICAgICAgICAgICAgdmFyIGFyck1hdGNoSW50ZXJlc3RzID0gW107XG5cbiAgICAgICAgICAgICAgICBmb3IodmFyIGk9MDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspe1xuXG4gICAgICAgICAgICAgICAgICAgIHZhciBvYmogPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBcInVzZXJcIjogZGF0YVtpXS51c2VyLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJtYXRjaGVzXCI6ZGF0YVtpXS5tYXRjaGVzXG4gICAgICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICAgICAgYXJyLnB1c2gob2JqKTtcblxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGZvcih2YXIgaWkgPSAwOyBpaTxhcnIubGVuZ3RoOyBpaSsrKXtcblxuICAgICAgICAgICAgICAgICAgICB2YXIgaW5kZXggPSBhcnJbaWldLnVzZXIuaW5kZXhPZihuYW1lVXNlcik7XG4gICAgICAgICAgICAgICAgICAgIGlmKGluZGV4ID09PSAwKXtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFyck1hdGNoZXMucHVzaChhcnJbaWldLm1hdGNoZXMpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coXCJJbmRleDogXCIraW5kZXgpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coYXJyKTtcbiAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKGFyck1hdGNoZXNbMF0pO1xuXG5cbiAgICAgICAgICAgICAgICB2YXIgYXJyTWF0Y2hlc0J5VXNlciA9IGFyck1hdGNoZXNbMF07XG4gICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhcIkFhbnRhbCBtYXRjaGVzOiBcIiArIGFyck1hdGNoZXNCeVVzZXIubGVuZ3RoKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBhcnJNYXRjaGVzQnlVc2VyO1xuXG4gICAgICAgICAgICAgICAgLypcbiAgICAgICAgICAgICAgICBmb3IodmFyIGlpaSA9IDA7IGlpaTxhcnJNYXRjaGVzWzBdLmxlbmd0aDsgaWlpKyspe1xuXG4gICAgICAgICAgICAgICAgICAgIHZhciBtYXRjaFVzZXIgPSBhcnJNYXRjaGVzWzBdW2lpaV0udXNlcjtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG1hdGNoSW50ZXJlc3RzID0gYXJyTWF0Y2hlc1swXVtpaWldLmludGVyZXN0cztcblxuICAgICAgICAgICAgICAgICAgICBhcnJNYXRjaFVzZXJzLnB1c2gobWF0Y2hVc2VyKTtcbiAgICAgICAgICAgICAgICAgICAgYXJyTWF0Y2hJbnRlcmVzdHMucHVzaChtYXRjaEludGVyZXN0cyk7XG5cbiAgICAgICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhtYXRjaFVzZXIpO1xuICAgICAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKG1hdGNoSW50ZXJlc3RzKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhhcnJNYXRjaFVzZXJzKTtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhhcnJNYXRjaEludGVyZXN0cyk7XG4gICAgICAgICAgICAgICAgKi9cblxuICAgICAgICAgICAgfVxuXG5cblxuICAgICAgICB9O1xuXG4gICAgICAgIC8vcHVibGljIGdlZGVlbHRlXG4gICAgICAgIHJldHVybntcblxuICAgICAgICAgICAgZ2V0TWF0Y2hlczpnZXRNYXRjaGVzLFxuXG4gICAgICAgIH07XG5cbiAgICB9O1xuXG4gICAgYW5ndWxhci5tb2R1bGUoXCJhcHBcIikuZmFjdG9yeShcIm1hdGNoZXNTZXJ2aWNlXCIsIFttYXRjaGVzU2VydmljZV0pO1xuICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF4gZGV6ZSBuYWFtIGJlcGFhbHQgd2Vsa2UgbmFhbSBqZSBub2RpZyBoZWJ0IGluIGplIGNvbnRyb2xsZXIgYWxzIHZlcndpanppbmchXG5cbn0pKCk7IiwiLyoqXG4gKiBDcmVhdGVkIGJ5IGltYW4gb24gNS8xMi8xNS5cbiAqL1xuXG4oZnVuY3Rpb24oKSB7XG5cbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICB2YXIgQWN0aXZpdGllc0NvbnRyb2xsZXIgPSBmdW5jdGlvbiAoJHNjb3BlLCBkYlNlcnZpY2UsICRodHRwLCAkbG9jYXRpb24sICRyb3V0ZVBhcmFtcywgJHJvdXRlKSB7XG4gICAgICAgICRzY29wZS5pbnRlcmVzdGVkQWN0PXRydWU7XG4gICAgICAgICRzY29wZS5uYW1lQnV0dG9uID0gXCJJbnRlcmVzdGVkXCI7XG5cbiAgICAgICAgJHNjb3BlLmdldEFjdGl2aXRpZXMgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBkYlNlcnZpY2UuZ2V0Q29sbGVjdGlvbignYWN0aXZpdGllcycpLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7XG5cbiAgICAgICAgICAgICAgICB2YXIgYXJyVGVtcCA9IHJlc3BvbnNlLmFjdGl2aXRpZWxpc3Q7XG4gICAgICAgICAgICAgICAgdmFyIGFyckFjdHMgPSBbXTtcblxuICAgICAgICAgICAgICAgIC8qdmFyIHRvZGF5ID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpLnN1YnN0cmluZygwLCAxMCksXG4gICAgICAgICAgICAgICAgICAgIHRvZGF5U3BsaXQgPSB0b2RheS5zcGxpdChcIi1cIiksXG4gICAgICAgICAgICAgICAgICAgIHN1bVRvZGF5ID0gIHRvZGF5U3BsaXRbMF0gKyAgdG9kYXlTcGxpdFsxXSArICB0b2RheVNwbGl0WzJdOyovXG5cbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGFyclRlbXAubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIC8qdmFyIGFjdGl2dHlEYXRlU3BsaXQgPSBhcnJUZW1wW2ldLnVudGlsRGF0ZS5zdWJzdHJpbmcoMCwxMCkuc3BsaXQoXCItXCIpLFxuICAgICAgICAgICAgICAgICAgICAgICAgc3VtQWN0aXZpdHkgPSAgYWN0aXZ0eURhdGVTcGxpdFswXSArIGFjdGl2dHlEYXRlU3BsaXRbMV0gKyBhY3RpdnR5RGF0ZVNwbGl0WzJdO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIHN1bUFjdGl2aXR5ID49IHN1bVRvZGF5KSB7Ki9cbiAgICAgICAgICAgICAgICAgICAgICBhcnJBY3RzLnB1c2goYXJyVGVtcFtpXSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgJHNjb3BlLmFyckFjdGl2aXRpZXMgPSBhcnJBY3RzO1xuXG4gICAgICAgICAgICB9KTtcblxuXG4gICAgICAgIH07XG5cbiAgICAgICAgU3RyaW5nLnByb3RvdHlwZS5yZXBsYWNlQWxsID0gZnVuY3Rpb24oIHRva2VuLCBuZXdUb2tlbiwgaWdub3JlQ2FzZSApIHtcbiAgICAgICAgICAgIHZhciBfdG9rZW47XG4gICAgICAgICAgICB2YXIgc3RyID0gdGhpcyArIFwiXCI7XG4gICAgICAgICAgICB2YXIgaSA9IC0xO1xuXG4gICAgICAgICAgICBpZiAoIHR5cGVvZiB0b2tlbiA9PT0gXCJzdHJpbmdcIiApIHtcblxuICAgICAgICAgICAgICAgIGlmICggaWdub3JlQ2FzZSApIHtcblxuICAgICAgICAgICAgICAgICAgICBfdG9rZW4gPSB0b2tlbi50b0xvd2VyQ2FzZSgpO1xuXG4gICAgICAgICAgICAgICAgICAgIHdoaWxlKCAoXG4gICAgICAgICAgICAgICAgICAgICAgICBpID0gc3RyLnRvTG93ZXJDYXNlKCkuaW5kZXhPZihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbiwgaSA+PSAwID8gaSArIG5ld1Rva2VuLmxlbmd0aCA6IDBcbiAgICAgICAgICAgICAgICAgICAgICAgICkgKSAhPT0gLTFcbiAgICAgICAgICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RyID0gc3RyLnN1YnN0cmluZyggMCwgaSApICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdUb2tlbiArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyLnN1YnN0cmluZyggaSArIHRva2VuLmxlbmd0aCApO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zcGxpdCggdG9rZW4gKS5qb2luKCBuZXdUb2tlbiApO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHN0cjtcbiAgICAgICAgfTtcblxuICAgICAgICBmdW5jdGlvbiBpc0luQXJyYXkodmFsdWUsIGFycmF5KSB7XG4gICAgICAgICAgICByZXR1cm4gYXJyYXkuaW5kZXhPZih2YWx1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgZnVuY3Rpb24gZ2V0S2V5d29yZHNGcm9tRGVzY3JpcHRpb24oZGVzY3JpcHRpb24sIGNhbGxiYWNrKSB7XG5cbiAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gZGVzY3JpcHRpb24ucmVwbGFjZUFsbCgnLicsICcnKTtcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gZGVzY3JpcHRpb24ucmVwbGFjZUFsbCgnLCcsICcnKTtcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gZGVzY3JpcHRpb24ucmVwbGFjZUFsbCgnPycsICcnKTtcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gZGVzY3JpcHRpb24ucmVwbGFjZUFsbCgnIScsICcnKTtcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gZGVzY3JpcHRpb24ucmVwbGFjZUFsbCgnXCInLCAnJyk7XG4gICAgICAgICAgICBkZXNjcmlwdGlvbiA9IGRlc2NyaXB0aW9uLnJlcGxhY2VBbGwoXCInXCIsICcnKTtcblxuICAgICAgICAgICAgdmFyIHdvcmRzID0gZGVzY3JpcHRpb24uc3BsaXQoXCIgXCIpO1xuICAgICAgICAgICAgdmFyIGtleVdvcmRzID0gXCJcIjtcblxuICAgICAgICAgICAgZGJTZXJ2aWNlLmdldE5vaXNlV29yZHMoKS50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7XG5cbiAgICAgICAgICAgICAgICB2YXIgbm9pc2VXb3JkcyA9IHJlc3BvbnNlLm5vaXNld29yZHM7XG5cbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHdvcmRzLmxlbmd0aDsgaSsrKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzSW5BcnJheSh3b3Jkc1tpXS50b0xvd2VyQ2FzZSgpLCBub2lzZVdvcmRzKSA9PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAga2V5V29yZHMgKz0gd29yZHNbaV07XG4gICAgICAgICAgICAgICAgICAgICAgICBrZXlXb3JkcyArPSBcIiBcIjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vcmV0dXJuIGtleVdvcmRzO1xuICAgICAgICAgICAgICAgIGlmKCFrZXlXb3Jkcy5pc0VtcHR5KXtcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwga2V5V29yZHMpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGVsc2V7XG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKFwiTm8ga2V5d29yZHMgZm91bmQuXCIsIG51bGwpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgZnVuY3Rpb24gc3RyaW5nQ29uc2lzdE9mMk51bWJlcnMobnVtYmVyLCBjYWxsYmFjayl7XG4gICAgICAgICAgICAgICAgdmFyIG91dHB1dCA9IG51bWJlciArICcnO1xuICAgICAgICAgICAgICAgIGlmIChvdXRwdXQubGVuZ3RoIDwgMikge1xuICAgICAgICAgICAgICAgICAgICBvdXRwdXQgPSAnMCcgKyBvdXRwdXQ7XG4gICAgICAgICAgICAgICAgICAgIG51bWJlciA9IG91dHB1dC50b1N0cmluZygpO1xuXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2V7XG4gICAgICAgICAgICAgICAgICAgIG51bWJlciA9IG51bWJlci50b1N0cmluZygpO1xuICAgICAgICAgICAgICAgIH1cblxuXG4gICAgICAgICAgICBpZighbnVtYmVyLmlzRW1wdHkpe1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIG51bWJlcik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGVsc2V7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2soXCJObyBudW1iZXIuXCIsIG51bGwpO1xuICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgfVxuICAgICAgICBmdW5jdGlvbiBmdWxsRGF0ZShudW1iZXIsIG51bWJlcjIsIGNhbGxiYWNrKXtcbiAgICAgICAgICAgIHN0cmluZ0NvbnNpc3RPZjJOdW1iZXJzKG51bWJlciwgZnVuY3Rpb24oZXJyb3IsIG51bWJlclRvU3RyaW5nKXtcbiAgICAgICAgICAgICAgICBudW1iZXIgPSBudW1iZXJUb1N0cmluZztcbiAgICAgICAgICAgICAgICBpZihlcnJvcil7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycm9yKTtcblxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgc3RyaW5nQ29uc2lzdE9mMk51bWJlcnMobnVtYmVyMiwgZnVuY3Rpb24oZXJyb3IsIG51bWJlclRvU3RyaW5nKXtcbiAgICAgICAgICAgICAgICBudW1iZXIyID0gbnVtYmVyVG9TdHJpbmc7XG4gICAgICAgICAgICAgICAgaWYoZXJyb3Ipe1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnJvcik7XG5cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaWYoIW51bWJlci5pc0VtcHR5ICYmICFudW1iZXIyLmlzRW1wdHkpe1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIG51bWJlciwgbnVtYmVyMik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGVsc2V7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2soXCJObyBudW1iZXIuXCIsIG51bGwpO1xuICAgICAgICAgICAgfVxuXG5cblxuICAgICAgICB9XG5cblxuICAgICAgICAkc2NvcGUuYWRkQWN0aXZpdHkgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHZhciBhY3Rpdml0eU5hbWUgPSB0aGlzLmFjdGl2aXR5TmFtZTtcbiAgICAgICAgICAgIHZhciBzdHJlZXQgPSB0aGlzLnN0cmVldDtcbiAgICAgICAgICAgIHZhciBudW1iZXIgPSB0aGlzLm51bWJlcjtcbiAgICAgICAgICAgIHZhciB6aXBjb2RlID0gdGhpcy56aXBjb2RlO1xuICAgICAgICAgICAgdmFyIGRlc2NyaXB0aW9uID0gdGhpcy5jb21tZW50O1xuICAgICAgICAgICAgdmFyIGRhdGVGcm9tID0gdGhpcy5kYXRlRnJvbTtcbiAgICAgICAgICAgIHZhciBkYXRlVW50aWwgPSB0aGlzLmRhdGVVbnRpbDtcbiAgICAgICAgICAgIHZhciB0aW1lc3RhbXAgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICAgICAgICAgIHZhciBzdGFydFRpbWVIb3VyICA9IHRoaXMuc3RhcnRUaW1lSG91cjtcbiAgICAgICAgICAgIHZhciBzdGFydFRpbWVNaW4gPSB0aGlzLnN0YXJ0VGltZU1pbjtcbiAgICAgICAgICAgIHZhciBlbmRUaW1lSG91ciA9IHRoaXMuZW5kVGltZUhvdXI7XG4gICAgICAgICAgICB2YXIgZW5kVGltZU1pbiA9IHRoaXMuZW5kVGltZU1pbjtcbiAgICAgICAgICAgIHZhciBkYXRlRnJvbURheSA9IHRoaXMuZGF0ZUZyb21EYXk7XG4gICAgICAgICAgICB2YXIgZGF0ZUZyb21Nb250aCA9IHRoaXMuZGF0ZUZyb21Nb250aDtcbiAgICAgICAgICAgIHZhciBkYXRlRnJvbVllYXIgPSB0aGlzLmRhdGVGcm9tWWVhci50b1N0cmluZygpO1xuICAgICAgICAgICAgdmFyIGRhdGVVbnRpbERheSA9IHRoaXMuZGF0ZVVudGlsRGF5O1xuICAgICAgICAgICAgdmFyIGRhdGVVbnRpbE1vbnRoID0gdGhpcy5kYXRlVW50aWxNb250aDtcbiAgICAgICAgICAgIHZhciBkYXRlVW50aWxZZWFyID0gdGhpcy5kYXRlVW50aWxZZWFyLnRvU3RyaW5nKCk7XG5cbiAgICAgICAgICAgIGZ1bGxEYXRlKGRhdGVGcm9tRGF5LCBkYXRlRnJvbU1vbnRoLCBmdW5jdGlvbihlcnJvciwgZGF0ZUZyb21kYXlTdHJpbmcsIGRhdGVGcm9tTW9udGhTdHJpbmcpe1xuICAgICAgICAgICAgICAgIGRhdGVGcm9tRGF5ID0gZGF0ZUZyb21kYXlTdHJpbmc7XG4gICAgICAgICAgICAgICAgZGF0ZUZyb21Nb250aCA9IGRhdGVGcm9tTW9udGhTdHJpbmc7XG4gICAgICAgICAgICAgICAgaWYoZXJyb3Ipe1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnJvcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBmdWxsRGF0ZShkYXRlVW50aWxEYXksIGRhdGVVbnRpbE1vbnRoLCBmdW5jdGlvbihlcnJvciwgZGF0ZVVudGlsRGF5U3RyaW5nLCBkYXRlVW50aWxNb250aFN0cmluZyl7XG4gICAgICAgICAgICAgICAgZGF0ZVVudGlsRGF5ID0gZGF0ZVVudGlsRGF5U3RyaW5nO1xuICAgICAgICAgICAgICAgIGRhdGVVbnRpbE1vbnRoID0gZGF0ZVVudGlsTW9udGhTdHJpbmc7XG4gICAgICAgICAgICAgICAgaWYoZXJyb3Ipe1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnJvcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG5cblxuICAgICAgICAgICAgaWYoKHN0cmVldCAhPT0gdW5kZWZpbmVkKSAmJlxuICAgICAgICAgICAgICAgIChudW1iZXIgIT09IHVuZGVmaW5lZCkgJiZcbiAgICAgICAgICAgICAgICAoemlwY29kZSAhPT0gdW5kZWZpbmVkKSAmJlxuICAgICAgICAgICAgICAgIChkZXNjcmlwdGlvbiAhPT0gdW5kZWZpbmVkKSAmJlxuICAgICAgICAgICAgICAgICh0aW1lc3RhbXAgIT09IHVuZGVmaW5lZCkpe1xuXG4gICAgICAgICAgICAgICAgJHNjb3BlLmVycm9yID0gXCJcIjtcblxuICAgICAgICAgICAgICAgIGlmIChzdGFydFRpbWVNaW4gPCA2MCAmJiBzdGFydFRpbWVIb3VyIDwgMjUpIHtcblxuICAgICAgICAgICAgICAgICAgICBzdHJpbmdDb25zaXN0T2YyTnVtYmVycyhzdGFydFRpbWVIb3VyLCBmdW5jdGlvbihlcnJvciwgc3RhcnRUaW1lSG91clN0cmluZyl7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGFydFRpbWVIb3VyID0gc3RhcnRUaW1lSG91clN0cmluZztcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGVycm9yKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnJvcik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICBzdHJpbmdDb25zaXN0T2YyTnVtYmVycyhzdGFydFRpbWVNaW4sIGZ1bmN0aW9uKGVycm9yLCBzdGFydFRpbWVNaW5TdHJpbmcpe1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRUaW1lTWluID0gc3RhcnRUaW1lTWluU3RyaW5nO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYoZXJyb3Ipe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycm9yKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhzdGFydFRpbWVIb3VyKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coc3RhcnRUaW1lTWluKTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhcnRUaW1lTWluLmxlbmd0aCA9PT0gMiAgJiYgc3RhcnRUaW1lSG91ci5sZW5ndGggPT09IDIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiamUga29tdCBoaWVyIHRlcmVjaHRcIik7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGVuZFRpbWVNaW4gPCA2MCAmJiBlbmRUaW1lSG91ciA8IDI0KXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmdDb25zaXN0T2YyTnVtYmVycyhlbmRUaW1lSG91ciwgZnVuY3Rpb24oZXJyb3IsIGVuZFRpbWVIb3VyU3RyaW5nKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5kVGltZUhvdXIgPSBlbmRUaW1lSG91clN0cmluZztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZXJyb3Ipe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5nQ29uc2lzdE9mMk51bWJlcnMoZW5kVGltZU1pbiwgZnVuY3Rpb24oZXJyb3IsIGVuZFRpbWVNaW5TdHJpbmcpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmRUaW1lTWluID0gZW5kVGltZU1pblN0cmluZztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZXJyb3Ipe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyb3IpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVuZFRpbWVIb3VyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlbmRUaW1lTWluKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbmRUaW1lTWluLnRvU3RyaW5nKCkubGVuZ3RoID09PSAyICYmIGVuZFRpbWVIb3VyLnRvU3RyaW5nKCkubGVuZ3RoID09PSAyKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coc3RhcnRUaW1lSG91ciArIFwiOlwiICsgc3RhcnRUaW1lTWluKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZXRLZXl3b3Jkc0Zyb21EZXNjcmlwdGlvbihkZXNjcmlwdGlvbiwgZnVuY3Rpb24gKGVycm9yLCBkYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbiA9IGRhdGE7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZighZXJyb3Ipe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHN0YXJ0VGltZUhvdXIgKyBcIjpcIiArIHN0YXJ0VGltZU1pbik7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdXJsID0gXCJodHRwOi8vbG9jYWxob3N0OjMwMDAvYXBpL2FjdGl2aXRpZXMvYWRkYWN0aXZpdHlcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkaHR0cC5wb3N0KHVybCwge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3Rpdml0eU5hbWU6YWN0aXZpdHlOYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJlZXQgOiBzdHJlZXQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bWJlcjogbnVtYmVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB6aXBjb2RlOiB6aXBjb2RlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbiA6IGRlc2NyaXB0aW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRlRnJvbSA6IGRhdGVGcm9tWWVhciArIFwiLVwiICsgZGF0ZUZyb21Nb250aCArIFwiLVwiICsgIGRhdGVGcm9tRGF5ICsgXCIgXCIgKyBzdGFydFRpbWVIb3VyICsgXCI6XCIgKyBzdGFydFRpbWVNaW4gLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRlVW50aWwgOiBkYXRlVW50aWxZZWFyICsgXCItXCIgKyBkYXRlRnJvbU1vbnRoICtcIi1cIiArIGRhdGVVbnRpbERheSArIFwiIFwiICsgZW5kVGltZUhvdXIgKyBcIjpcIiArICBlbmRUaW1lTWluLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lc3RhbXAgOiB0aW1lc3RhbXBcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLnN1Y2Nlc3MoZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmVycm9yID0gZGF0YS5lcnJvcjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmdldEFjdGl2aXRpZXMoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzZXRGb3JtKCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8kbG9jYXRpb24ucGF0aChkYXRhLnJlZGlyZWN0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnJvcik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuZXJyb3IgPSBcIkVuZGRhdGUgaW5wdXQgaXMgbm90IGNvcnJlY3RcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2V7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmVycm9yID0gXCJFbmR0aW1lIGlucHV0IGlzIG5vdCBjb3JyZWN0XCI7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmVycm9yID0gJ0RlIHN0YXJ0aW1lIGxlbmd0aCBpcyBub3QgY29ycmVjdCEhISEgJztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmVycm9yID0gXCJTdGFydHRpbWUgaW5wdXQgaXMgbm90IGNvcnJlY3RcIjtcbiAgICAgICAgICAgICAgICB9XG5cblxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZXtcbiAgICAgICAgICAgICAgICAkc2NvcGUuZXJyb3IgPSBcIkVSUk9SOiBBbGwgZmllbGRzIGFyZSByZXF1aXJlZC44ODg4XCI7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgJHNjb3BlLmdldERldGFpbEFjdGl2aXR5ID0gZnVuY3Rpb24oY3VycmVudFVzZXIpe1xuICAgICAgICAgICAgZGJTZXJ2aWNlLmdldERldGFpbHNBY3Rpdml0eSgnYWN0aXZpdGllcycsICRyb3V0ZVBhcmFtcy5hY3Rpdml0eU5hbWUpLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2Upe1xuICAgICAgICAgICAgICAgICRzY29wZS5hcnJEZXRhaWxzQWN0aXZpdHkgPSByZXNwb25zZS5hY3Rpdml0eTtcbiAgICAgICAgICAgICAgICBpbml0bWFwKCk7XG5cbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygkc2NvcGUuYXJyRGV0YWlsc0FjdGl2aXR5Lm1hdGNoZXMpO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgJHNjb3BlLmFyckRldGFpbHNBY3Rpdml0eS5tYXRjaGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICgkc2NvcGUuYXJyRGV0YWlsc0FjdGl2aXR5Lm1hdGNoZXNbaV0gPT09IGN1cnJlbnRVc2VyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUubmFtZUJ1dHRvbiA9IFwiTm90IGludGVyZXN0ZWRcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5pbnRlcmVzdGVkQWN0ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuICRzY29wZS5hcnJEZXRhaWxzQWN0aXZpdHk7XG5cblxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgJHNjb3BlLmludGVyZXN0ZWQgPSBmdW5jdGlvbihhY3Rpdml0eU5hbWUsaW50ZXJlc3RlZFVzZXIsIGNyZWF0ZXJVc2VyKXtcbiAgICAgICAgICAgIHZhciB1cmwgPSBcIlwiO1xuICAgICAgICAgICAgdmFyIGludGVyZXN0ZWRBY3QgPSAkc2NvcGUuaW50ZXJlc3RlZEFjdDtcbiAgICAgICAgICAgIGlmKGludGVyZXN0ZWRBY3QgIT09IGZhbHNlKSB7XG5cbiAgICAgICAgICAgICAgICB1cmwgPSBcImh0dHA6Ly9sb2NhbGhvc3Q6MzAwMC9hcGkvYWN0aXZpdGllcy9pbnRlcmVzdGVkXCI7XG4gICAgICAgICAgICAgICAgJGh0dHAucG9zdCh1cmwsIHtcbiAgICAgICAgICAgICAgICAgICAgYWN0aXZpdHlOYW1lOiBhY3Rpdml0eU5hbWUsXG4gICAgICAgICAgICAgICAgICAgIGludGVyZXN0ZWRVc2VyOiBpbnRlcmVzdGVkVXNlcixcbiAgICAgICAgICAgICAgICAgICAgY3JlYXRlclVzZXI6IGNyZWF0ZXJVc2VyXG4gICAgICAgICAgICAgICAgfSkuc3VjY2VzcyhmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coaW50ZXJlc3RlZFVzZXIgKyBcIiBpcyBnZcOvbnRlcmVzc2VlcmQgaW4gXCIgKyBhY3Rpdml0eU5hbWUgKyBcIiBkb29yIFwiICsgY3JlYXRlclVzZXIpO1xuICAgICAgICAgICAgICAgICAgICAkc2NvcGUuaW50ZXJlc3RlZEFjdCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAkc2NvcGUubmFtZUJ1dHRvbiA9IFwiTm90IGludGVyZXN0ZWRcIjtcbiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmVycm9yID0gZGF0YS5lcnJvcjtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGludGVyZXN0ZWRBY3QpO1xuICAgICAgICAgICAgICAgIHVybCA9IFwiaHR0cDovL2xvY2FsaG9zdDozMDAwL2FwaS9hY3Rpdml0aWVzL2RlbGV0ZWludGVyZXN0ZWRcIjtcbiAgICAgICAgICAgICAgICAkaHR0cC5wb3N0KHVybCwge1xuICAgICAgICAgICAgICAgICAgICBhY3Rpdml0eU5hbWU6IGFjdGl2aXR5TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgaW50ZXJlc3RlZFVzZXI6IGludGVyZXN0ZWRVc2VyLFxuICAgICAgICAgICAgICAgICAgICBjcmVhdGVyVXNlcjogY3JlYXRlclVzZXJcbiAgICAgICAgICAgICAgICB9KS5zdWNjZXNzKGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGRhdGEpO1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhpbnRlcmVzdGVkVXNlciArIFwiIGlzIG5pZXQgbWVlciBnZcOvbnRlcmVzc2VlcmQgaW4gXCIgKyBhY3Rpdml0eU5hbWUgKyBcIiBkb29yIFwiICsgY3JlYXRlclVzZXIpO1xuICAgICAgICAgICAgICAgICAgICAkc2NvcGUuaW50ZXJlc3RlZEFjdCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICRzY29wZS5uYW1lQnV0dG9uID0gXCJJbnRlcmVzdGVkXCI7XG5cbiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmVycm9yID0gZGF0YS5lcnJvcjtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICBmdW5jdGlvbiByZWNlbnRGaXJzdChhLGIpIHtcbiAgICAgICAgICAgIGlmIChhLnRpbWVzdGFtcCA+IGIudGltZXN0YW1wKVxuICAgICAgICAgICAgICAgIHJldHVybiAtMTtcbiAgICAgICAgICAgIGlmIChhLnRpbWVzdGFtcCA8IGIudGltZXN0YW1wKVxuICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgIH1cblxuICAgICAgICAkc2NvcGUuZ2V0TW9zdFJlY2VudEFjdGl2aXRpZXMgPSBmdW5jdGlvbigpe1xuICAgICAgICAgICAgZGJTZXJ2aWNlLmdldENvbGxlY3Rpb24oJ2FjdGl2aXRpZXMnKS50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKXtcblxuICAgICAgICAgICAgICAgIHZhciBudW1iZXJPZkFjdGl2aXRpZXMgPSAzO1xuICAgICAgICAgICAgICAgIHZhciBhcnJUZW1wID0gcmVzcG9uc2UuYWN0aXZpdGllbGlzdDtcbiAgICAgICAgICAgICAgICB2YXIgYXJyQWxsQWN0aXZpdGllcyA9IFtdO1xuXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBhcnJUZW1wLmxlbmd0aDsgaSA8IGw7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBpZiAobmV3IERhdGUoYXJyVGVtcFtpXS51bnRpbERhdGUpLmdldFRpbWUoKSA+IG5ldyBEYXRlKCkuZ2V0VGltZSgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcnJBbGxBY3Rpdml0aWVzLnB1c2goYXJyVGVtcFtpXSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBhcnJBbGxBY3Rpdml0aWVzLnNvcnQocmVjZW50Rmlyc3QpO1xuXG4gICAgICAgICAgICAgICAgdmFyIGFyck1vc3RSZWNlbnRBY3Rpdml0aWVzID0gW107XG5cbiAgICAgICAgICAgICAgICBmb3IodmFyIGlpPTA7IGlpPG51bWJlck9mQWN0aXZpdGllczsgaWkrKyl7XG4gICAgICAgICAgICAgICAgICAgIGFyck1vc3RSZWNlbnRBY3Rpdml0aWVzLnB1c2goYXJyQWxsQWN0aXZpdGllc1tpaV0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAkc2NvcGUuYXJyTW9zdFJlY2VudEFjdGl2aXRpZXMgPSBhcnJNb3N0UmVjZW50QWN0aXZpdGllcztcblxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgZnVuY3Rpb24gaW5pdG1hcCgpIHtcblxuICAgICAgICAgICAgdmFyIG1hcCA9IG5ldyBnb29nbGUubWFwcy5NYXAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21hcCcpLCB7XG4gICAgICAgICAgICAgICAgem9vbTogMTIsXG4gICAgICAgICAgICAgICAgY2VudGVyOiB7bGF0OiA1MC44MTk0ODk0LCBsbmc6IDMuMjU3NzA3Nn1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdmFyIGdlb2NvZGVyID0gbmV3IGdvb2dsZS5tYXBzLkdlb2NvZGVyKCk7XG5cbiAgICAgICAgICAgIGdlb2NvZGVBZGRyZXNzKGdlb2NvZGVyLCBtYXApO1xuXG5cbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIGdlb2NvZGVBZGRyZXNzKGdlb2NvZGVyLCByZXN1bHRzTWFwKSB7XG4gICAgICAgICAgICB2YXIgc3RyZWV0ID0gJHNjb3BlLmFyckRldGFpbHNBY3Rpdml0eS5zdHJlZXQ7XG4gICAgICAgICAgICB2YXIgbnVtYmVyID0gJHNjb3BlLmFyckRldGFpbHNBY3Rpdml0eS5udW1iZXI7XG4gICAgICAgICAgICB2YXIgemlwY29kZSA9ICRzY29wZS5hcnJEZXRhaWxzQWN0aXZpdHkuemlwY29kZTtcblxuICAgICAgICAgICAgdmFyIGFkZHJlc3MgPSBzdHJlZXQgKyBcIiBcIiArIG51bWJlciArIFwiLCBcIiArIHppcGNvZGU7IC8vaGllciBhZGRyZXNzIHVpdCBkYiBpbnN0b3BwZW5cblxuICAgICAgICAgICAgZ2VvY29kZXIuZ2VvY29kZSh7J2FkZHJlc3MnOiBhZGRyZXNzfSwgZnVuY3Rpb24gKHJlc3VsdHMsIHN0YXR1cykge1xuICAgICAgICAgICAgICAgIGlmIChzdGF0dXMgPT09IGdvb2dsZS5tYXBzLkdlb2NvZGVyU3RhdHVzLk9LKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdHNNYXAuc2V0Q2VudGVyKHJlc3VsdHNbMF0uZ2VvbWV0cnkubG9jYXRpb24pO1xuICAgICAgICAgICAgICAgICAgICB2YXIgbWFya2VyID0gbmV3IGdvb2dsZS5tYXBzLk1hcmtlcih7XG4gICAgICAgICAgICAgICAgICAgICAgICBtYXA6IHJlc3VsdHNNYXAsXG4gICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogcmVzdWx0c1swXS5nZW9tZXRyeS5sb2NhdGlvblxuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhtYXJrZXIpO1xuXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgYWxlcnQoJ0dlb2NvZGUgd2FzIG5vdCBzdWNjZXNzZnVsIGZvciB0aGUgZm9sbG93aW5nIHJlYXNvbjogJyArIHN0YXR1cyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiByZXNldEZvcm0oKXtcbiAgICAgICAgICAgIHZhciBmcm0gPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5TmFtZSgnQWN0aXZpdHlGb3JtJylbMF07XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnamUga29tdCBpbiBkZSByZXNldGZvcm0nKTtcbiAgICAgICAgICAgIGZybS5yZXNldCgpO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIGFuZ3VsYXIubW9kdWxlKFwiYXBwXCIpLmNvbnRyb2xsZXIoXCJBY3Rpdml0aWVzQ29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgXCJkYlNlcnZpY2VcIiwgXCIkaHR0cFwiLFwiJGxvY2F0aW9uXCIsIFwiJHJvdXRlUGFyYW1zXCIsXCJmaWxlVXBsb2FkXCIsIEFjdGl2aXRpZXNDb250cm9sbGVyXSk7XG5cblxufSkoKTsiLCIvKipcbiAqIENyZWF0ZWQgYnkgaW1hbiBvbiA1LzEyLzE1LlxuICovXG5cbihmdW5jdGlvbigpe1xuXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG5cbiAgICB2YXIgTWF0Y2hlc0NvbnRyb2xsZXIgPSBmdW5jdGlvbigkc2NvcGUsIG1hdGNoZXNTZXJ2aWNlKSB7XG5cbiAgICAgICAgJHNjb3BlLnNob3dNYXRjaGVzID0gZnVuY3Rpb24oKXtcblxuICAgICAgICAgICAgdmFyIG5hbWVVc2VyID0gXCJMdW5hXCI7XG5cbiAgICAgICAgICAgIHZhciBhcnJNYXRjaGVzQnlVc2VyID0gbWF0Y2hlc1NlcnZpY2UuZ2V0TWF0Y2hlcyhuYW1lVXNlcik7XG5cbiAgICAgICAgICAgICRzY29wZS5hYW50YWxNYXRjaGVzID0gYXJyTWF0Y2hlc0J5VXNlci5sZW5ndGg7XG5cbiAgICAgICAgICAgICRzY29wZS5hcnJNYXRjaGVzID0gYXJyTWF0Y2hlc0J5VXNlcjtcblxuICAgICAgICAgICAgdmFyIHRleHQgPSBcIlwiO1xuICAgICAgICAgICAgZm9yKHZhciBpPTA7IGk8YXJyTWF0Y2hlc0J5VXNlci5sZW5ndGg7IGkrKyl7XG4gICAgICAgICAgICAgICAgdGV4dCA9IGFyck1hdGNoZXNCeVVzZXJbaV0uaW50ZXJlc3RzLnRvU3RyaW5nKCkucmVwbGFjZShcIiAsXCIsIFwiIFwiKTtcbiAgICAgICAgICAgICAgICBhcnJNYXRjaGVzQnlVc2VyW2ldLmludGVyZXN0cyA9IHRleHQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfTtcbiAgICB9O1xuXG4gICAgYW5ndWxhci5tb2R1bGUoXCJhcHBcIikuY29udHJvbGxlcihcIk1hdGNoZXNDb250cm9sbGVyXCIsIFtcIiRzY29wZVwiLCBcIm1hdGNoZXNTZXJ2aWNlXCIsIE1hdGNoZXNDb250cm9sbGVyXSk7XG5cbn0pKCk7IiwiLyoqXG4gKiBDcmVhdGVkIGJ5IGltYW4gb24gMjAvMTIvMTUuXG4gKi9cblxuXG4oZnVuY3Rpb24oKXtcblxuICAgIFwidXNlIHN0cmljdFwiO1xuXG4gICAgdmFyIFByb2ZpbGVzQ29udHJvbGxlciA9IGZ1bmN0aW9uKCRzY29wZSwgJHJvb3RTY29wZSwgJHJvdXRlUGFyYW1zLCBkYlNlcnZpY2UpIHtcblxuICAgICAgICB2YXIgY2xpY2tzT25CdG4gPSAwO1xuXG4gICAgICAgICRzY29wZS5zaG93RGl2ID0gZnVuY3Rpb24oKXtcbiAgICAgICAgICAgICRzY29wZS5maWx0ZXIgPSB7c2hvd0ZpbHRlcjp0cnVlfTtcbiAgICAgICAgICAgIGNsaWNrc09uQnRuKys7XG5cbiAgICAgICAgICAgIGlmKGNsaWNrc09uQnRuID4gMSl7XG4gICAgICAgICAgICAgICAgJHNjb3BlLmZpbHRlciA9IHtzaG93RmlsdGVyOmZhbHNlfTtcbiAgICAgICAgICAgICAgICBjbGlja3NPbkJ0biA9IDA7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgJHNjb3BlLmhpZGVEaXYgPSBmdW5jdGlvbigpe1xuICAgICAgICAgICAgY2xpY2tzT25CdG4gPSAwO1xuICAgICAgICAgICAgJHNjb3BlLmZpbHRlciA9IHtzaG93RmlsdGVyOmZhbHNlfTtcbiAgICAgICAgfTtcblxuICAgICAgICAkc2NvcGUuc2hvd1Byb2ZpbGVzID0gZnVuY3Rpb24oKXtcblxuICAgICAgICAgICAgdmFyIHVzZXJuYW1lID0gXCJcIjtcbiAgICAgICAgICAgIGlmKCRyb290U2NvcGUudXNlci51c2VybmFtZSAhPT0gdW5kZWZpbmVkKXtcbiAgICAgICAgICAgICAgICB1c2VybmFtZSA9ICRyb290U2NvcGUudXNlci51c2VybmFtZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZGJTZXJ2aWNlLmdldENvbGxlY3Rpb24oJ3VzZXJzJykudGhlbihmdW5jdGlvbihyZXNwb25zZSl7XG5cbiAgICAgICAgICAgICAgICB2YXIgYXJyUHJvZmlsZXMgPSByZXNwb25zZS51c2VybGlzdDtcbiAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgYXJyUHJvZmlsZXMubGVuZ3RoOyBpKyspe1xuICAgICAgICAgICAgICAgICAgICBpZihhcnJQcm9maWxlc1tpXS51c2VybmFtZSA9PT0gdXNlcm5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFyclByb2ZpbGVzLnNwbGljZShpLCAxKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBmb3IodmFyIGlpID0gMDsgaWkgPCBhcnJQcm9maWxlcy5sZW5ndGg7IGlpKyspe1xuICAgICAgICAgICAgICAgICAgICBpZihhcnJQcm9maWxlc1tpaV0udXNlcm5hbWUgPT09IFwiYWRtaW5cIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXJyUHJvZmlsZXMuc3BsaWNlKGlpLCAxKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAkc2NvcGUuYXJyUHJvZmlsZXMgPSBhcnJQcm9maWxlcztcblxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfTtcblxuICAgICAgICAkc2NvcGUuc29ydFByb3BlcnR5ID0gXCJ0aXRsZVwiO1xuICAgICAgICAkc2NvcGUuZmlsdGVyUXVlcnkgPSBcIlwiO1xuICAgICAgICAkc2NvcGUuZmlsdGVySW1hZ2VzID0gZnVuY3Rpb24oaSl7XG4gICAgICAgICAgICBpZigkc2NvcGUuZmlsdGVyUXVlcnkgPT09IFwiXCIpe1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvKlxuICAgICAgICAgICAgIGVsc2UgaWYoaS51c2VybmFtZS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoJHNjb3BlLmZpbHRlclF1ZXJ5LnRvTG9jYWxlTG93ZXJDYXNlKCkpID49IDApe1xuICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAqL1xuXG4gICAgICAgICAgICBlbHNlIGlmKGkuc2V4ID09PSB1bmRlZmluZWQpe1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZWxzZSBpZigkc2NvcGUuZmlsdGVyUXVlcnkudG9Mb3dlckNhc2UoKSA9PSBpLnNleC50b0xvd2VyQ2FzZSgpKXtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZWxzZSBpZigkc2NvcGUuZmlsdGVyUXVlcnkudG9Mb3dlckNhc2UoKSA9PT0gXCJub2ZpbHRlclwiKXtcbiAgICAgICAgICAgICAgICAkc2NvcGUuZmlsdGVyUXVlcnkgPSBcIlwiO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH07XG4gICAgfTtcblxuICAgIGFuZ3VsYXIubW9kdWxlKFwiYXBwXCIpLmNvbnRyb2xsZXIoXCJQcm9maWxlc0NvbnRyb2xsZXJcIiwgW1wiJHNjb3BlXCIsIFwiJHJvb3RTY29wZVwiLCBcIiRyb3V0ZVBhcmFtc1wiLCBcImRiU2VydmljZVwiLCBQcm9maWxlc0NvbnRyb2xsZXJdKTtcblxufSkoKTsiLCIvKipcbiAqIENyZWF0ZWQgYnkgaW1hbiBvbiAyMC8xMi8xNS5cbiAqL1xuKGZ1bmN0aW9uKCl7XG5cbiAgICBcInVzZSBzdHJpY3RcIjtcblxuICAgIHZhciBVc2Vyc0NvbnRyb2xsZXIgPSBmdW5jdGlvbigkc2NvcGUsICRyb3V0ZVBhcmFtcywgZGJTZXJ2aWNlKSB7XG5cbiAgICAgICAgJHNjb3BlLmdldFVzZXJzID0gZnVuY3Rpb24oKXtcblxuICAgICAgICAgICAgZGJTZXJ2aWNlLmdldENvbGxlY3Rpb24oJ3VzZXJzJykudGhlbihmdW5jdGlvbihyZXNwb25zZSl7XG5cbiAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKHJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgICAkc2NvcGUuYXJyVXNlcnMgPSByZXNwb25zZS51c2VybGlzdDtcblxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfTtcblxuICAgICAgICAkc2NvcGUuZ2V0RGV0YWlsVXNlciA9IGZ1bmN0aW9uKCl7XG5cbiAgICAgICAgICAgIGRiU2VydmljZS5nZXREZXRhaWxzVXNlcigndXNlcnMnLCAkcm91dGVQYXJhbXMudXNlcm5hbWUpLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2Upe1xuICAgICAgICAgICAgICAgICRzY29wZS5hcnJEZXRhaWxzID0gcmVzcG9uc2UuYWN0aXZpdHk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcblxuICAgICAgICAkc2NvcGUuZ2V0VXNlckJ5SUQgPSBmdW5jdGlvbigpe1xuXG4gICAgICAgICAgICBkYlNlcnZpY2UuZ2V0SXRlbSgndXNlcicpLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2Upe1xuXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2cocmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgICRzY29wZS51c2VyUHJvZmlsZSA9IHJlc3BvbnNlO1xuXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9O1xuXG5cbiAgICB9O1xuXG4gICAgYW5ndWxhci5tb2R1bGUoXCJhcHBcIikuY29udHJvbGxlcihcIlVzZXJzQ29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgXCIkcm91dGVQYXJhbXNcIiwgXCJkYlNlcnZpY2VcIiwgVXNlcnNDb250cm9sbGVyXSk7XG5cbn0pKCk7IiwiLyoqXG4gKiBDcmVhdGVkIGJ5IE1hcnRoZSBvbiAzMC8xMi8xNS5cbiAqL1xuXG5cbihmdW5jdGlvbigpe1xuICAgIFwidXNlIHN0cmljdFwiO1xuXG5cblxudmFyIGxvY2F0aW9uQ29udHJvbGxlciA9IGZ1bmN0aW9uKCRzY29wZSkge1xuXG4gICAgY29uc29sZS5sb2coJ1RFU1RFU1QnKTtcblxuICAgICRzY29wZS5pbml0bWFwID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIHZhciBtYXAgPSBuZXcgZ29vZ2xlLm1hcHMuTWFwKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYXAnKSwge1xuICAgICAgICAgICAgem9vbTogOCxcbiAgICAgICAgICAgIGNlbnRlcjoge2xhdDogNTAuODE5NDg5NCwgbG5nOiAzLjI1NzcwNzZ9XG4gICAgICAgIH0pO1xuICAgICAgICB2YXIgZ2VvY29kZXIgPSBuZXcgZ29vZ2xlLm1hcHMuR2VvY29kZXIoKTtcblxuICAgICAgICBnZW9jb2RlQWRkcmVzcyhnZW9jb2RlciwgbWFwKTtcblxuICAgIH07XG5cbiAgICBmdW5jdGlvbiBnZW9jb2RlQWRkcmVzcyhnZW9jb2RlciwgcmVzdWx0c01hcCkge1xuICAgICAgICB2YXIgYWRkcmVzcyA9IFwiR3JhYWYgS2FyZWwgZGUgR29lZGVsYWFuIDUsIEtvcnRyaWprXCI7IC8vaGllciBhZGRyZXNzIHVpdCBkYiBpbnN0b3BwZW5cblxuICAgICAgICBnZW9jb2Rlci5nZW9jb2RlKHsnYWRkcmVzcyc6IGFkZHJlc3N9LCBmdW5jdGlvbiAocmVzdWx0cywgc3RhdHVzKSB7XG4gICAgICAgICAgICBpZiAoc3RhdHVzID09PSBnb29nbGUubWFwcy5HZW9jb2RlclN0YXR1cy5PSykge1xuICAgICAgICAgICAgICAgIHJlc3VsdHNNYXAuc2V0Q2VudGVyKHJlc3VsdHNbMF0uZ2VvbWV0cnkubG9jYXRpb24pO1xuICAgICAgICAgICAgICAgIHZhciBtYXJrZXIgPSBuZXcgZ29vZ2xlLm1hcHMuTWFya2VyKHtcbiAgICAgICAgICAgICAgICAgICAgbWFwOiByZXN1bHRzTWFwLFxuICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogcmVzdWx0c1swXS5nZW9tZXRyeS5sb2NhdGlvblxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2cobWFya2VyKTtcblxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBhbGVydCgnR2VvY29kZSB3YXMgbm90IHN1Y2Nlc3NmdWwgZm9yIHRoZSBmb2xsb3dpbmcgcmVhc29uOiAnICsgc3RhdHVzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxufTtcblxuICAgIGFuZ3VsYXIubW9kdWxlKFwiYXBwXCIpLmNvbnRyb2xsZXIoXCJsb2NhdGlvbkNvbnRyb2xsZXJcIiwgW1wiJHNjb3BlXCIsIGxvY2F0aW9uQ29udHJvbGxlcl0pO1xufSkoKTsiLCIvKipcbiAqIENyZWF0ZWQgYnkgTWFydGhlIG9uIDE1LzEyLzE1LlxuICovXG4oZnVuY3Rpb24oKXtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICB2YXIgc2VsZWN0ZWRJbnRlcmVzdCA9IFtdO1xuXG4gICAgdmFyIGxvZ2luQ29udHJvbGxlciA9IGZ1bmN0aW9uICgkc2NvcGUsICRodHRwLCAkbG9jYXRpb24pIHtcblxuICAgICAgICAkc2NvcGUubG9naW4gPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICRodHRwXG4gICAgICAgICAgICAgICAgLnBvc3QoJy9sb2dpbicsIHtcbiAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWU6IHRoaXMudXNlcm5hbWUsXG4gICAgICAgICAgICAgICAgICAgIHBhc3N3b3JkOiB0aGlzLnBhc3N3b3JkXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAuc3VjY2VzcyhmdW5jdGlvbihkYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGRhdGEpO1xuICAgICAgICAgICAgICAgICAgICAkc2NvcGUuZXJyb3IgPSBkYXRhLmVycm9yO1xuICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24ucGF0aChkYXRhLnJlZGlyZWN0KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcblxuICAgICAgICAkc2NvcGUuaW50ZXJlc3RzID0gWydKYXp6JywgJ0hpcGhvcCcsICdOZXcgd2F2ZScsICdUcmF2ZWxpbmcnLCdQYXJ0eSddO1xuICAgICAgICAkc2NvcGUubHN0ID0gW107XG4gICAgICAgICRzY29wZS5jaGFuZ2UgPSBmdW5jdGlvbigpe1xuICAgICAgICAgICAgJHNjb3BlLmxzdC5wdXNoKCcyJyk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygkc2NvcGUubHN0KTtcbiAgICAgICAgfTtcbiAgICAgICAgJHNjb3BlLnN0YXRlQ2hhbmdlZCA9IGZ1bmN0aW9uIChxSWQpIHtcbiAgICAgICAgICAgIC8vaWYoISRzY29wZS5pbnRlcmVzdHNbcUlkXSl7IC8vSWYgaXQgaXMgY2hlY2tlZFxuICAgICAgICAgICAgaWYoc2VsZWN0ZWRJbnRlcmVzdC5pbmRleE9mKHFJZCkgIT09IC0xKSB7XG4gICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZygnYXJ0TnIgYWxyZWFkeSBleGlzdHMhIERFTEVURScpO1xuICAgICAgICAgICAgICAgIHZhciBpbmRleCA9IHNlbGVjdGVkSW50ZXJlc3QuaW5kZXhPZihxSWQpO1xuICAgICAgICAgICAgICAgIGlmIChpbmRleCA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkSW50ZXJlc3Quc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICBzZWxlY3RlZEludGVyZXN0LnB1c2gocUlkKTtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhzZWxlY3RlZEludGVyZXN0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICAkc2NvcGUucmVnaXN0ZXIgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiUkVHSVNURVJcIik7XG5cblxuICAgICAgICAgICAgJGh0dHAucG9zdCgnL3JlZ2lzdGVyJywge1xuICAgICAgICAgICAgICAgIGZpcnN0bmFtZTogdGhpcy5maXJzdG5hbWUsXG4gICAgICAgICAgICAgICAgbGFzdG5hbWUgOiB0aGlzLmxhc3RuYW1lLFxuICAgICAgICAgICAgICAgIC8vZW1haWwgOiB0aGlzLmVtYWlsLCovXG4gICAgICAgICAgICAgICAgdXNlcm5hbWUgOiB0aGlzLnVzZXJuYW1lLFxuICAgICAgICAgICAgICAgIHBhc3N3b3JkIDogdGhpcy5wYXNzd29yZCxcbiAgICAgICAgICAgICAgICB6aXBjb2RlOiB0aGlzLnppcGNvZGUsXG4gICAgICAgICAgICAgICAgYmlydGhkYXRlIDogdGhpcy5iaXJ0aGRhdGUsXG4gICAgICAgICAgICAgICAgc2V4IDogdGhpcy5zZXgsXG4gICAgICAgICAgICAgICAgYmlvZ3JhcGh5IDogdGhpcy5iaW9ncmFwaHksXG4gICAgICAgICAgICAgICAgaW50ZXJlc3RzOnNlbGVjdGVkSW50ZXJlc3RcblxuICAgICAgICAgICAgfSkuc3VjY2VzcyhmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICAgICAgICAgICRzY29wZS5lcnJvciA9IGRhdGEuZXJyb3I7XG4gICAgICAgICAgICAgICAgJGxvY2F0aW9uLnBhdGgoZGF0YS5yZWRpcmVjdCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9O1xuICAgIH07XG5cbiAgICB2YXIgc2lnbnVwQ29udHJvbGxlciA9IGZ1bmN0aW9uICgkc2NvcGUpIHtcbiAgICAgICAgJHNjb3BlLmNhdGVnb3JpZXMgPSBbJyddO1xuICAgICAgICAkc2NvcGUubmV3Q2F0ZWdvcnkgPSBcIlwiO1xuICAgICAgICAkc2NvcGUuc2F2ZUNhdGVnb3J5ID0gZnVuY3Rpb24gKCkge1xuXG4gICAgICAgIH07XG5cbiAgICB9O1xuXG4gICAgdmFyIGVkaXRhYmxlQ2hlY2tib3hDb250cm9sbGVyID0gZnVuY3Rpb24gKCRzY29wZSkge1xuICAgICAgICAkc2NvcGUuY2F0ZWdvcnkgPSBcIlwiO1xuICAgICAgICAkc2NvcGUuc2hvd0xhYmVsID0gZmFsc2U7XG4gICAgICAgICRzY29wZS5zaG93VGV4dGJveCA9IHRydWU7XG4gICAgICAgICRzY29wZS5zYXZlQ2F0ZWdvcnkgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZiAoJHNjb3BlLmNhdGVnb3J5KSB7XG4gICAgICAgICAgICAgICAgJHNjb3BlLnNob3dMYWJlbCA9IHRydWU7XG4gICAgICAgICAgICAgICAgJHNjb3BlLnNob3dUZXh0Ym94ID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAkc2NvcGUuc2hvd0xhYmVsID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgJHNjb3BlLnNob3dUZXh0Ym94ID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgJHNjb3BlLmVkaXQgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAkc2NvcGUuc2hvd0xhYmVsID0gZmFsc2U7XG4gICAgICAgICAgICAkc2NvcGUuc2hvd1RleHRib3ggPSB0cnVlO1xuICAgICAgICB9O1xuICAgICAgICAkc2NvcGUuaXNDaGVja2VkID0gZnVuY3Rpb24ocUlkKXtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKHFJZCk7XG4gICAgICAgICAgICBpZihxSWQhPT0gIFwiIFwiKSB7XG4gICAgICAgICAgICAgICAgaWYgKHNlbGVjdGVkSW50ZXJlc3QuaW5kZXhPZihxSWQpICE9PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgaW5kZXggPSBzZWxlY3RlZEludGVyZXN0LmluZGV4T2YocUlkKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4ID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkSW50ZXJlc3Quc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHNlbGVjdGVkSW50ZXJlc3QpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRJbnRlcmVzdC5wdXNoKHFJZCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHNlbGVjdGVkSW50ZXJlc3QpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgJHNjb3BlLnN0YXRlQ2hhbmdlZCA9IGZ1bmN0aW9uIChxSWQpIHtcblxuICAgICAgICB9O1xuXG4gICAgfTtcblxuICAgIGFuZ3VsYXIubW9kdWxlKFwiYXBwXCIpXG4gICAgICAgIC5jb250cm9sbGVyKFwibG9naW5Db250cm9sbGVyXCIsIFtcIiRzY29wZVwiLCBcIiRodHRwXCIsIFwiJGxvY2F0aW9uXCIsIGxvZ2luQ29udHJvbGxlcl0pXG4gICAgICAgIC5jb250cm9sbGVyKFwic2lnbnVwQ29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgc2lnbnVwQ29udHJvbGxlcl0pXG4gICAgICAgIC5jb250cm9sbGVyKFwiZWRpdGFibGVDaGVja2JveENvbnRyb2xsZXJcIiwgW1wiJHNjb3BlXCIsIGVkaXRhYmxlQ2hlY2tib3hDb250cm9sbGVyXSk7XG59KSgpOyIsIi8qKlxuICogQ3JlYXRlZCBieSBOaWtpdGEgb24gMjEvMTIvMjAxNS5cbiAqL1xuKGZ1bmN0aW9uICgpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcblxuICAgIC8qdmFyIHNpZ251cENvbnRyb2xsZXIgPSBmdW5jdGlvbiAoJHNjb3BlKSB7XG4gICAgICAgICRzY29wZS5jYXRlZ29yaWVzID0gWycnXTtcbiAgICAgICAgJHNjb3BlLm5ld0NhdGVnb3J5ID0gXCJcIjtcbiAgICAgICAgJHNjb3BlLnNhdmVDYXRlZ29yeSA9IGZ1bmN0aW9uICgpIHtcblxuICAgICAgICB9O1xuXG4gICAgfTtcblxuICAgIHZhciBlZGl0YWJsZUNoZWNrYm94Q29udHJvbGxlciA9IGZ1bmN0aW9uICgkc2NvcGUpIHtcbiAgICAgICAgJHNjb3BlLmNhdGVnb3J5ID0gXCJcIjtcbiAgICAgICAgJHNjb3BlLnNob3dMYWJlbCA9IGZhbHNlO1xuICAgICAgICAkc2NvcGUuc2hvd1RleHRib3ggPSB0cnVlO1xuICAgICAgICAkc2NvcGUuc2F2ZUNhdGVnb3J5ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgaWYgKCRzY29wZS5jYXRlZ29yeSkge1xuICAgICAgICAgICAgICAgICRzY29wZS5zaG93TGFiZWwgPSB0cnVlO1xuICAgICAgICAgICAgICAgICRzY29wZS5zaG93VGV4dGJveCA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgJHNjb3BlLnNob3dMYWJlbCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICRzY29wZS5zaG93VGV4dGJveCA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgICRzY29wZS5lZGl0ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgJHNjb3BlLnNob3dMYWJlbCA9IGZhbHNlO1xuICAgICAgICAgICAgJHNjb3BlLnNob3dUZXh0Ym94ID0gdHJ1ZTtcbiAgICAgICAgfTtcblxuICAgIH07XG4gICAgYW5ndWxhci5tb2R1bGUoXCJhcHBcIilcbiAgICAgICAgLmNvbnRyb2xsZXIoXCJzaWdudXBDb250cm9sbGVyXCIsIFtcIiRzY29wZVwiLCBzaWdudXBDb250cm9sbGVyXSlcbiAgICAgICAgLmNvbnRyb2xsZXIoXCJlZGl0YWJsZUNoZWNrYm94Q29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgZWRpdGFibGVDaGVja2JveENvbnRyb2xsZXJdKTsqL1xuXG5cbn0pKCk7IiwiLyoqXG4gKiBDcmVhdGVkIGJ5IE1hcnRoZSBvbiAxNi8xMi8xNS5cbiAqL1xuKGZ1bmN0aW9uICgpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcblxuICAgIHZhciB1c2VyQ29udHJvbGxlciA9IGZ1bmN0aW9uICgkc2NvcGUsICRyb290U2NvcGUsICRodHRwLCAkbG9jYXRpb24pIHtcbiAgICAgICAgJGh0dHAuZ2V0KCcvdXNlcicpLnN1Y2Nlc3MoZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAgICAgJHNjb3BlLnVzZXIgPSBkYXRhO1xuICAgICAgICAgICAgJHJvb3RTY29wZS51c2VyID0gZGF0YTtcblxuICAgICAgICAgICAgaWYoZGF0YS51c2VybmFtZSA9PSAnYWRtaW4nKXtcbiAgICAgICAgICAgICAgICAkc2NvcGUuYXV0aCA9IHtpc0F1dGg6IHRydWUsIGlzQWRtaW4gOiB0cnVlfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYoZGF0YS51c2VybmFtZSAhPSAnYWRtaW4nICYmIGRhdGEudXNlcm5hbWUgIT09IHVuZGVmaW5lZCl7XG4gICAgICAgICAgICAgICAgJHNjb3BlLmF1dGggPSB7aXNBdXRoOiB0cnVlLCBpc0FkbWluIDogZmFsc2V9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZihkYXRhLnVzZXJuYW1lID09PSB1bmRlZmluZWQpe1xuICAgICAgICAgICAgICAgICRzY29wZS5hdXRoID0ge2lzQXV0aDogZmFsc2UsIGlzQWRtaW4gOiBmYWxzZX07XG5cbiAgICAgICAgICAgIH1cblxuXG4gICAgICAgIH0pO1xuXG5cbiAgICAgICAgLyokc2NvcGUubG9nb3V0ID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAkaHR0cC5nZXQoJy9sb2dvdXQnKS5zdWNjZXNzKGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgICAgICAgICAgJGxvY2F0aW9uLnBhdGgoZGF0YS5yZWRpcmVjdCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTsqL1xuICAgIH07XG5cblxuICAgIGFuZ3VsYXIubW9kdWxlKFwiYXBwXCIpLmNvbnRyb2xsZXIoXCJ1c2VyQ29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgXCIkcm9vdFNjb3BlXCIsIFwiJGh0dHBcIiwgXCIkbG9jYXRpb25cIiwgdXNlckNvbnRyb2xsZXJdKTtcbn0pKCk7Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
